<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    <link href="https://cdn.staticfile.org/remixicon/3.5.0/remixicon.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; background-image: linear-gradient(to bottom right, #fff1f2, #f8fafc, #f0f9ff); background-attachment: fixed; font-family: sans-serif; -webkit-tap-highlight-color: transparent; color: #334155; user-select: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        [v-cloak] { display: none !important; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(30px); }
        .app-card { background: #fff; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: all 0.3s ease; border: 1px solid #f1f5f9; overflow: hidden; margin-bottom: 20px; break-inside: avoid; }
        @media (min-width: 768px) { .app-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px -5px rgba(244, 114, 182, 0.15); } }
        .tag { font-size: 12px; font-weight: 600; padding: 6px 14px; border-radius: 100px; transition: all 0.2s; white-space: nowrap; }
        .tag-active { background: #1e293b; color: #fff; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tag-inactive { background: #fff; color: #64748b; border: 1px solid #e2e8f0; }
        .img-grid { display: grid; gap: 4px; border-radius: 12px; overflow: hidden; margin-top: 12px; }
        .img-grid-1 { grid-template-columns: 1fr; }
        .img-grid-2 { grid-template-columns: 1fr 1fr; }
        .img-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .img-item { aspect-ratio: 1/1; width: 100%; object-fit: cover; cursor: zoom-in; transition: filter 0.2s; }
        .img-grid-1 .img-item { aspect-ratio: 16/9; max-height: 260px; }
        .pb-safe { padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
        .fab-safe { bottom: calc(32px + env(safe-area-inset-bottom)); }
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .chat-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 16px; }
        .chat-row.mine { flex-direction: row-reverse; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; background: #f1f5f9; object-fit: cover; border: 1px solid white; flex-shrink: 0; }
        .chat-bubble-container { max-width: 75%; display: flex; flex-direction: column; }
        .chat-row.mine .chat-bubble-container { align-items: flex-end; }
        .chat-bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.5; word-break: break-all; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-row.mine .chat-bubble { background: #1e293b; color: white; border-bottom-right-radius: 4px; }
        .chat-row.other .chat-bubble { background: #fff; color: #334155; border-top-left-radius: 4px; border: 1px solid #e2e8f0; }
        .chat-time { font-size: 9px; color: #94a3b8; margin-top: 4px; margin-left: 2px; margin-right: 2px; }
        .chat-pending { opacity: 0.7; }
    </style>
</head>
<body>

<div id="static-loading" style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafc;z-index:9999;transition:opacity 0.5s;">
    <div style="font-size:40px;animation:bounce 1s infinite;">ğŸ¡</div>
    <p style="color:#94a3b8;font-size:12px;margin-top:10px;font-weight:bold;">èµ„æºåŠ è½½ä¸­...</p>
    <style>@keyframes bounce {0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);}}</style>
</div>

<div id="app" v-cloak class="min-h-screen">
    
    <header class="fixed top-0 inset-x-0 z-40 bg-white/80 backdrop-blur-xl border-b border-slate-100 h-16 flex items-center justify-between px-4 transition-shadow" :class="{'shadow-sm': scrollY > 10}">
        <div class="flex items-center gap-2 cursor-pointer" @click="refresh">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center text-white shadow-lg shadow-pink-200">
                <i class="ri-heart-fill"></i>
            </div>
            <h1 class="text-lg font-extrabold text-slate-800 tracking-tight">CPDD<span class="text-rose-500">.</span></h1>
        </div>
        <div v-if="user" class="flex items-center gap-4">
            <div class="relative cursor-pointer group" @click="openInbox">
                <i class="ri-mail-line text-2xl text-slate-500 group-hover:text-slate-800 transition-colors"></i>
                <div v-if="totalUnread > 0" class="absolute -top-1 -right-1 min-w-[16px] h-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center border border-white font-bold shadow-sm px-1">
                    {{ totalUnread > 99 ? '99+' : totalUnread }}
                </div>
            </div>
            <div class="flex items-center gap-2 cursor-pointer" @click="handleAvatarClick(user.username)">
                <img :src="user.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`" class="w-9 h-9 rounded-full border bg-white object-cover">
            </div>
        </div>
        <button v-else @click="showAuthModal = true" class="bg-slate-900 text-white text-xs font-bold px-5 py-2 rounded-full shadow-lg">ç™»å½•/æ³¨å†Œ</button>
    </header>
    <div class="h-16"></div>

    <div class="sticky top-16 z-30 bg-white/90 backdrop-blur-md border-b border-slate-50 py-3 px-4 overflow-x-auto hide-scrollbar">
        <div class="flex gap-2 min-w-max">
            <button v-for="g in games" :key="g" @click="changeFilter(g)" class="tag" :class="filterGame === g ? 'tag-active' : 'tag-inactive'">{{ g }}</button>
        </div>
    </div>

    <div v-if="notice" class="max-w-5xl mx-auto px-4 mt-4">
        <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 flex gap-2 text-xs text-orange-700">
            <i class="ri-notification-4-fill"></i> {{ notice }}
        </div>
    </div>

    <!-- åˆ—è¡¨ -->
    <main class="max-w-5xl mx-auto px-4 pt-6 pb-safe">
        <div v-if="error" class="text-center py-20">
             <div class="text-4xl mb-2">âš ï¸</div>
             <p class="text-sm text-slate-500 mb-4">{{ error }}</p>
             <button @click="refresh" class="bg-rose-500 text-white px-6 py-2 rounded-full text-sm font-bold">é‡è¯•</button>
        </div>

        <div v-else-if="loading" class="text-center py-32 text-rose-300">
            <i class="ri-loader-4-line text-3xl animate-spin"></i>
            <p class="text-xs font-bold mt-2">åŠ è½½ä¸­...</p>
        </div>

        <div v-else-if="!posts.length" class="text-center py-32 text-slate-400">
            <div class="text-5xl mb-2 grayscale opacity-50">ğŸ”ï¸</div>
            <p class="text-sm font-bold">æš‚æ— å†…å®¹</p>
            <button @click="checkAuthAndPost" class="mt-4 text-rose-500 text-xs font-bold hover:underline">å»å‘å¸ƒ</button>
        </div>

        <div v-else class="flex gap-4 items-start">
            <div v-for="(col, i) in columns" :key="i" class="flex-1 flex flex-col gap-4 min-w-0">
                <div v-for="post in col" :key="post.id" class="app-card p-4 group relative">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2 cursor-pointer" @click.stop="handleAvatarClick(post.username)">
                            <img :src="post.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.username}`" class="w-9 h-9 rounded-full bg-slate-100 object-cover">
                            <div>
                                <div class="flex items-center gap-1 flex-wrap">
                                    <span class="text-sm font-bold text-slate-800">{{ post.nickname }}</span>
                                    <i v-if="post.gender==='male'" class="ri-men-line text-blue-400 text-xs"></i>
                                    <i v-if="post.gender==='female'" class="ri-women-line text-pink-400 text-xs"></i>
                                    <span class="text-[10px] px-1.5 py-0.5 bg-slate-100 rounded text-slate-500">{{ post.game }}</span>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <span class="text-[10px] text-slate-400">{{ post.timeStr }}</span>
                                    <span v-if="post.target==='male'" class="text-[9px] bg-blue-50 text-blue-500 px-1 rounded">æ‰¾å°å“¥å“¥</span>
                                    <span v-if="post.target==='female'" class="text-[9px] bg-pink-50 text-pink-500 px-1 rounded">æ‰¾å°å§å§</span>
                                </div>
                            </div>
                        </div>
                        <button v-if="user && (user.isAdmin || user.username === post.username)" @click="deletePost(post.id)" class="text-slate-300 hover:text-red-500 p-2"><i class="ri-delete-bin-line"></i></button>
                    </div>
                    <div class="text-sm text-slate-700 mb-3 whitespace-pre-wrap break-words">{{ post.desc }}</div>
                    <div v-if="post.qq || post.wx" class="flex gap-2 mb-3">
                        <button v-if="post.qq" @click="copyText(post.qq, 'QQ')" class="flex items-center gap-1 text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded hover:bg-blue-100 transition-colors"><i class="ri-qq-fill"></i> {{ post.qq }}</button>
                        <button v-if="post.wx" @click="copyText(post.wx, 'å¾®ä¿¡')" class="flex items-center gap-1 text-[10px] bg-green-50 text-green-500 px-2 py-1 rounded hover:bg-green-100 transition-colors"><i class="ri-wechat-fill"></i> {{ post.wx }}</button>
                    </div>
                    <div v-if="post.requirement" class="bg-rose-50 rounded-lg p-2 mb-3 text-xs text-slate-600 border border-rose-100">
                        <span class="font-bold text-rose-500">éœ€æ±‚ï¼š</span>{{ post.requirement }}
                    </div>
                    <div v-if="post.images && post.images.length" class="img-grid" :class="'img-grid-' + Math.min(post.images.length, 3)">
                        <img v-for="(img, idx) in post.images" :key="idx" :src="img" class="img-item" @click="previewImage(post.images, idx)">
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-50">
                        <button @click="toggleComments(post)" class="flex items-center gap-1 text-slate-400 hover:text-slate-600 text-xs font-bold px-2 py-1">
                            <i class="ri-chat-1-line text-base"></i> {{ post.commentsCount || 0 }}
                        </button>
                        <button @click="handleLike(post)" :disabled="post.liking" class="flex items-center gap-1 text-xs font-bold transition-colors px-2 py-1" :class="isLiked(post) ? 'text-rose-500' : 'text-slate-400'">
                            <i :class="isLiked(post) ? 'ri-heart-3-fill' : 'ri-heart-3-line'" class="text-base"></i> {{ post.likes || 0 }}
                        </button>
                    </div>
                    <div v-if="post.showComments" class="mt-3 pt-3 border-t border-dashed border-slate-100 animate-fade-in">
                        <div v-if="post.loadingComments" class="space-y-3 py-2"><div class="flex gap-2 items-center"><div class="skeleton w-6 h-6 rounded-full shrink-0"></div><div class="skeleton h-4 w-24"></div></div></div>
                        <div v-else>
                            <div v-if="!post.commentList?.length" class="text-center text-xs text-slate-300 py-4">æ²™å‘ç©ºç¼ºä¸­ï¼Œå¿«æ¥æŠ¢~</div>
                            <div class="space-y-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                                <div v-for="cmt in post.commentList" :key="cmt.id" class="flex gap-2 text-xs group/cmt p-1" @touchstart="startLongPress(post, cmt)" @touchend="endLongPress" @touchmove="endLongPress">
                                    <img @click.stop="handleAvatarClick(cmt.username)" :src="cmt.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${cmt.username}`" class="w-7 h-7 rounded-full bg-slate-100 shrink-0 border border-white cursor-pointer">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between items-baseline">
                                            <span class="font-bold text-slate-700">{{ cmt.nickname }}</span>
                                            <div class="flex items-center gap-3">
                                                <button v-if="user && user.username !== cmt.username" @click="triggerReply(post, cmt)" class="hidden md:block text-rose-400 hover:text-rose-600 font-bold opacity-0 group-hover/cmt:opacity-100 transition-opacity">â†©ï¸ å›å¤</button>
                                                <button v-if="user && (user.isAdmin || user.username === cmt.username)" @click="deleteComment(post, cmt.id)" class="text-slate-300 hover:text-red-500 font-bold">åˆ é™¤</button>
                                            </div>
                                        </div>
                                        <p class="text-slate-600 mt-0.5 leading-relaxed break-all">{{ cmt.content }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 items-center mt-2">
                                <input v-model="post.newCommentInput" :ref="'input-'+post.id" placeholder="å‹å–„è¯„è®º..." class="flex-1 bg-slate-50 border border-slate-100 rounded-full px-4 py-2 text-xs focus:bg-white focus:ring-2 focus:ring-rose-100 outline-none transition-all">
                                <button @click="submitComment(post)" class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center hover:bg-black shadow-md active:scale-95 transition-all"><i class="ri-send-plane-fill text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed right-5 z-40 flex flex-col gap-3 fab-safe">
        <button v-show="scrollY > 300" @click="scrollToTop" class="w-10 h-10 bg-white rounded-full shadow-lg text-slate-400 flex items-center justify-center border border-slate-50"><i class="ri-arrow-up-line"></i></button>
        <button @click="checkAuthAndPost" class="w-12 h-12 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 transition-transform"><i class="ri-add-line text-xl"></i></button>
    </div>

    <!-- æ¶ˆæ¯ä¸­å¿ƒ -->
    <div v-if="showInboxModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-xs rounded-3xl shadow-2xl flex flex-col h-[60vh]">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-extrabold text-lg">æ¶ˆæ¯ä¸­å¿ƒ</h3>
                <button @click="showInboxModal=false" class="text-slate-400"><i class="ri-close-line text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2">
                <div v-if="!inboxList.length" class="text-center text-slate-300 text-xs py-10">æš‚æ— ç§ä¿¡</div>
                <div v-for="chat in inboxList" :key="chat.chatId" class="flex gap-3 items-center p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors relative group" @click="openChat({username: chat.otherUsername, nickname: chat.otherNickname, avatar: chat.otherAvatar}, chat.chatId)">
                    <img :src="chat.otherAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${chat.otherUsername}`" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-slate-200">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-sm text-slate-700">{{ chat.otherNickname }}</span>
                            <button @click.stop="deleteChatSession(chat.chatId)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ri-delete-bin-line"></i></button>
                        </div>
                        <p class="text-xs text-slate-500 truncate mt-0.5">{{ chat.lastMsg }}</p>
                    </div>
                    <div v-if="chat.unread > 0" class="absolute top-3 right-3 w-2 h-2 bg-red-500 rounded-full"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- èŠå¤©çª—å£ (æ™ºèƒ½æ»šåŠ¨ç‰ˆ) -->
    <div v-if="showChatModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl flex flex-col h-[70vh] relative">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-3xl z-10">
                <div class="flex items-center gap-2">
                    <button @click="showChatModal=false" class="text-slate-400 hover:text-slate-600"><i class="ri-arrow-left-line text-xl"></i></button>
                    <div class="flex items-center gap-2">
                        <img :src="chatTarget.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${chatTarget.username}`" class="w-6 h-6 rounded-full bg-white border">
                        <span class="font-bold text-sm">{{ chatTarget.nickname }}</span>
                    </div>
                </div>
            </div>
            
            <!-- èŠå¤©å†…å®¹åŒº -->
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50" ref="chatContainer" @scroll="handleChatScroll">
                <div v-if="chatMessages.length === 0" class="text-center text-slate-300 text-xs py-10">
                    æ‰“ä¸ªæ‹›å‘¼å§ ğŸ‘‹
                </div>
                <div v-for="msg in chatMessages" :key="msg.id" class="chat-row" :class="[msg.sender === user.username ? 'mine' : 'other', msg.pending ? 'chat-pending' : '']">
                    <img :src="(msg.sender === user.username ? user.avatar : chatTarget.avatar) || `https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.sender}`" class="chat-avatar">
                    <div class="chat-bubble-container">
                        <div class="chat-bubble">
                            {{ msg.content }}
                            <div v-if="msg.pending" class="absolute -left-4 top-2 text-slate-400 text-xs"><i class="ri-loader-4-line animate-spin"></i></div>
                        </div>
                        <span v-if="msg.timeStr && !msg.pending" class="chat-time">{{ msg.timeStr }}</span>
                    </div>
                </div>
            </div>

            <!-- æ–°æ¶ˆæ¯æç¤ºæ°”æ³¡ (ç‚¹å‡»æ»šåŠ¨åˆ°åº•éƒ¨) -->
            <transition name="fade">
                <div v-if="showNewMsgToast" @click="scrollToBottom" class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg cursor-pointer flex items-center gap-1 animate-bounce z-20">
                    <i class="ri-arrow-down-line"></i> æœ‰æ–°æ¶ˆæ¯
                </div>
            </transition>

            <div class="p-3 border-t bg-white rounded-b-3xl flex gap-2 z-10">
                <input v-model="chatInput" @keyup.enter="sendChat" ref="chatInputRef" placeholder="å‘æ¶ˆæ¯..." class="flex-1 bg-slate-100 rounded-full px-4 py-2 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-slate-200 transition-all">
                <button @click="sendChat" :disabled="!chatInput" class="w-9 h-9 rounded-full bg-slate-900 text-white flex items-center justify-center disabled:opacity-50 transition-transform active:scale-90"><i class="ri-send-plane-fill"></i></button>
            </div>
        </div>
    </div>

    <!-- Auth/Profile/Post Modals (çœç•¥ä»¥ä¿æŒä»£ç ç²¾ç®€) -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl"><h3 class="text-center font-bold text-lg mb-4">{{ authMode==='login'?'ç™»å½•':'æ³¨å†Œ' }}</h3><div class="space-y-3"><div v-if="authMode==='register'" class="flex justify-center" @click="$refs.avatarInput.click()"><div class="w-16 h-16 rounded-full bg-slate-50 border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-300 overflow-hidden relative"><img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover"><i v-else class="ri-camera-fill text-xl"></i><span v-if="authForm.avatar" class="absolute bottom-0 text-[8px] bg-black/50 text-white w-full text-center">å·²å‹ç¼©</span></div><input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload"></div><input v-model="authForm.username" :placeholder="authMode==='register' && authForm.username!=='admin' ? 'è´¦å· (â‰¥8ä½)' : 'è´¦å·'" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-xs"><input v-model="authForm.password" type="password" placeholder="å¯†ç  (â‰¥6ä½)" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-xs"><input v-if="authMode==='register'" v-model="authForm.nickname" placeholder="æ˜µç§°" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-xs"><button @click="handleAuth" :disabled="isAuthing" class="w-full bg-slate-900 text-white py-2 rounded-lg text-xs font-bold">{{ isAuthing?'å¤„ç†ä¸­...':'ç¡®å®š' }}</button></div><div class="flex justify-between mt-4 text-xs text-slate-400"><button @click="authMode = authMode==='login'?'register':'login'">åˆ‡æ¢{{ authMode==='login'?'æ³¨å†Œ':'ç™»å½•' }}</button><button @click="showAuthModal=false">å…³é—­</button></div></div></div>
    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col"><div class="flex justify-between items-center p-4 border-b"><button @click="showPostModal=false" class="text-slate-500">å–æ¶ˆ</button><h3 class="font-bold">å‘å¸ƒåŠ¨æ€</h3><button @click="submitPost" :disabled="submitting" class="bg-rose-500 text-white px-4 py-1 rounded-full text-xs font-bold">{{ submitting?'...':'å‘å¸ƒ' }}</button></div><div class="p-4 flex-1 overflow-y-auto"><textarea v-model="postForm.content" class="w-full h-32 text-sm outline-none placeholder-slate-300 resize-none" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea><div class="flex flex-wrap gap-2 mb-4"><div v-for="(img,i) in postForm.images" :key="i" class="w-20 h-20 rounded bg-slate-100 relative overflow-hidden"><img :src="img" class="w-full h-full object-cover"><button @click="removeImage(i)" class="absolute top-0 right-0 bg-black/50 text-white w-5 h-5 flex items-center justify-center text-xs">&times;</button></div><div v-if="postForm.images.length<3" @click="$refs.pInput.click()" class="w-20 h-20 rounded border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-300"><i class="ri-add-line text-xl"></i></div><input type="file" ref="pInput" hidden accept="image/*" @change="handlePostImageUpload"></div><div class="space-y-4"><div><label class="text-xs font-bold text-slate-400 block mb-2">åˆ†åŒº</label><div class="flex flex-wrap gap-2"><button v-for="g in games.slice(1)" :key="g" @click="postForm.game=g" class="px-3 py-1 rounded border text-xs" :class="postForm.game===g?'bg-slate-800 text-white':'bg-white text-slate-500'">{{ g }}</button></div></div><div><label class="text-xs font-bold text-slate-400 block mb-2">è¦æ±‚</label><input v-model="postForm.requirement" class="w-full bg-slate-50 rounded px-3 py-2 text-xs outline-none" placeholder="é€‰å¡«..."></div></div></div></div>
    <div v-if="preview.show" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center" @click="preview.show=false"><img :src="preview.list[preview.idx]" class="max-w-full max-h-screen object-contain"></div>
    <div v-if="showProfileModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-sm animate-fade-in"><div class="bg-white w-full max-w-xs rounded-3xl shadow-2xl p-6 overflow-y-auto max-h-[90vh]"><div class="flex justify-between items-center mb-4"><h3 class="font-extrabold text-lg text-slate-800">{{ isMyProfile ? 'æˆ‘çš„èµ„æ–™' : 'ç”¨æˆ·èµ„æ–™' }}</h3><button @click="showProfileModal=false" class="text-slate-400 hover:text-slate-600"><i class="ri-close-line text-xl"></i></button></div><div class="space-y-4 text-center"><div class="flex justify-center"><div class="relative w-24 h-24 group" :class="{'cursor-pointer': isMyProfile}" @click="isMyProfile && $refs.profileAvatarInput.click()"><img :src="viewingUser.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${viewingUser.username}`" class="w-full h-full rounded-full object-cover border-4 border-white shadow-lg"><div v-if="isMyProfile" class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity"><i class="ri-camera-fill text-2xl"></i></div><input v-if="isMyProfile" type="file" ref="profileAvatarInput" hidden accept="image/*" @change="handleProfileAvatarChange"></div></div><div><h2 class="font-bold text-xl text-slate-800">{{ viewingUser.nickname }}</h2><p class="text-xs text-slate-400 font-mono mt-1">@{{ viewingUser.username }}</p></div><div v-if="!isMyProfile" class="space-y-3 text-left bg-slate-50 p-4 rounded-2xl"><div class="flex justify-between text-sm"><span class="text-slate-400">æ€§åˆ«</span> <span class="font-bold">{{ genderMap[viewingUser.gender] || 'ä¿å¯†' }}</span></div><div class="flex justify-between text-sm"><span class="text-slate-400">æƒ³æ‰¾</span> <span class="font-bold">{{ targetMap[viewingUser.target] || 'ä¸é™' }}</span></div><div v-if="viewingUser.qq" class="flex justify-between text-sm items-center"><span class="text-slate-400">QQ</span> <button @click="copyText(viewingUser.qq, 'QQ')" class="text-blue-500 font-bold text-xs bg-blue-50 px-2 py-0.5 rounded">å¤åˆ¶</button></div><div v-if="viewingUser.wx" class="flex justify-between text-sm items-center"><span class="text-slate-400">å¾®ä¿¡</span> <button @click="copyText(viewingUser.wx, 'å¾®ä¿¡')" class="text-green-500 font-bold text-xs bg-green-50 px-2 py-0.5 rounded">å¤åˆ¶</button></div><button @click="openChat(viewingUser)" class="w-full bg-slate-800 text-white py-2.5 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2"><i class="ri-message-3-line"></i> å‘ç§ä¿¡</button></div><div v-else class="space-y-4 text-left"><div><label class="text-xs font-bold text-slate-400 block mb-2">æˆ‘çš„æ€§åˆ«</label><div class="flex gap-2"><button @click="profileForm.gender='male'" class="flex-1 py-2 rounded-lg text-xs font-bold border transition-all" :class="profileForm.gender==='male'?'bg-blue-50 border-blue-200 text-blue-500':'bg-white border-slate-200 text-slate-400'">ç”·ç”Ÿ</button><button @click="profileForm.gender='female'" class="flex-1 py-2 rounded-lg text-xs font-bold border transition-all" :class="profileForm.gender==='female'?'bg-pink-50 border-pink-200 text-pink-500':'bg-white border-slate-200 text-slate-400'">å¥³ç”Ÿ</button></div></div><div><label class="text-xs font-bold text-slate-400 block mb-2">æƒ³æ‰¾</label><div class="flex gap-2"><button @click="profileForm.target='male'" class="flex-1 py-2 rounded-lg text-[10px] font-bold border transition-all" :class="profileForm.target==='male'?'bg-blue-50 border-blue-200 text-blue-500':'bg-white border-slate-200 text-slate-400'">æ‰¾ç”·ç”Ÿ</button><button @click="profileForm.target='female'" class="flex-1 py-2 rounded-lg text-[10px] font-bold border transition-all" :class="profileForm.target==='female'?'bg-pink-50 border-pink-200 text-pink-500':'bg-white border-slate-200 text-slate-400'">æ‰¾å¥³ç”Ÿ</button><button @click="profileForm.target='all'" class="flex-1 py-2 rounded-lg text-[10px] font-bold border transition-all" :class="profileForm.target==='all'?'bg-purple-50 border-purple-200 text-purple-500':'bg-white border-slate-200 text-slate-400'">éƒ½å¯ä»¥</button></div></div><div class="space-y-2"><div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100"><i class="ri-qq-fill text-blue-400"></i><input v-model="profileForm.qq" placeholder="QQå· (é€‰å¡«)" class="bg-transparent text-xs w-full outline-none"></div><div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100"><i class="ri-wechat-fill text-green-400"></i><input v-model="profileForm.wx" placeholder="å¾®ä¿¡å· (é€‰å¡«)" class="bg-transparent text-xs w-full outline-none"></div></div><button @click="handleProfileUpdate" :disabled="isUpdatingProfile" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all disabled:opacity-50">{{ isUpdatingProfile ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜èµ„æ–™' }}</button><button @click="logout" class="w-full text-xs text-red-400 hover:text-red-600 py-2">é€€å‡ºç™»å½•</button></div></div></div></div>

</div>

<script>
    const { createApp, ref, onMounted, watch, nextTick, computed } = Vue;

    const app = createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const posts = ref([]);
            const loading = ref(true);
            const error = ref('');
            const scrollY = ref(0);
            const notice = "æ¬¢è¿æ¥åˆ° CPDD æ‰©åˆ—å°ç«™ï¼ä¸¥ç¦å‘å¸ƒè¿è§„ä¿¡æ¯ã€‚";

            const showAuthModal = ref(false);
            const authMode = ref('login');
            const showPostModal = ref(false);
            const showProfileModal = ref(false);
            const showInboxModal = ref(false);
            const showChatModal = ref(false);
            
            const submitting = ref(false);
            const isAuthing = ref(false);
            const isUpdatingProfile = ref(false);
            const preview = ref({show:false, list:[], idx:0});
            const viewingUser = ref({});
            const isMyProfile = ref(false);
            const inboxList = ref([]);
            const pendingMessages = ref([]);
            const serverMessages = ref([]);
            const chatTarget = ref({});
            const chatInput = ref('');
            const totalUnread = ref(0);
            
            // æ»šåŠ¨æ™ºèƒ½åˆ¤æ–­çŠ¶æ€
            const isUserAtBottom = ref(true);
            const showNewMsgToast = ref(false);

            let chatPoller = null;
            let inboxPoller = null;

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');
            const authForm = ref({username:'', password:'', nickname:'', avatar:''});
            const postForm = ref({content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]});
            const profileForm = ref({ nickname:'', avatar:'', gender:'', target:'all', qq:'', wx:'' });
            const columns = ref([[], [], []]);
            const windowWidth = ref(window.innerWidth);
            const genderMap = { male:'ç”·ç”Ÿ', female:'å¥³ç”Ÿ', secret:'ä¿å¯†' };
            const targetMap = { male:'æ‰¾ç”·ç”Ÿ', female:'æ‰¾å¥³ç”Ÿ', all:'ä¸é™' };

            // --- æ ¸å¿ƒï¼šæ»šåŠ¨ä¸æ¶ˆæ¯å¤„ç† ---
            
            const scrollToBottom = () => {
                const el = app._instance.refs.chatContainer;
                if(el) {
                    el.scrollTop = el.scrollHeight;
                    isUserAtBottom.value = true;
                    showNewMsgToast.value = false;
                }
            };

            const handleChatScroll = (e) => {
                const el = e.target;
                // å…è®¸ 50px çš„è¯¯å·®
                const isBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 50;
                isUserAtBottom.value = isBottom;
                if (isBottom) showNewMsgToast.value = false;
            };

            const openChat = async (target, chatId) => {
                showProfileModal.value = false;
                showInboxModal.value = false;
                chatTarget.value = target;
                serverMessages.value = [];
                pendingMessages.value = [];
                showNewMsgToast.value = false;
                isUserAtBottom.value = true; // åˆå§‹è®¾ä¸ºåœ¨åº•éƒ¨ï¼Œä»¥ä¾¿é¦–æ¬¡åŠ è½½è‡ªåŠ¨æ»šåŠ¨
                showChatModal.value = true;
                
                if(chatId) {
                    const chat = inboxList.value.find(c => c.chatId === chatId);
                    if(chat && chat.unread > 0) { 
                        totalUnread.value = Math.max(0, totalUnread.value - chat.unread); 
                        chat.unread = 0; 
                    }
                    await fetch(`${API}?action=chat_read`, {method:'POST', body:JSON.stringify({user:user.value, chatId})});
                }

                // é¦–æ¬¡åŠ è½½ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
                await fetchChatHistory(true);
                
                if (chatPoller) clearInterval(chatPoller);
                chatPoller = setInterval(() => fetchChatHistory(false), 3000);
                
                // èšç„¦è¾“å…¥æ¡†
                nextTick(() => {
                    const inputEl = app._instance.refs.chatInputRef;
                    if(inputEl) inputEl.focus();
                });
            };

            const currentChatId = computed(() => {
                if (!user.value || !chatTarget.value.username) return null;
                return [user.value.username, chatTarget.value.username].sort().join('_');
            });

            const fetchChatHistory = async (isInitial = false) => {
                if (!showChatModal.value) return;
                const reqChatId = currentChatId.value; 
                const res = await fetch(`${API}?action=chat_history&u1=${user.value.username}&u2=${chatTarget.value.username}`);
                if (reqChatId !== currentChatId.value) return;

                const msgs = await res.json();
                
                // æ£€æµ‹æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
                const oldLastId = serverMessages.value.length ? serverMessages.value[serverMessages.value.length-1].id : 0;
                const newLastId = msgs.length ? msgs[msgs.length-1].id : 0;
                
                serverMessages.value = msgs;
                // è¿‡æ»¤æ‰å·²ä¸ŠæœåŠ¡å™¨çš„æœ¬åœ°æ¶ˆæ¯
                pendingMessages.value = pendingMessages.value.filter(p => 
                    !msgs.some(s => s.content === p.content && s.sender === p.sender && Math.abs(p.timestamp - (s.timestamp?s.timestamp._seconds*1000:0)) < 10000)
                );

                // æ»šåŠ¨é€»è¾‘
                if (isInitial) {
                    nextTick(scrollToBottom);
                } else if (newLastId !== oldLastId && newLastId !== 0) {
                    // æœ‰æ–°æ¶ˆæ¯
                    if (isUserAtBottom.value) {
                        nextTick(scrollToBottom);
                    } else {
                        showNewMsgToast.value = true;
                    }
                }
            };

            const mergedMessages = computed(() => {
                const list = [...serverMessages.value, ...pendingMessages.value].sort((a,b) => {
                    const ta = a.timestamp?._seconds ? a.timestamp._seconds * 1000 : a.timestamp;
                    const tb = b.timestamp?._seconds ? b.timestamp._seconds * 1000 : b.timestamp;
                    return ta - tb;
                });
                return list;
            });

            const sendChat = async () => {
                if (!chatInput.value.trim()) return;
                const txt = chatInput.value;
                chatInput.value = '';
                const now = Date.now();
                const tempMsg = { id: now, sender: user.value.username, content: txt, timestamp: now, pending: true };
                pendingMessages.value.push(tempMsg);
                
                // å‘é€æ¶ˆæ¯æ—¶å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
                nextTick(scrollToBottom);

                try {
                    await fetch(`${API}?action=chat_send`, {
                        method: 'POST', 
                        body: JSON.stringify({ user: user.value, toUsername: chatTarget.value.username, content: txt })
                    });
                    fetchChatHistory(false); // ç«‹å³æ‹‰å–ä¸€æ¬¡
                } catch(e) {
                    alert('å‘é€å¤±è´¥');
                    pendingMessages.value = pendingMessages.value.filter(m => m.id !== now);
                }
            };

            // --- å…¶ä»–é€»è¾‘ä¿æŒä¸å˜ ---
            const checkUnread = async () => {
                if (!user.value) return;
                try {
                    const res = await fetch(`${API}?action=chat_inbox&username=${user.value.username}`);
                    const list = await res.json();
                    if(Array.isArray(list)) {
                        const count = list.reduce((sum, chat) => sum + (chat.unread || 0), 0);
                        totalUnread.value = count;
                        inboxList.value = list;
                    }
                } catch(e) {}
            };

            onMounted(() => {
                const staticLoading = document.getElementById('static-loading');
                if(staticLoading) { staticLoading.style.opacity = 0; setTimeout(()=>staticLoading.remove(), 500); }
                try { const u = localStorage.getItem('cp_user'); if(u) user.value = JSON.parse(u); } catch(e){}
                fetchPosts();
                if(user.value) { checkUnread(); inboxPoller = setInterval(checkUnread, 10000); }
            });

            watch(user, (u) => {
                if (u && !inboxPoller) inboxPoller = setInterval(checkUnread, 10000);
                else if (!u && inboxPoller) { clearInterval(inboxPoller); inboxPoller = null; }
            });

            watch(showChatModal, (val) => { if (!val && chatPoller) clearInterval(chatPoller); });

            const deleteChatSession = async (chatId) => {
                if(!confirm('åˆ é™¤ä¼šè¯?')) return;
                await fetch(`${API}?action=delete_chat_session`, {method:'POST', body:JSON.stringify({user:user.value, chatId})});
                inboxList.value = inboxList.value.filter(c => c.chatId !== chatId);
            };

            const handleAvatarClick = async (username) => {
                if (!user.value) return showAuthModal.value = true;
                if (username === user.value.username) { viewingUser.value = user.value; profileForm.value = { ...user.value, gender:user.value.gender||'', target:user.value.target||'all' }; isMyProfile.value = true; } 
                else { try { const res = await fetch(`${API}?action=get_user_profile&username=${username}`); if (res.ok) { viewingUser.value = await res.json(); isMyProfile.value = false; } } catch(e) { alert('è·å–èµ„æ–™å¤±è´¥'); return; } }
                showProfileModal.value = true;
            };
            let longPressTimer = null;
            const startLongPress = (post, cmt) => { longPressTimer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); triggerReply(post, cmt); }, 600); };
            const endLongPress = () => { clearTimeout(longPressTimer); };
            const triggerReply = (post, cmt) => { if(!user.value) return showAuthModal.value = true; post.newCommentInput = `å›å¤ @${cmt.nickname} : `; nextTick(() => { const el = app._instance.refs['input-'+post.id]; if(el) (Array.isArray(el)?el[0]:el).focus(); }); };
            const updateColumns = () => { if(!Array.isArray(posts.value)) { posts.value = []; return; } const cols = windowWidth.value < 640 ? 1 : (windowWidth.value < 1024 ? 2 : 3); const res = Array.from({length: cols}, () => []); const filtered = filterGame.value==='å…¨éƒ¨' ? posts.value : posts.value.filter(p => p.game === filterGame.value); filtered.forEach((p, i) => res[i % cols].push(p)); columns.value = res; };
            watch([filterGame, posts], updateColumns);
            window.onresize = () => { windowWidth.value = window.innerWidth; updateColumns(); };
            window.onscroll = () => scrollY.value = window.scrollY;
            const fetchPosts = async () => { loading.value = true; error.value = ''; try { const res = await fetch(API); if(!res.ok) throw new Error('ç½‘ç»œå¼€å°å·®äº†'); const data = await res.json(); if(Array.isArray(data)) posts.value = data; else throw new Error('æ•°æ®æ ¼å¼é”™è¯¯'); } catch(e) { error.value = e.message; posts.value = []; } loading.value = false; };
            const isLiked = (p) => { if(!p.likedIds) return false; if(user.value) return p.likedIds.includes('user:'+user.value.username); const locals = JSON.parse(localStorage.getItem('cp_likes')||'[]'); return locals.includes(p.id); };
            const handleLike = async (p) => { if(p.liking) return; p.liking = true; const liked = isLiked(p); if(liked) { p.likes--; if(user.value) p.likedIds = p.likedIds.filter(id => id !== 'user:'+user.value.username); else { const ls = JSON.parse(localStorage.getItem('cp_likes')||'[]'); localStorage.setItem('cp_likes', JSON.stringify(ls.filter(id=>id!==p.id))); p.likedIds = []; } } else { p.likes++; if(user.value) { if(!p.likedIds) p.likedIds=[]; p.likedIds.push('user:'+user.value.username); } else { const ls = JSON.parse(localStorage.getItem('cp_likes')||'[]'); ls.push(p.id); localStorage.setItem('cp_likes', JSON.stringify(ls)); if(!p.likedIds) p.likedIds=[]; p.likedIds.push('temp'); } } try { await fetch(`${API}?action=like`, {method:'POST', body:JSON.stringify({id:p.id, user:user.value})}); } catch(e){ p.likes = liked ? p.likes+1 : p.likes-1; } p.liking = false; };
            const compress = (file) => new Promise(resolve => { const r = new FileReader(); r.onload = e => { const img = new Image(); img.onload = () => { const cvs = document.createElement('canvas'); let w=img.width, h=img.height; const MAX = 1920; if(w>MAX){ h*=MAX/w; w=MAX; } cvs.width=w; cvs.height=h; const ctx = cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h); let q = 0.9, dataUrl = cvs.toDataURL('image/jpeg', q); const LIMIT = 330000; while(dataUrl.length > LIMIT && q > 0.3) { q-=0.1; dataUrl = cvs.toDataURL('image/jpeg', q); } if(dataUrl.length > LIMIT) { w*=0.7; h*=0.7; cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); dataUrl=cvs.toDataURL('image/jpeg', 0.6); } resolve(dataUrl); }; img.src = e.target.result; }; r.readAsDataURL(file); });
            const handleAvatarUpload = async (e) => { if(e.target.files[0]) authForm.value.avatar = await compress(e.target.files[0]); };
            const handleProfileAvatarChange = async (e) => { if(e.target.files[0]) profileForm.value.avatar = await compress(e.target.files[0]); };
            const handlePostImageUpload = async (e) => { if(e.target.files[0] && postForm.value.images.length<3) postForm.value.images.push(await compress(e.target.files[0])); e.target.value=''; };
            const handleAuth = async () => { if(!authForm.value.username) return alert('è¯·è¾“å…¥è´¦å·'); if (authMode.value === 'register' && authForm.value.username !== 'admin') { if(authForm.value.username.length < 8) return alert('è´¦å·è‡³å°‘8ä½'); } isAuthing.value = true; try { const res = await fetch(`${API}?action=${authMode.value}`, {method:'POST', body:JSON.stringify(authForm.value)}); const d = await res.json(); if(d.error) alert(d.error); else { user.value = d.user; localStorage.setItem('cp_user', JSON.stringify(d.user)); showAuthModal.value = false; } } catch(e){ alert('ç½‘ç»œé”™è¯¯'); } isAuthing.value = false; };
            const handleProfileUpdate = async () => { isUpdatingProfile.value = true; try { const payload = { username: user.value.username, user: user.value, ...profileForm.value }; const res = await fetch(`${API}?action=update_profile`, { method:'POST', body:JSON.stringify(payload) }); const d = await res.json(); if(d.success) { user.value = d.user; localStorage.setItem('cp_user', JSON.stringify(d.user)); alert('ä¿å­˜æˆåŠŸ'); showProfileModal.value = false; } else { alert(d.error || 'ä¿å­˜å¤±è´¥'); } } catch(e) { alert('ç½‘ç»œé”™è¯¯'); } isUpdatingProfile.value = false; };
            const submitPost = async () => { if(!postForm.value.content) return alert('å†™ç‚¹ä»€ä¹ˆå§'); const totalSize = postForm.value.images.reduce((acc, img) => acc + img.length, 0); if (totalSize > 1000000) return alert('å›¾ç‰‡æ€»å¤§å°è¶…é™ï¼Œè¯·åˆ é™¤ä¸€å¼ æˆ–æ¢å°å›¾é‡è¯•'); submitting.value = true; try { const res = await fetch(`${API}?action=create_post`, {method:'POST', body:JSON.stringify({user:user.value, ...postForm.value})}); const data = await res.json().catch(() => null); if(res.ok && data && data.success) { showPostModal.value = false; postForm.value = {content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]}; fetchPosts(); } else { const msg = data ? (data.error || 'æœªçŸ¥é”™è¯¯') : `æœåŠ¡å™¨å“åº”å¼‚å¸¸`; alert(`å‘å¸ƒå¤±è´¥: ${msg}`); } } catch(e){ alert('ç½‘ç»œé”™è¯¯'); } submitting.value = false; };
            const deletePost = async (id) => { if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { await fetch(`${API}?action=delete_post`, {method:'POST', body:JSON.stringify({id, user:user.value})}); fetchPosts(); } };
            const toggleComments = async (p) => { p.showComments = !p.showComments; if(p.showComments && !p.loaded) { p.loadingComments = true; try { p.commentList = await (await fetch(`${API}?action=get_comments&postId=${p.id}`)).json(); p.loaded=true; } catch(e){} p.loadingComments = false; } };
            const submitComment = async (p) => { if(!user.value) return showAuthModal.value = true; if(!p.newCommentInput) return; const txt = p.newCommentInput; p.newCommentInput=''; if(!p.commentList) p.commentList=[]; const tempCmt = {id:Date.now(), nickname:user.value.nickname, username:user.value.username, avatar:user.value.avatar, content:txt}; p.commentList.push(tempCmt); p.commentsCount = (p.commentsCount||0)+1; await fetch(`${API}?action=add_comment`, {method:'POST', body:JSON.stringify({postId:p.id, user:user.value, content:txt})}); };
            const deleteComment = async (p, cid) => { if(confirm('åˆ è¯„è®ºï¼Ÿ')) { await fetch(`${API}?action=delete_comment`, {method:'POST', body:JSON.stringify({postId:p.id, commentId:cid, user:user.value})}); p.commentList = p.commentList.filter(c=>c.id!==cid); p.commentsCount--; } };
            const copyText = (text, label) => { if(navigator.clipboard) navigator.clipboard.writeText(text).then(() => alert(`å·²å¤åˆ¶ ${label}: ${text}`)); else { const input = document.createElement('input'); input.value = text; document.body.appendChild(input); input.select(); document.execCommand('copy'); document.body.removeChild(input); alert(`å·²å¤åˆ¶ ${label}: ${text}`); } };
            const changeFilter = g => filterGame.value = g;
            const logout = () => { user.value=null; localStorage.removeItem('cp_user'); showProfileModal.value=false; };
            const checkAuthAndPost = () => user.value ? showPostModal.value = true : showAuthModal.value = true;
            const removeImage = i => postForm.value.images.splice(i,1);
            const previewImage = (l,i) => preview.value = {show:true, list:l, idx:i};
            const scrollToTop = () => window.scrollTo({top:0, behavior:'smooth'});

            return {
                user, loading, error, posts, columns, games, filterGame, notice, scrollY,
                showAuthModal, authMode, authForm, isAuthing, showPostModal, postForm, submitting, preview,
                showProfileModal, profileForm, isUpdatingProfile, viewingUser, isMyProfile, genderMap, targetMap,
                showInboxModal, inboxList, showChatModal, chatMessages: mergedMessages, chatTarget, chatInput, totalUnread,
                
                refresh:fetchPosts, handleAuth, handleAvatarUpload, handlePostImageUpload, submitPost,
                deletePost, isLiked, handleLike, toggleComments, submitComment, deleteComment,
                changeFilter, logout, checkAuthAndPost, removeImage, previewImage, scrollToTop,
                startLongPress, endLongPress, triggerReply,
                handleProfileAvatarChange, handleProfileUpdate, copyText, handleAvatarClick,
                openInbox, openChat, sendChat, deleteChatSession,
                handleChatScroll, scrollToBottom, showNewMsgToast // å¯¼å‡ºæ–°æ–¹æ³•
            };
        }
    }).mount('#app');
</script>
</body>
</html>
