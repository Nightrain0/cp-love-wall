<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* --- å…¨å±€ç¾åŒ– --- */
        body { 
            background: #fdf4f8; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 200, 221, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(162, 210, 255, 0.3) 0px, transparent 50%);
            background-attachment: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* â˜… ä¸æ»‘çš„åˆ—è¡¨è¿‡æ¸¡åŠ¨ç”» */
        .list-move, 
        .list-enter-active,
        .list-leave-active {
            transition: all 0.5s cubic-bezier(0.55, 0, 0.1, 1);
        }
        .list-enter-from,
        .list-leave-to {
            opacity: 0;
            transform: scale(0.95) translateY(20px);
        }
        /* ç¡®ä¿ç¦»å¼€çš„å…ƒç´ ä¸å ä½ï¼Œå®ç°å¹³æ»‘é‡æ–°æ’åˆ— */
        .list-leave-active {
            position: absolute; 
            width: 100%; /* å¿…é¡»é™åˆ¶å®½åº¦ï¼Œå¦åˆ™ç€‘å¸ƒæµä¼šä¹± */
            z-index: 0;
        }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.05);
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .game-tag { font-size: 11px; padding: 4px 12px; border-radius: 99px; font-weight: 700; transition: all 0.2s; }
        .tag-common { background: rgba(255,255,255,0.6); color: #64748b; border: 1px solid rgba(0,0,0,0.05); }
        .tag-active { background: #334155; color: #fff; transform: scale(1.05); box-shadow: 0 4px 12px rgba(51, 65, 85, 0.3); }

        /* åº•éƒ¨å®‰å…¨åŒºé€‚é… */
        .bottom-safe-margin { margin-bottom: env(safe-area-inset-bottom); }
        
        /* ç€‘å¸ƒæµå¸ƒå±€ */
        .columns-container {
            column-gap: 1.25rem;
        }
        .break-inside-avoid { 
            break-inside: avoid; 
            margin-bottom: 1.25rem; /* å¡ç‰‡é—´è· */
        }
    </style>
</head>
<body>

<div id="app" class="max-w-6xl mx-auto min-h-screen pb-32 relative">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-xl border-b border-pink-100/50 px-4 h-16 flex items-center justify-between shadow-sm transition-all duration-300" :class="{'shadow-md': scrollY > 10}">
        <div class="flex items-center gap-2 cursor-pointer group" @click="refresh">
            <div class="bg-gradient-to-tr from-pink-400 to-violet-500 w-9 h-9 rounded-xl flex items-center justify-center text-white shadow-lg shadow-pink-200 group-hover:rotate-12 transition-transform">
                <i class="ri-heart-3-fill text-xl"></i>
            </div>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-purple-600 hidden sm:block tracking-tight">
                CPDDæ‰©åˆ—å°ç«™
            </h1>
            <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-purple-600 sm:hidden">
                CPDD
            </h1>
        </div>
        <div v-if="user" class="flex items-center gap-3 animate-fade-in">
            <div class="flex flex-col items-end">
                <span class="text-xs font-bold text-slate-700">{{ user.nickname }}</span>
                <span v-if="user.isAdmin" class="text-[10px] bg-red-500 text-white px-1.5 py-0.5 rounded leading-tight font-bold tracking-wider">ADMIN</span>
            </div>
            <img :src="user.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+user.username" class="w-10 h-10 rounded-full border-2 border-white shadow-md bg-pink-50 object-cover">
            <button @click="logout" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-pink-100 hover:text-pink-500 transition-colors flex items-center justify-center" title="é€€å‡ºç™»å½•">
                <i class="ri-logout-box-r-line"></i>
            </button>
        </div>
        <button v-else @click="showAuthModal = true" class="text-xs font-bold text-white bg-slate-900 px-5 py-2.5 rounded-full shadow-lg shadow-slate-300 active:scale-95 transition-transform hover:bg-black">
            ç™»å½• / æ³¨å†Œ
        </button>
    </header>

    <!-- æ¸¸æˆç­›é€‰æ  -->
    <div class="sticky top-16 z-30 bg-white/80 backdrop-blur-md border-b border-slate-50 px-4 py-3 overflow-x-auto hide-scrollbar">
        <div class="flex gap-2 sm:justify-center min-w-max">
            <button v-for="g in games" :key="g" @click="filterGame = g"
                class="game-tag"
                :class="filterGame === g ? 'tag-active' : 'tag-common hover:bg-white'">
                {{ g }}
            </button>
        </div>
    </div>

    <!-- å¸–å­åˆ—è¡¨ (ç€‘å¸ƒæµå¸ƒå±€) -->
    <main class="p-4 relative">
        <!-- åŠ è½½ä¸­ -->
        <div v-if="loading" class="text-center py-32 animate-pulse">
            <div class="text-4xl mb-4">âœ¨</div>
            <p class="text-sm text-slate-400 font-medium">æ­£åœ¨è¿æ¥æ‰©åˆ—ä¿¡å·...</p>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-else-if="filteredPosts.length === 0" class="text-center py-20 animate-fade-in">
            <div class="w-32 h-32 bg-slate-100 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl shadow-inner">
                ğŸ‘»
            </div>
            <p class="text-slate-500 font-bold">å“å‘€ï¼Œè¿™é‡Œç©ºç©ºçš„</p>
            <p class="text-xs text-slate-400 mt-1">å¿«æ¥å‘ç¬¬ä¸€æ¡æ‰©åˆ—åŠ¨æ€å§ï¼</p>
        </div>
        
        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div class="columns-container columns-1 md:columns-2 lg:columns-3 relative">
            <transition-group name="list">
                <div v-for="post in filteredPosts" :key="post.id" class="break-inside-avoid glass-card rounded-3xl p-5 hover:shadow-xl transition-shadow duration-300 group">
                    <!-- å¤´éƒ¨ -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex gap-3 items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-pink-200 to-purple-200 p-0.5 shadow-sm flex-shrink-0">
                                <img :src="post.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+post.username" class="w-full h-full rounded-full object-cover bg-white">
                            </div>
                            <div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-bold text-slate-800 text-sm">{{ post.nickname }}</span>
                                    <span class="text-[10px] px-2 py-0.5 rounded-full font-bold bg-slate-100 text-slate-500">{{ post.game }}</span>
                                </div>
                                <p class="text-[10px] text-slate-400 font-medium mt-0.5">{{ post.timeStr }}</p>
                            </div>
                        </div>
                        <!-- ç®¡ç†å‘˜åˆ é™¤å¸–å­æŒ‰é’® -->
                        <button v-if="user && user.isAdmin" @click="deletePost(post)" class="opacity-0 group-hover:opacity-100 transition-opacity text-slate-300 hover:text-red-500 p-1">
                            <i class="ri-delete-bin-line text-lg"></i>
                        </button>
                    </div>

                    <!-- æ–‡æ¡ˆ -->
                    <div class="text-[15px] text-slate-700 mb-3 leading-relaxed tracking-wide whitespace-pre-wrap font-medium">{{ post.desc }}</div>
                    
                    <!-- è¦æ±‚ -->
                    <div v-if="post.requirement" class="mb-4 bg-pink-50/50 p-3 rounded-2xl border border-pink-100">
                        <p class="text-xs font-bold text-pink-500 mb-1 flex items-center gap-1">
                            <i class="ri-vip-crown-line"></i> å¯»æ‰¾é˜Ÿå‹
                        </p>
                        <p class="text-xs text-slate-600 leading-relaxed">{{ post.requirement }}</p>
                    </div>

                    <!-- å›¾ç‰‡å¢™ -->
                    <div v-if="post.images && post.images.length" class="grid gap-2 mb-4 rounded-2xl overflow-hidden"
                         :class="'img-grid-' + (post.images.length > 3 ? 3 : post.images.length)">
                        <div v-for="(img, idx) in post.images" :key="idx" 
                             class="aspect-square bg-slate-100 cursor-zoom-in overflow-hidden relative group/img"
                             @click="previewImage(post.images, idx)">
                            <img :src="img" class="w-full h-full object-cover transition-transform duration-700 group-hover/img:scale-110" loading="lazy">
                        </div>
                    </div>

                    <!-- åº•éƒ¨æ  -->
                    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                        <button @click="toggleComments(post)" class="flex items-center gap-1.5 text-slate-400 hover:text-slate-600 transition-colors group/btn px-2 py-1 rounded-full hover:bg-slate-50">
                            <i class="ri-chat-smile-2-line text-lg group-hover/btn:scale-110 transition-transform"></i>
                            <span class="text-xs font-bold">{{ post.commentsCount || 0 }}</span>
                        </button>
                        
                        <button @click="likePost(post)" class="flex items-center gap-1.5 transition-colors group/btn px-2 py-1 rounded-full hover:bg-pink-50"
                            :class="isLiked(post) ? 'text-pink-500' : 'text-slate-400'">
                            <i :class="isLiked(post) ? 'ri-heart-3-fill scale-110' : 'ri-heart-3-line'" class="text-lg transition-transform group-active/btn:scale-125"></i>
                            <span class="text-xs font-bold">
                                {{ post.likes }}
                            </span>
                        </button>
                    </div>

                    <!-- è¯„è®ºåŒº -->
                    <div v-if="post.showComments" class="mt-4 animate-fade-in">
                        <div v-if="post.loadingComments" class="text-center text-xs text-slate-400 py-2">åŠ è½½è¯„è®ºä¸­...</div>
                        <div v-else class="bg-slate-50/80 rounded-2xl p-3 border border-slate-100 shadow-inner">
                            <div v-if="!post.comments || post.comments.length === 0" class="text-center text-xs text-slate-300 py-4">
                                å¿«æ¥åæ²™å‘~
                            </div>
                            <div class="space-y-3 mb-3 max-h-48 overflow-y-auto custom-scrollbar pr-1">
                                <div v-for="cmt in post.comments" :key="cmt.id" class="flex gap-2 text-xs group/cmt">
                                    <img :src="cmt.avatar || 'https://api.dicebear.com/7.x/avataaars/svg'" class="w-6 h-6 rounded-full border bg-white shrink-0">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-slate-700">{{ cmt.nickname }}</span>
                                            <!-- ç®¡ç†å‘˜åˆ é™¤è¯„è®º -->
                                            <button v-if="user && user.isAdmin" @click="deleteComment(post, cmt)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover/cmt:opacity-100 transition-opacity">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                        </div>
                                        <p class="text-slate-600 mt-0.5 leading-relaxed break-all">{{ cmt.content }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 items-center mt-2">
                                <input v-model="post.newComment" 
                                       placeholder="è¯´ç‚¹å¥½å¬çš„..." 
                                       class="flex-1 bg-white border-none rounded-full px-4 py-2 text-xs shadow-sm focus:ring-2 focus:ring-pink-200 outline-none transition-all">
                                <button @click="submitComment(post)" class="bg-slate-800 text-white rounded-full w-8 h-8 flex items-center justify-center shadow hover:bg-black transition-colors"><i class="ri-send-plane-fill text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition-group>
        </div>
    </main>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <transition name="fade">
        <button v-show="scrollY > 300" @click="scrollToTop" class="fixed bottom-24 right-6 z-20 w-10 h-10 bg-white text-slate-600 rounded-full shadow-lg border border-slate-100 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
            <i class="ri-arrow-up-line"></i>
        </button>
    </transition>

    <!-- æ‚¬æµ®å‘å¸ƒæŒ‰é’® -->
    <div class="fixed bottom-6 right-6 z-30 bottom-safe-margin">
        <button @click="checkAuthAndPost" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white w-14 h-14 rounded-full shadow-xl shadow-pink-300 flex items-center justify-center text-2xl active:scale-90 transition-transform hover:scale-105 group">
            <i class="ri-add-line group-hover:rotate-90 transition-transform duration-300"></i>
        </button>
    </div>

    <!-- è®¤è¯å¼¹çª— -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-xs rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="flex text-sm font-bold bg-slate-50 p-1 m-4 rounded-xl relative">
                <div class="absolute top-1 bottom-1 bg-white rounded-lg shadow-sm transition-all duration-300 w-1/2" :style="{left: authMode==='login'?'4px':'50%'}"></div>
                <button @click="authMode='login'" class="flex-1 py-2 relative z-10 transition-colors" :class="authMode==='login'?'text-slate-800':'text-slate-400'">ç™»å½•</button>
                <button @click="authMode='register'" class="flex-1 py-2 relative z-10 transition-colors" :class="authMode==='register'?'text-slate-800':'text-slate-400'">æ³¨å†Œ</button>
            </div>
            
            <div class="px-6 pb-6 space-y-4">
                <div v-if="authMode==='register'" class="flex justify-center">
                     <div class="w-20 h-20 rounded-full bg-slate-50 border-2 border-dashed border-pink-200 flex flex-col items-center justify-center text-pink-300 cursor-pointer relative overflow-hidden group hover:border-pink-400 transition-colors" @click="$refs.avatarInput.click()">
                        <img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover">
                        <div v-else class="flex flex-col items-center">
                            <i class="ri-camera-fill text-2xl"></i>
                            <span class="text-[10px] mt-1">ä¼ å¤´åƒ</span>
                        </div>
                        <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
                     </div>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-slate-50 rounded-xl px-4 py-2 border border-slate-100 focus-within:border-pink-300 focus-within:bg-white transition-colors">
                        <input v-model="authForm.username" placeholder="è´¦å· (è‡³å°‘8ä½)" class="w-full bg-transparent text-sm outline-none placeholder-slate-400">
                    </div>
                    <div class="bg-slate-50 rounded-xl px-4 py-2 border border-slate-100 focus-within:border-pink-300 focus-within:bg-white transition-colors">
                        <input v-model="authForm.password" type="password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full bg-transparent text-sm outline-none placeholder-slate-400">
                    </div>
                    <div v-if="authMode==='register'" class="bg-slate-50 rounded-xl px-4 py-2 border border-slate-100 focus-within:border-pink-300 focus-within:bg-white transition-colors">
                        <input v-model="authForm.nickname" placeholder="æ˜µç§°" class="w-full bg-transparent text-sm outline-none placeholder-slate-400">
                    </div>
                </div>
                
                <button @click="handleAuth" :disabled="isAuthing" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform disabled:opacity-70">
                    {{ isAuthing ? 'å¤„ç†ä¸­...' : (authMode==='login'?'ç™» å½•':'æ³¨ å†Œ') }}
                </button>
                <p class="text-center text-xs text-slate-400 mt-2 cursor-pointer hover:text-pink-400" @click="showAuthModal=false">å…ˆé€›é€›ï¼Œä»¥åå†è¯´</p>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col animate-fade-in">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
            <button @click="showPostModal = false" class="text-slate-500 px-3 py-1 rounded-full hover:bg-slate-100 text-sm font-bold">å–æ¶ˆ</button>
            <h3 class="font-bold text-slate-800 text-lg">âœ¨ å‘å¸ƒåŠ¨æ€</h3>
            <button @click="submitPost" :disabled="submitting" class="bg-pink-500 text-white px-5 py-1.5 rounded-full text-sm font-bold disabled:opacity-50 transition-colors shadow-lg shadow-pink-200">
                {{ submitting ? 'å‘é€ä¸­' : 'å‘å¸ƒ' }}
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5 pb-20">
            <textarea v-model="postForm.content" class="w-full h-32 text-[15px] resize-none focus:outline-none placeholder-slate-300 leading-relaxed" placeholder="åˆ†äº«ä½ çš„æ¸¸æˆæ—¥å¸¸ï¼Œå¯»æ‰¾ä½ çš„å›ºç©CP..."></textarea>
            
            <div class="flex flex-wrap gap-3 mb-6">
                <div v-for="(img, idx) in postForm.images" :key="idx" class="w-24 h-24 rounded-2xl bg-slate-100 relative overflow-hidden group border border-slate-200">
                    <img :src="img" class="w-full h-full object-cover">
                    <button @click="removeImage(idx)" class="absolute top-1 right-1 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm backdrop-blur-sm hover:bg-red-500 transition-colors">
                        <i class="ri-close-line"></i>
                    </button>
                    <div class="absolute bottom-0 left-0 right-0 bg-black/40 text-white text-[9px] text-center py-0.5 backdrop-blur-sm">
                        {{ getSizeKB(img) }}
                    </div>
                </div>
                
                <div v-if="postForm.images.length < 3" @click="$refs.postImgInput.click()" class="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 cursor-pointer active:bg-slate-50 hover:border-pink-300 hover:text-pink-300 transition-colors bg-slate-50/50">
                    <i class="ri-image-add-line text-2xl mb-1"></i>
                    <span class="text-[10px]">æ·»åŠ å›¾ç‰‡</span>
                </div>
                <input type="file" ref="postImgInput" hidden accept="image/*" @change="handlePostImageUpload">
            </div>

            <div class="space-y-5">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="text-xs font-bold text-slate-400 block mb-2 flex items-center gap-1"><i class="ri-gamepad-line"></i> å…³è”æ¸¸æˆ</label>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="g in games.slice(1)" :key="g" 
                              @click="postForm.game = g"
                              class="text-xs px-3 py-1.5 rounded-lg border transition-all cursor-pointer font-medium"
                              :class="postForm.game === g ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-500 border-slate-200'">
                            {{ g }}
                        </span>
                    </div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="text-xs font-bold text-slate-400 block mb-2 flex items-center gap-1"><i class="ri-user-heart-line"></i> æ‰©åˆ—è¦æ±‚</label>
                    <input v-model="postForm.requirement" class="w-full bg-transparent text-sm outline-none placeholder-slate-300" placeholder="æ¯”å¦‚ï¼šé‡ç‹ddï¼Œä¸å‹åŠ›ï¼Œå¿ƒæ€å¥½...">
                </div>
            </div>
            
            <p class="text-center text-xs text-slate-300 mt-8">è¯·æ–‡æ˜å‘è¨€ï¼Œæ‹’ç»ä¸è‰¯ä¿¡æ¯</p>
        </div>
    </div>

    <!-- å›¾ç‰‡å¤§å›¾é¢„è§ˆ -->
    <div v-if="preview.show" class="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center backdrop-blur-sm animate-fade-in" @click="preview.show = false">
        <img :src="preview.list[preview.idx]" class="max-w-full max-h-[90vh] object-contain transition-all duration-300 shadow-2xl" @click.stop>
        
        <div v-if="preview.list.length > 1" class="absolute bottom-10 flex gap-3 p-2 bg-black/30 rounded-full backdrop-blur-md" @click.stop>
             <button v-for="(img, idx) in preview.list" :key="idx" 
                     @click="preview.idx = idx"
                     class="w-2.5 h-2.5 rounded-full transition-all"
                     :class="preview.idx === idx ? 'bg-white scale-125' : 'bg-white/30 hover:bg-white/60'">
             </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

    createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const posts = ref([]);
            const loading = ref(true);
            const scrollY = ref(0);

            // çŠ¶æ€
            const showAuthModal = ref(false);
            const authMode = ref('login'); 
            const showPostModal = ref(false);
            const submitting = ref(false);
            const isAuthing = ref(false);
            const preview = ref({ show: false, list: [], idx: 0 });

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');

            const authForm = ref({ username: '', password: '', nickname: '', avatar: '' });
            const postForm = ref({ content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] });

            // æ»šåŠ¨ç›‘å¬
            const handleScroll = () => { scrollY.value = window.scrollY; };

            onMounted(() => {
                const savedUser = localStorage.getItem('cp_user');
                if (savedUser) user.value = JSON.parse(savedUser);
                
                fetchPosts();
                window.addEventListener('scroll', handleScroll);
            });
            
            onUnmounted(() => {
                window.removeEventListener('scroll', handleScroll);
            });

            const scrollToTop = () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const refresh = () => fetchPosts();
            const logout = () => { user.value = null; localStorage.removeItem('cp_user'); };

            const getSizeKB = (base64Str) => {
                if (!base64Str) return '';
                return (base64Str.length * 0.75 / 1024).toFixed(1) + ' KB';
            };

            const compressImage = (file, maxWidth = 1280, quality = 0.8) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width;
                            let h = img.height;
                            if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                            if (h > maxWidth) { w *= maxWidth / h; h = maxWidth; }
                            canvas.width = w;
                            canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleAvatarUpload = async (e) => {
                if(e.target.files[0]) authForm.value.avatar = await compressImage(e.target.files[0], 200, 0.7);
            };
            
            const handleAuth = async () => {
                const { username, password } = authForm.value;
                if (!username || !password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');
                
                if (authMode.value === 'register') {
                    if (username.length < 8) return alert('è´¦å·å¤ªçŸ­å•¦ï¼Œè‡³å°‘è¦8ä½å“¦'); // â˜… 8ä½æ£€æŸ¥
                    if (password.length < 6) return alert('ä¸ºäº†å®‰å…¨ï¼Œå¯†ç è‡³å°‘è®¾ç½®6ä½å§');
                    if (username === 'admin' && !confirm("ä½ è¦æ³¨å†Œç®¡ç†å‘˜è´¦å·(admin)å—ï¼Ÿ")) return;
                }

                isAuthing.value = true;
                try {
                    const res = await fetch(`${API}?action=${authMode.value}`, {
                        method: 'POST',
                        body: JSON.stringify(authForm.value)
                    });
                    const data = await res.json();
                    if (data.error) {
                        alert(data.error);
                    } else {
                        user.value = data.user;
                        localStorage.setItem('cp_user', JSON.stringify(data.user));
                        showAuthModal.value = false;
                        authForm.value = { username: '', password: '', nickname: '', avatar: '' };
                    }
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
                isAuthing.value = false;
            };

            const fetchPosts = async () => {
                loading.value = true;
                try {
                    const res = await fetch(API);
                    posts.value = await res.json();
                } catch(e) {}
                loading.value = false;
            };

            const checkAuthAndPost = () => {
                if (!user.value) {
                    showAuthModal.value = true;
                } else {
                    showPostModal.value = true;
                }
            };

            const handlePostImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (postForm.value.images.length >= 3) return alert('æœ€å¤š3å¼ å“¦');
                const base64 = await compressImage(file, 1280, 0.8);
                postForm.value.images.push(base64);
                e.target.value = ''; 
            };
            
            const removeImage = (idx) => postForm.value.images.splice(idx, 1);

            const submitPost = async () => {
                if (!postForm.value.content) return alert('è¯´ç‚¹ä»€ä¹ˆå§');
                const totalSize = postForm.value.images.reduce((acc, img) => acc + (img.length * 0.75), 0);
                if (totalSize > 900 * 1024) return alert(`å›¾ç‰‡å¤ªæ¸…æ™°å•¦ (æ€»å…± ${(totalSize/1024).toFixed(0)}KB)ï¼å·²è¶…è¿‡æ•°æ®åº“é™åˆ¶ã€‚`);

                submitting.value = true;
                try {
                    const payload = { user: user.value, ...postForm.value };
                    const res = await fetch(`${API}?action=create_post`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        showPostModal.value = false;
                        postForm.value = { content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] };
                        fetchPosts();
                    } else {
                        const err = await res.json();
                        alert(err.error || 'å‘å¸ƒå¤±è´¥');
                    }
                } catch (e) { alert('å‘å¸ƒå¤±è´¥'); }
                submitting.value = false;
            };

            // ç®¡ç†å‘˜åˆ å¸–
            const deletePost = async (post) => {
                if (!confirm('ã€ç®¡ç†å‘˜ã€‘ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰©åˆ—å—ï¼Ÿ')) return;
                try {
                    const res = await fetch(`${API}?action=delete_post`, {
                        method: 'POST',
                        body: JSON.stringify({ id: post.id, user: user.value })
                    });
                    if (res.ok) posts.value = posts.value.filter(p => p.id !== post.id);
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
            };

            // â˜… ç®¡ç†å‘˜åˆ è¯„è®º
            const deleteComment = async (post, cmt) => {
                if (!confirm('ã€ç®¡ç†å‘˜ã€‘ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
                try {
                    const res = await fetch(`${API}?action=delete_comment`, {
                        method: 'POST',
                        body: JSON.stringify({ postId: post.id, commentId: cmt.id, user: user.value })
                    });
                    if (res.ok) {
                        post.comments = post.comments.filter(c => c.id !== cmt.id);
                        post.commentsCount--;
                    }
                } catch(e) {}
            };

            // --- ç‚¹èµé€»è¾‘é‡æ„ ---
            // åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦èµè¿‡
            // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç®€æ˜“æ–¹æ³•ï¼šå‰ç«¯è™½ç„¶ä¸çŸ¥é“è‡ªå·±çš„ IPï¼Œä½†å¯ä»¥åœ¨ç‚¹èµåæ ¹æ®åç«¯è¿”å›çš„ identifier æ¥ç¡®è®¤
            // æˆ–è€…ç›´æ¥å‡è®¾åç«¯è¿”å›çš„ likedIds åŒ…å«äº†â€œæˆ‘â€ã€‚
            // ç”±äºå‰ç«¯çº¯é™æ€éš¾ä»¥è·å– IPï¼Œæˆ‘ä»¬è¿™é‡Œä¾èµ– likedLocal ç¼“å­˜ + ä¹è§‚æ›´æ–°ã€‚
            // ä½†ä¸ºäº†æ”¯æŒå–æ¶ˆï¼Œæˆ‘ä»¬ä½¿ç”¨â€œç‚¹å‡»å³åè½¬â€é€»è¾‘ã€‚
            
            const isLiked = (post) => {
                // å¦‚æœæœ‰æœ¬åœ°ä¸´æ—¶æ ‡è®°ï¼Œä¼˜å…ˆä½¿ç”¨
                if (post.isLikedTemp !== undefined) return post.isLikedTemp;
                
                // æ£€æŸ¥åç«¯æ•°æ® (è¿™ä¸ªéœ€è¦åç«¯è¿”å› likedIdsï¼Œä¸”åŒ…å«å½“å‰ç”¨æˆ·çš„æ ‡è¯†)
                // ç”±äºå‰ç«¯ä¸çŸ¥é“è‡ªå·±çš„ IPï¼Œè¿™é‡Œåªèƒ½å°½åŠ›è€Œä¸ºï¼š
                // 1. å¦‚æœç™»å½•äº†ï¼Œæ£€æŸ¥ username
                if (user.value && post.likedIds) {
                    return post.likedIds.includes(`user:${user.value.username}`);
                }
                // 2. å¦‚æœæ²¡ç™»å½•ï¼Œæ— æ³•å‡†ç¡®åˆ¤æ–­åˆå§‹çŠ¶æ€ï¼Œåªèƒ½é»˜è®¤æœªç‚¹èµ (é™¤éç”¨ cookieï¼Œè¿™é‡Œç®€åŒ–å¤„ç†)
                return false;
            };

            const likePost = async (post) => {
                // ä¹è§‚æ›´æ–°çŠ¶æ€
                const currentStatus = isLiked(post);
                post.isLikedTemp = !currentStatus;
                post.likes = currentStatus ? (post.likes - 1) : (post.likes + 1);

                try {
                    const res = await fetch(`${API}?action=like`, { 
                        method: 'POST', 
                        body: JSON.stringify({ id: post.id, user: user.value }) 
                    });
                    const data = await res.json();
                    
                    // åç«¯è¿”å›äº†ç”¨æˆ·çš„çœŸå® identifierï¼Œæˆ‘ä»¬å¯ä»¥å­˜ä¸‹æ¥ç”¨äºåç»­åˆ¤æ–­
                    if (data.identifier && !user.value) {
                         // å¯ä»¥åœ¨è¿™é‡Œå­˜å…¥ sessionStorage æ ‡è¯†â€œæˆ‘çš„IPæ˜¯è¿™ä¸ªâ€
                    }
                } catch(e) {
                    // å¤±è´¥å›æ»š
                    post.isLikedTemp = currentStatus;
                    post.likes = currentStatus ? (post.likes + 1) : (post.likes - 1);
                }
            };

            const toggleComments = async (post) => {
                post.showComments = !post.showComments;
                if (post.showComments && !post.commentsLoaded) {
                    post.loadingComments = true;
                    try {
                        const res = await fetch(`${API}?action=get_comments&postId=${post.id}`);
                        post.comments = await res.json();
                        post.commentsLoaded = true;
                    } catch(e){}
                    post.loadingComments = false;
                }
            };

            const submitComment = async (post) => {
                if (!user.value) return showAuthModal.value = true;
                if (!post.newComment) return;
                
                const tempComment = {
                    id: Date.now(),
                    nickname: user.value.nickname,
                    avatar: user.value.avatar,
                    content: post.newComment
                };
                
                if (!post.comments) post.comments = [];
                post.comments.push(tempComment);
                post.commentsCount = (post.commentsCount || 0) + 1;
                
                const txt = post.newComment;
                post.newComment = '';

                await fetch(`${API}?action=add_comment`, {
                    method: 'POST',
                    body: JSON.stringify({ postId: post.id, user: user.value, content: txt })
                });
            };
            
            const previewImage = (list, idx) => {
                preview.value = { show: true, list, idx };
            };

            const filteredPosts = computed(() => {
                if (filterGame.value === 'å…¨éƒ¨') return posts.value;
                return posts.value.filter(p => p.game === filterGame.value);
            });

            return {
                user, posts, loading, games, filterGame, filteredPosts,
                showAuthModal, authMode, authForm, isAuthing,
                showPostModal, postForm, submitting, preview, scrollY,
                refresh, logout, handleAuth, handleAvatarUpload,
                checkAuthAndPost, handlePostImageUpload, removeImage, submitPost,
                likePost, isLiked, toggleComments, submitComment, previewImage, getSizeKB,
                deletePost, deleteComment, scrollToTop
            };
        }
    }).mount('#app');
</script>
</body>
</html>
