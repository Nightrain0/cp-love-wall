<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* --- è§†è§‰åŸºç¡€ --- */
        body { 
            background-color: #f8fafc;
            background-image: 
                linear-gradient(to bottom right, #fff1f2, #f8fafc, #f0f9ff);
            background-attachment: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #334155;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* --- åŠ¨ç”»ç³»ç»Ÿ --- */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(30px); }
        .list-move { transition: transform 0.5s ease; }

        /* --- æ ¸å¿ƒå¡ç‰‡ --- */
        .app-card {
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 10px 15px -3px rgba(244, 114, 182, 0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid #f1f5f9;
            overflow: hidden;
        }
        .app-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(244, 114, 182, 0.1);
            border-color: #fce7f3;
        }

        /* --- ç»„ä»¶æ ·å¼ --- */
        .tag { 
            font-size: 12px; font-weight: 600; padding: 6px 14px; border-radius: 100px; 
            transition: all 0.2s; white-space: nowrap;
        }
        .tag-active { background: #1e293b; color: #fff; box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2); transform: scale(1.02); }
        .tag-inactive { background: #fff; color: #64748b; border: 1px solid #e2e8f0; }
        .tag-inactive:hover { background: #f8fafc; color: #334155; }

        .img-grid { display: grid; gap: 6px; border-radius: 16px; overflow: hidden; margin-top: 12px; }
        .img-grid-1 { grid-template-columns: 1fr; }
        .img-grid-2 { grid-template-columns: 1fr 1fr; }
        .img-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .img-item { 
            aspect-ratio: 1/1; width: 100%; object-fit: cover; cursor: zoom-in; 
            transition: filter 0.3s, transform 0.5s; 
        }
        .img-item:hover { filter: brightness(0.92); transform: scale(1.05); }
        .img-grid-1 .img-item { aspect-ratio: 16/9; max-height: 280px; }

        /* --- åº•éƒ¨å®‰å…¨åŒº --- */
        .pb-safe { padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
        .fab-safe { bottom: calc(32px + env(safe-area-inset-bottom)); }
    </style>
</head>
<body>

<!-- åˆå§‹åŒ– Loading / é”™è¯¯æ˜¾ç¤º (Vue æŒ‚è½½å‰å¯è§) -->
<div id="app-loading" class="fixed inset-0 flex items-center justify-center bg-slate-50 z-50 transition-opacity duration-500">
    <div class="text-center">
        <div class="text-4xl animate-bounce mb-4">ğŸ¡</div>
        <p class="text-slate-400 font-bold text-sm">æ­£åœ¨åŠ è½½èµ„æº...</p>
    </div>
</div>

<div id="app" class="min-h-screen opacity-0 transition-opacity duration-500" :class="{'opacity-100': mounted}">
    
    <!-- Header -->
    <header class="fixed top-0 inset-x-0 z-40 bg-white/80 backdrop-blur-xl border-b border-slate-100 h-16 flex items-center justify-between px-4 lg:px-8 transition-shadow" :class="{'shadow-sm': scrollY > 10}">
        <div class="flex items-center gap-3 cursor-pointer group" @click="refresh">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center text-white shadow-lg shadow-pink-200 group-hover:scale-105 transition-transform">
                <i class="ri-planet-line text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-extrabold text-slate-800 tracking-tight">CPDD<span class="text-rose-500">.</span></h1>
                <p class="text-[10px] text-slate-400 font-medium -mt-1 hidden sm:block">äºŒæ¬¡å…ƒæ‰©åˆ—å°ç«™</p>
            </div>
        </div>

        <div v-if="user" class="flex items-center gap-3 animate-fade-in">
            <div class="text-right hidden sm:block">
                <div class="text-xs font-bold text-slate-700">{{ user.nickname }}</div>
                <div v-if="user.isAdmin" class="text-[10px] text-rose-500 font-bold bg-rose-50 px-1.5 py-0.5 rounded-md inline-block">ç®¡ç†å‘˜</div>
            </div>
            <img :src="user.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`" class="w-10 h-10 rounded-full border-2 border-white shadow-md bg-slate-100 object-cover">
            <button @click="logout" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-500 flex items-center justify-center transition-colors">
                <i class="ri-logout-circle-r-line"></i>
            </button>
        </div>
        <button v-else @click="showAuthModal = true" class="bg-slate-900 text-white text-xs font-bold px-6 py-2.5 rounded-full shadow-xl shadow-slate-200 hover:bg-black transition-colors">
            ç™»å½• / æ³¨å†Œ
        </button>
    </header>
    <div class="h-16"></div>

    <!-- æ¸¸æˆ Tag -->
    <div class="sticky top-16 z-30 bg-white/90 backdrop-blur-md border-b border-slate-50 py-3 px-4 overflow-x-auto hide-scrollbar">
        <div class="flex gap-2 sm:justify-center min-w-max">
            <button v-for="g in games" :key="g" @click="changeFilter(g)"
                class="tag" :class="filterGame === g ? 'tag-active' : 'tag-inactive'">{{ g }}</button>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜å…¬å‘Šæ  -->
    <div v-if="notice && !loading" class="max-w-7xl mx-auto px-4 mt-4">
        <div class="bg-gradient-to-r from-orange-50 to-rose-50 border border-orange-100 rounded-2xl p-4 flex items-start gap-3">
            <i class="ri-notification-4-fill text-orange-400 mt-0.5"></i>
            <div>
                <h4 class="text-sm font-bold text-orange-800 mb-1">å…¬å‘Š</h4>
                <p class="text-xs text-orange-700 leading-relaxed">{{ notice }}</p>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <main class="max-w-7xl mx-auto px-4 pt-6 pb-safe">
        <!-- é”™è¯¯æç¤º -->
        <div v-if="error" class="flex flex-col items-center justify-center py-20 text-center animate-fade-in">
             <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center text-3xl mb-4 text-red-400">âš ï¸</div>
             <h3 class="font-bold text-slate-800">è¿æ¥æ–­å¼€äº†</h3>
             <p class="text-xs text-slate-400 mt-1 mb-6 max-w-xs">{{ error }}</p>
             <button @click="refresh" class="bg-slate-800 text-white px-8 py-2.5 rounded-full font-bold hover:bg-black transition-colors">é‡è¯•</button>
        </div>

        <!-- Loading -->
        <div v-else-if="loading" class="flex flex-col items-center justify-center py-32">
            <i class="ri-loader-4-line text-4xl text-rose-400 animate-spin mb-4"></i>
            <p class="text-xs text-slate-400 font-bold tracking-wider">LOADING...</p>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-else-if="!posts.length" class="flex flex-col items-center justify-center py-32 animate-fade-in">
            <div class="text-6xl mb-4 grayscale opacity-50">ğŸ”ï¸</div>
            <p class="text-slate-500 font-bold">æš‚æ— åŠ¨æ€</p>
            <button @click="checkAuthAndPost" class="mt-4 text-rose-500 text-xs font-bold hover:underline">å‘å¸ƒç¬¬ä¸€æ¡</button>
        </div>

        <!-- ç€‘å¸ƒæµ -->
        <div v-else class="flex gap-5 items-start">
            <div v-for="(col, i) in columns" :key="i" class="flex-1 flex flex-col gap-5 min-w-0">
                <transition-group name="list">
                    <div v-for="post in col" :key="post.id" class="app-card p-5 group relative">
                        <!-- å¡ç‰‡å¤´éƒ¨ -->
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-11 h-11 rounded-full bg-slate-50 p-0.5 shrink-0">
                                    <img :src="post.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.username}`" class="w-full h-full rounded-full object-cover bg-white">
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="text-sm font-bold text-slate-800">{{ post.nickname }}</span>
                                        <span class="text-[10px] px-2 py-0.5 rounded-md bg-slate-100 text-slate-500 font-bold">{{ post.game }}</span>
                                    </div>
                                    <div class="text-[10px] text-slate-400 mt-0.5 font-medium">{{ post.timeStr }}</div>
                                </div>
                            </div>
                            <!-- åˆ é™¤æŒ‰é’® -->
                            <button v-if="user && user.isAdmin" @click="deletePost(post.id)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 text-slate-300 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100">
                                <i class="ri-delete-bin-6-line"></i>
                            </button>
                        </div>

                        <!-- æ­£æ–‡ -->
                        <div class="text-[15px] text-slate-700 leading-relaxed whitespace-pre-wrap mb-3">{{ post.desc }}</div>

                        <!-- éœ€æ±‚Tag -->
                        <div v-if="post.requirement" class="bg-rose-50/50 rounded-2xl p-3 mb-4 border border-rose-100/50">
                            <div class="flex items-center gap-1.5 text-xs font-bold text-rose-500 mb-1">
                                <i class="ri-magic-line"></i> éœ€æ±‚
                            </div>
                            <div class="text-xs text-slate-600 leading-relaxed">{{ post.requirement }}</div>
                        </div>

                        <!-- å›¾ç‰‡ -->
                        <div v-if="post.images && post.images.length" class="img-grid" :class="'img-grid-' + Math.min(post.images.length, 3)">
                            <div v-for="(img, idx) in post.images" :key="idx" class="relative overflow-hidden rounded-lg group/img">
                                <img :src="img" class="img-item" @click.stop="previewImage(post.images, idx)">
                            </div>
                        </div>

                        <!-- åº•éƒ¨æ  -->
                        <div class="flex items-center justify-between mt-4 pt-3 border-t border-slate-50">
                            <button @click="toggleComments(post)" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full hover:bg-slate-50 transition-colors text-slate-400 hover:text-slate-600">
                                <i class="ri-chat-1-line text-lg"></i>
                                <span class="text-xs font-bold">{{ post.commentsCount || 0 }}</span>
                            </button>
                            
                            <!-- ç‚¹èµæŒ‰é’® (å¸¦ Loading çŠ¶æ€) -->
                            <button @click="handleLike(post)" :disabled="post.liking" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full transition-all active:scale-95 hover:bg-pink-50" :class="isLiked(post) ? 'text-rose-500' : 'text-slate-400'">
                                <i v-if="post.liking" class="ri-loader-4-line animate-spin"></i>
                                <i v-else :class="isLiked(post) ? 'ri-heart-3-fill' : 'ri-heart-3-line'" class="text-lg"></i>
                                <span class="text-xs font-bold">{{ post.likes || 0 }}</span>
                            </button>
                        </div>

                        <!-- è¯„è®ºåŒº -->
                        <div v-if="post.showComments" class="mt-4 pt-4 border-t border-dashed border-slate-200 animate-fade-in">
                            <div v-if="post.loadingComments" class="text-center text-xs text-slate-400 py-2">åŠ è½½ä¸­...</div>
                            <div v-else>
                                <div class="space-y-3 mb-3 max-h-48 overflow-y-auto pr-1 custom-scrollbar">
                                    <div v-if="!post.commentList?.length" class="text-center text-xs text-slate-300 py-2">æš‚æ— è¯„è®º</div>
                                    <div v-for="cmt in post.commentList" :key="cmt.id" class="flex gap-3 text-xs group/cmt">
                                        <img :src="cmt.avatar || `https://api.dicebear.com/7.x/avataaars/svg`" class="w-6 h-6 rounded-full bg-slate-100 shrink-0">
                                        <div class="flex-1">
                                            <div class="flex justify-between">
                                                <span class="font-bold text-slate-700">{{ cmt.nickname }}</span>
                                                <button v-if="user?.isAdmin" @click="deleteComment(post, cmt.id)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover/cmt:opacity-100"><i class="ri-close-circle-line"></i></button>
                                            </div>
                                            <p class="text-slate-600 mt-0.5 leading-relaxed">{{ cmt.content }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input v-model="post.newCommentInput" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." class="flex-1 bg-slate-50 border-none rounded-full px-4 py-2 text-xs focus:ring-2 focus:ring-rose-100 outline-none transition-all">
                                    <button @click="submitComment(post)" class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-black"><i class="ri-send-plane-fill text-xs"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition-group>
            </div>
        </div>
    </main>

    <!-- æ‚¬æµ®æ“ä½œæ  -->
    <div class="fixed right-5 z-40 flex flex-col gap-3 fab-safe">
        <transition name="fade">
            <button v-show="scrollY > 300" @click="scrollToTop" class="w-12 h-12 bg-white text-slate-400 rounded-full shadow-xl border border-slate-100 flex items-center justify-center hover:text-rose-500 transition-colors">
                <i class="ri-arrow-up-line text-xl"></i>
            </button>
        </transition>
        <button @click="checkAuthAndPost" class="w-14 h-14 bg-slate-900 text-white rounded-full shadow-2xl shadow-slate-400 flex items-center justify-center hover:scale-110 active:scale-95 transition-all group">
            <i class="ri-add-line text-2xl group-hover:rotate-90 transition-transform duration-300"></i>
        </button>
    </div>

    <!-- å¼¹çª—ç»„ä»¶ï¼šè®¤è¯ / å‘å¸ƒ / å›¾ç‰‡é¢„è§ˆ (ç•¥ä½œç®€åŒ–ä»¥èŠ‚çœé•¿åº¦ï¼Œé€»è¾‘ä¿æŒä¸€è‡´) -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-md animate-fade-in">
        <div class="bg-white w-full max-w-xs rounded-[32px] shadow-2xl p-6 overflow-hidden">
            <h3 class="text-center font-extrabold text-xl mb-6 text-slate-800">{{ authMode === 'login' ? 'æ¬¢è¿å›æ¥' : 'åˆ›å»ºè´¦å·' }}</h3>
            <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                <button @click="authMode='login'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" :class="authMode==='login'?'bg-white shadow text-slate-800':'text-slate-400'">ç™»å½•</button>
                <button @click="authMode='register'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" :class="authMode==='register'?'bg-white shadow text-slate-800':'text-slate-400'">æ³¨å†Œ</button>
            </div>
            <div class="space-y-3">
                <div v-if="authMode==='register'" class="flex justify-center mb-2" @click="$refs.avatarInput.click()">
                     <div class="w-16 h-16 rounded-full bg-slate-50 border-2 border-dashed border-rose-200 flex items-center justify-center text-rose-300 cursor-pointer overflow-hidden relative">
                        <img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover">
                        <i v-else class="ri-camera-fill text-xl"></i>
                     </div>
                     <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
                </div>
                <input v-model="authForm.username" placeholder="è´¦å· (è‡³å°‘8ä½)" class="w-full bg-slate-50 rounded-xl px-4 py-3 text-xs font-bold focus:bg-white focus:ring-2 focus:ring-rose-100 outline-none transition-all">
                <input v-model="authForm.password" type="password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full bg-slate-50 rounded-xl px-4 py-3 text-xs font-bold focus:bg-white focus:ring-2 focus:ring-rose-100 outline-none transition-all">
                <input v-if="authMode==='register'" v-model="authForm.nickname" placeholder="æ˜µç§°" class="w-full bg-slate-50 rounded-xl px-4 py-3 text-xs font-bold focus:bg-white focus:ring-2 focus:ring-rose-100 outline-none transition-all">
                <button @click="handleAuth" :disabled="isAuthing" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-all disabled:opacity-50 mt-2">
                    {{ isAuthing ? 'è¯·ç¨å€™...' : 'ç¡®è®¤' }}
                </button>
            </div>
            <button @click="showAuthModal=false" class="w-full mt-4 text-xs text-slate-400 hover:text-slate-600">æš‚ä¸ç™»å½•</button>
        </div>
    </div>

    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col animate-fade-in">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-50">
            <button @click="showPostModal = false" class="w-8 h-8 rounded-full bg-slate-50 text-slate-500 flex items-center justify-center"><i class="ri-close-line"></i></button>
            <h3 class="font-bold text-slate-800">å‘å¸ƒåŠ¨æ€</h3>
            <button @click="submitPost" :disabled="submitting" class="bg-rose-500 text-white px-5 py-1.5 rounded-full text-sm font-bold disabled:opacity-50 shadow-lg shadow-rose-200">{{ submitting ? '...' : 'å‘å¸ƒ' }}</button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 pb-20">
            <textarea v-model="postForm.content" class="w-full h-32 text-base resize-none focus:outline-none placeholder-slate-300 leading-relaxed" placeholder="åˆ†äº«ä½ çš„æ‰©åˆ—å®£è¨€..."></textarea>
            <div class="flex flex-wrap gap-3 mb-8">
                <div v-for="(img, idx) in postForm.images" :key="idx" class="w-24 h-24 rounded-2xl bg-slate-50 relative overflow-hidden border border-slate-100">
                    <img :src="img" class="w-full h-full object-cover">
                    <button @click="removeImage(idx)" class="absolute top-1 right-1 w-6 h-6 bg-black/50 rounded-full text-white flex items-center justify-center text-sm backdrop-blur-sm"><i class="ri-close-line"></i></button>
                </div>
                <div v-if="postForm.images.length < 3" @click="$refs.postImgInput.click()" class="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-300 cursor-pointer bg-slate-50">
                    <i class="ri-image-add-line text-2xl"></i>
                </div>
                <input type="file" ref="postImgInput" hidden accept="image/*" @change="handlePostImageUpload">
            </div>
            <div class="space-y-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 mb-3 block uppercase">åˆ†åŒº</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="g in games.slice(1)" :key="g" @click="postForm.game = g" class="px-4 py-2 rounded-xl text-xs font-bold border transition-all" :class="postForm.game === g ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200'">{{ g }}</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">è¦æ±‚ (é€‰å¡«)</label>
                    <input v-model="postForm.requirement" class="w-full bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none placeholder-slate-400" placeholder="å¦‚ï¼šè¯­éŸ³ã€ä¸å‹åŠ›...">
                </div>
            </div>
        </div>
    </div>

    <div v-if="preview.show" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center backdrop-blur-md animate-fade-in" @click="preview.show = false">
        <img :src="preview.list[preview.idx]" class="max-w-full max-h-[90vh] object-contain shadow-2xl transition-transform duration-300" @click.stop>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

    const app = createApp({
        setup() {
            const API = '/api/cp';
            const mounted = ref(false);
            const user = ref(null);
            const allPosts = ref([]);
            const loading = ref(true);
            const error = ref('');
            const scrollY = ref(0);
            const notice = ref("æ¬¢è¿æ¥åˆ° CPDD æ‰©åˆ—å°ç«™ï¼è¯·æ–‡æ˜äº¤å‹ï¼Œç¦æ­¢å‘å¸ƒè¿è§„å†…å®¹ã€‚"); // å…¬å‘Šå†…å®¹

            // çŠ¶æ€
            const showAuthModal = ref(false);
            const authMode = ref('login');
            const showPostModal = ref(false);
            const submitting = ref(false);
            const isAuthing = ref(false);
            const preview = ref({ show: false, list: [], idx: 0 });

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');
            const authForm = ref({ username: '', password: '', nickname: '', avatar: '' });
            const postForm = ref({ content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] });
            const columns = ref([[], [], []]);
            const windowWidth = ref(window.innerWidth);

            // --- æ ¸å¿ƒï¼šå®‰å…¨çš„æ•°æ®å¤„ç† ---
            const updateColumns = () => {
                if (!Array.isArray(allPosts.value)) {
                    allPosts.value = [];
                    return;
                }
                const colCount = windowWidth.value < 640 ? 1 : (windowWidth.value < 1024 ? 2 : 3);
                const newCols = Array.from({ length: colCount }, () => []);
                const filtered = filterGame.value === 'å…¨éƒ¨' ? allPosts.value : allPosts.value.filter(p => p.game === filterGame.value);
                filtered.forEach((post, index) => newCols[index % colCount].push(post));
                columns.value = newCols;
            };

            const handleResize = () => { windowWidth.value = window.innerWidth; updateColumns(); };
            watch(filterGame, updateColumns);
            watch(allPosts, updateColumns, { deep: true });

            onMounted(() => {
                document.getElementById('app-loading').style.opacity = '0';
                setTimeout(() => document.getElementById('app-loading').remove(), 500);
                mounted.value = true;

                const savedUser = localStorage.getItem('cp_user');
                try { if (savedUser) user.value = JSON.parse(savedUser); } catch(e){}
                
                window.addEventListener('scroll', () => scrollY.value = window.scrollY);
                window.addEventListener('resize', handleResize);
                fetchPosts();
            });

            const fetchPosts = async () => {
                loading.value = true;
                error.value = '';
                try {
                    const res = await fetch(API);
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        allPosts.value = data;
                    } else {
                        throw new Error(data.error || 'æ•°æ®æ ¼å¼å¼‚å¸¸');
                    }
                } catch(e) {
                    console.error(e);
                    error.value = 'ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                    allPosts.value = []; // ç¡®ä¿ä¸å´©æºƒ
                }
                loading.value = false;
                updateColumns();
            };

            // --- ä¿®å¤çš„ç‚¹èµé€»è¾‘ ---
            const isLiked = (post) => {
                if (!post.likedIds) return false;
                if (user.value) return post.likedIds.includes(`user:${user.value.username}`);
                const localLikes = JSON.parse(localStorage.getItem('cp_likes') || '[]');
                return localLikes.includes(post.id);
            };

            const handleLike = async (post) => {
                if (post.liking) return;
                post.liking = true; // é”å®šæŒ‰é’®

                // ä¹è§‚æ›´æ–°
                const wasLiked = isLiked(post);
                if (wasLiked) {
                    post.likes = Math.max(0, post.likes - 1);
                    if (!user.value) {
                        const locals = JSON.parse(localStorage.getItem('cp_likes') || '[]');
                        localStorage.setItem('cp_likes', JSON.stringify(locals.filter(id => id !== post.id)));
                        post.likedIds = []; // æ¸¸å®¢æ¨¡å¼ç®€å•å¤„ç†
                    } else {
                        post.likedIds = post.likedIds.filter(id => id !== `user:${user.value.username}`);
                    }
                } else {
                    post.likes++;
                    if (!user.value) {
                        const locals = JSON.parse(localStorage.getItem('cp_likes') || '[]');
                        if(!locals.includes(post.id)) locals.push(post.id);
                        localStorage.setItem('cp_likes', JSON.stringify(locals));
                        if(!post.likedIds) post.likedIds = [];
                        post.likedIds.push('temp');
                    } else {
                        if(!post.likedIds) post.likedIds = [];
                        post.likedIds.push(`user:${user.value.username}`);
                    }
                }

                try {
                    await fetch(`${API}?action=like`, { method: 'POST', body: JSON.stringify({ id: post.id, user: user.value }) });
                } catch (e) {
                    // å¤±è´¥å›æ»š
                    if (wasLiked) post.likes++; else post.likes--;
                    alert('ç‚¹èµå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                post.liking = false; // è§£é”
            };

            // --- å›¾ç‰‡å¤„ç† ---
            const compressImage = (file, width) => new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > width) { h *= width/w; w = width; }
                        if (h > width) { w *= width/h; h = width; } // é™åˆ¶é«˜åº¦ä¹Ÿé˜²æ­¢è¿‡é•¿
                        cvs.width = w; cvs.height = h;
                        cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(cvs.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            const handleAvatarUpload = async (e) => {
                if(e.target.files[0]) authForm.value.avatar = await compressImage(e.target.files[0], 200);
            };
            const handlePostImageUpload = async (e) => {
                if(e.target.files[0] && postForm.value.images.length < 3) {
                    postForm.value.images.push(await compressImage(e.target.files[0], 800));
                }
                e.target.value = '';
            };

            // --- å…¶ä»–åŠŸèƒ½ ---
            const handleAuth = async () => {
                isAuthing.value = true;
                try {
                    const res = await fetch(`${API}?action=${authMode.value}`, { method: 'POST', body: JSON.stringify(authForm.value) });
                    const data = await res.json();
                    if (data.error) alert(data.error);
                    else {
                        user.value = data.user;
                        localStorage.setItem('cp_user', JSON.stringify(data.user));
                        showAuthModal.value = false;
                    }
                } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
                isAuthing.value = false;
            };

            const submitPost = async () => {
                if (!postForm.value.content) return alert('è¯·è¾“å…¥å†…å®¹');
                submitting.value = true;
                try {
                    const res = await fetch(`${API}?action=create_post`, { method: 'POST', body: JSON.stringify({ user: user.value, ...postForm.value }) });
                    if (res.ok) {
                        showPostModal.value = false;
                        postForm.value = { content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] };
                        fetchPosts();
                    } else alert('å‘å¸ƒå¤±è´¥');
                } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
                submitting.value = false;
            };

            const deletePost = async (id) => {
                if(!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
                await fetch(`${API}?action=delete_post`, { method: 'POST', body: JSON.stringify({ id, user: user.value }) });
                fetchPosts();
            };

            const toggleComments = async (post) => {
                post.showComments = !post.showComments;
                if (post.showComments && !post.loaded) {
                    post.loadingComments = true;
                    try {
                        const res = await fetch(`${API}?action=get_comments&postId=${post.id}`);
                        post.commentList = await res.json();
                        post.loaded = true;
                    } catch(e){}
                    post.loadingComments = false;
                }
            };
            
            const submitComment = async (post) => {
                if (!user.value) return showAuthModal.value = true;
                if (!post.newCommentInput) return;
                const txt = post.newCommentInput;
                post.newCommentInput = ''; // ç«‹å³æ¸…ç©ºä¼˜åŒ–ä½“éªŒ
                const temp = { id: Date.now(), nickname: user.value.nickname, avatar: user.value.avatar, content: txt };
                if(!post.commentList) post.commentList = [];
                post.commentList.push(temp);
                post.commentsCount = (post.commentsCount||0)+1;
                
                await fetch(`${API}?action=add_comment`, { method: 'POST', body: JSON.stringify({ postId: post.id, user: user.value, content: txt }) });
            };

            const deleteComment = async (post, cid) => {
                if(!confirm('åˆ è¯„è®ºï¼Ÿ')) return;
                await fetch(`${API}?action=delete_comment`, { method: 'POST', body: JSON.stringify({ postId: post.id, commentId: cid, user: user.value }) });
                post.commentList = post.commentList.filter(c => c.id !== cid);
                post.commentsCount--;
            };

            const changeFilter = (g) => filterGame.value = g;
            const logout = () => { user.value = null; localStorage.removeItem('cp_user'); };
            const checkAuthAndPost = () => user.value ? showPostModal.value = true : showAuthModal.value = true;
            const removeImage = (i) => postForm.value.images.splice(i, 1);
            const previewImage = (list, i) => preview.value = { show: true, list, idx: i };
            const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

            return {
                mounted, user, columns, loading, error, games, filterGame, notice,
                showAuthModal, authMode, authForm, isAuthing,
                showPostModal, postForm, submitting, preview, scrollY,
                refresh: fetchPosts, logout, handleAuth, handleAvatarUpload,
                checkAuthAndPost, handlePostImageUpload, removeImage, submitPost,
                isLiked, handleLike, toggleComments, submitComment,
                deletePost, deleteComment, changeFilter, previewImage, scrollToTop
            };
        }
    });
    
    // å…¨å±€é”™è¯¯æ‹¦æˆª
    app.config.errorHandler = (err) => {
        console.error("Global Vue Error:", err);
        // å¯ä»¥é€‰æ‹©å¼¹çª—æç¤ºç”¨æˆ·åˆ·æ–°
    };
    
    app.mount('#app');
</script>
</body>
</html>
