<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body { background-color: #fff0f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* æ¸¸æˆæ ‡ç­¾è‰² */
        .tag-wzry { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .tag-ys { background: #f0f9ff; color: #0369a1; border: 1px solid #e0f2fe; }
        .tag-lol { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .img-grid-1 { grid-template-columns: 1fr; }
        .img-grid-2 { grid-template-columns: 1fr 1fr; }
        .img-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    </style>
</head>
<body>

<div id="app" class="max-w-2xl mx-auto min-h-screen pb-24 relative bg-gray-50 shadow-xl">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-pink-100 px-4 h-14 flex items-center justify-between">
        <div class="flex items-center gap-2" @click="refresh">
            <span class="text-2xl">ğŸ€</span>
            <h1 class="text-lg font-bold text-slate-800">CPDDæ‰©åˆ—</h1>
        </div>
        <div v-if="user" class="flex items-center gap-2">
            <img :src="user.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+user.username" class="w-8 h-8 rounded-full border border-pink-200 bg-pink-50">
            <button @click="logout" class="text-xs text-slate-400">é€€å‡º</button>
        </div>
        <button v-else @click="showAuthModal = true" class="text-sm font-bold text-pink-500 bg-pink-50 px-3 py-1 rounded-full">
            ç™»å½•/æ³¨å†Œ
        </button>
    </header>

    <!-- ç­›é€‰ -->
    <div class="px-4 py-3 bg-white border-b border-slate-50 overflow-x-auto hide-scrollbar flex gap-2">
        <button v-for="g in games" :key="g" @click="filterGame = g"
            class="whitespace-nowrap px-3 py-1 rounded-full text-xs transition-all border"
            :class="filterGame === g ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'">
            {{ g }}
        </button>
    </div>

    <!-- å¸–å­åˆ—è¡¨ -->
    <main class="p-4 space-y-4">
        <div v-if="loading" class="text-center py-10 text-slate-300"><i class="ri-loader-4-line animate-spin text-2xl"></i></div>
        
        <div v-for="post in filteredPosts" :key="post.id" class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
            <!-- å¸–å­å¤´éƒ¨ -->
            <div class="flex gap-3 mb-3">
                <div class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden flex-shrink-0">
                    <img :src="post.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+post.username" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-slate-800 text-sm">{{ post.nickname }}</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-slate-100 text-slate-500">{{ post.game }}</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-0.5">{{ post.timeStr }}</p>
                </div>
            </div>

            <!-- å¸–å­å†…å®¹ -->
            <div class="text-sm text-slate-700 mb-3 leading-relaxed whitespace-pre-wrap">{{ post.desc }}</div>
            <div v-if="post.requirement" class="text-sm text-pink-500 mb-3 bg-pink-50 p-2 rounded-lg">
                <span class="font-bold">âœ¨ æ‰©åˆ—è¦æ±‚ï¼š</span>{{ post.requirement }}
            </div>

            <!-- å›¾ç‰‡å±•ç¤º (1-3å¼ ) -->
            <div v-if="post.images && post.images.length" class="grid gap-1 mb-3 rounded-lg overflow-hidden"
                 :class="'img-grid-' + (post.images.length > 3 ? 3 : post.images.length)">
                <div v-for="(img, idx) in post.images" :key="idx" 
                     class="aspect-square bg-slate-100 cursor-pointer overflow-hidden"
                     @click="previewImage(img)">
                    <img :src="img" class="w-full h-full object-cover hover:scale-105 transition-transform duration-500">
                </div>
            </div>

            <!-- åº•éƒ¨æŒ‰é’® -->
            <div class="flex items-center justify-between pt-3 border-t border-slate-50">
                <button @click="toggleComments(post)" class="flex items-center gap-1 text-sm text-slate-500 hover:text-slate-800">
                    <i class="ri-chat-3-line"></i> {{ post.commentsCount || 0 }}
                </button>
                <button @click="likePost(post)" class="flex items-center gap-1 text-sm transition-colors" 
                        :class="post.likedLocal ? 'text-pink-500' : 'text-slate-400'">
                    <i :class="post.likedLocal ? 'ri-heart-fill' : 'ri-heart-line'"></i> {{ post.likes + (post.likedLocal ? 1 : 0) }}
                </button>
            </div>

            <!-- è¯„è®ºåŒº (å±•å¼€æ—¶æ˜¾ç¤º) -->
            <div v-if="post.showComments" class="mt-4 pt-4 border-t border-dashed border-slate-200 bg-slate-50 -mx-4 px-4 pb-2 animate-in fade-in slide-in-from-top-2">
                <div v-if="post.loadingComments" class="text-center text-xs text-slate-400 py-2">åŠ è½½è¯„è®ºä¸­...</div>
                <div v-else class="space-y-3 mb-4">
                    <div v-if="!post.comments || post.comments.length === 0" class="text-center text-xs text-slate-300 py-2">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘</div>
                    <div v-for="cmt in post.comments" :key="cmt.id" class="flex gap-2 text-xs">
                        <span class="font-bold text-slate-600 whitespace-nowrap">{{ cmt.nickname }}:</span>
                        <span class="text-slate-700 break-all">{{ cmt.content }}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input v-model="post.newComment" placeholder="å›ç‚¹ä»€ä¹ˆ..." class="flex-1 bg-white border border-slate-200 rounded-full px-3 py-1.5 text-xs focus:outline-none focus:border-pink-300">
                    <button @click="submitComment(post)" class="bg-slate-800 text-white text-xs px-3 py-1 rounded-full font-bold">å‘é€</button>
                </div>
            </div>
        </div>
    </main>

    <!-- æ‚¬æµ®å‘å¸ƒæŒ‰é’® -->
    <button @click="checkAuthAndPost" class="fixed bottom-6 right-6 bg-gradient-to-r from-pink-500 to-purple-500 text-white w-12 h-12 rounded-full shadow-lg shadow-pink-200 flex items-center justify-center text-2xl active:scale-90 transition-transform z-30">
        <i class="ri-add-line"></i>
    </button>

    <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <div class="flex text-sm font-bold border-b">
                <button @click="authMode='login'" class="flex-1 py-3 transition-colors" :class="authMode==='login'?'text-pink-500 border-b-2 border-pink-500':'text-slate-400'">ç™»å½•</button>
                <button @click="authMode='register'" class="flex-1 py-3 transition-colors" :class="authMode==='register'?'text-pink-500 border-b-2 border-pink-500':'text-slate-400'">æ³¨å†Œæ–°è´¦å·</button>
            </div>
            <div class="p-6 space-y-4">
                <div v-if="authMode==='register'" class="flex justify-center mb-2">
                     <div class="w-16 h-16 rounded-full bg-slate-50 border border-dashed border-slate-300 flex items-center justify-center relative overflow-hidden cursor-pointer" @click="$refs.avatarInput.click()">
                        <img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover">
                        <i v-else class="ri-camera-line text-slate-300 text-xl"></i>
                        <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
                     </div>
                </div>
                <input v-model="authForm.username" placeholder="ç”¨æˆ·å (è´¦å·)" class="w-full bg-slate-50 border-none rounded-lg px-4 py-2 text-sm">
                <input v-model="authForm.password" type="password" placeholder="å¯†ç " class="w-full bg-slate-50 border-none rounded-lg px-4 py-2 text-sm">
                <input v-if="authMode==='register'" v-model="authForm.nickname" placeholder="ä½ çš„æ˜µç§°" class="w-full bg-slate-50 border-none rounded-lg px-4 py-2 text-sm">
                
                <button @click="handleAuth" :disabled="isAuthing" class="w-full bg-pink-500 text-white font-bold py-2 rounded-lg shadow-md disabled:opacity-50">
                    {{ isAuthing ? 'å¤„ç†ä¸­...' : (authMode==='login'?'ç™» å½•':'æ³¨ å†Œ') }}
                </button>
            </div>
            <button @click="showAuthModal = false" class="w-full py-3 text-slate-400 text-xs border-t">æš‚ä¸ç™»å½•ï¼Œéšä¾¿çœ‹çœ‹</button>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-slate-100">
            <button @click="showPostModal = false" class="text-slate-500">å–æ¶ˆ</button>
            <h3 class="font-bold text-slate-800">å‘å¸ƒæ‰©åˆ—</h3>
            <button @click="submitPost" :disabled="submitting" class="bg-pink-500 text-white px-4 py-1 rounded-full text-sm font-bold disabled:opacity-50">
                {{ submitting ? 'å‘å¸ƒä¸­' : 'å‘å¸ƒ' }}
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <textarea v-model="postForm.content" class="w-full h-32 text-sm resize-none focus:outline-none placeholder-slate-300" placeholder="ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ï¼Œå£°éŸ³ã€æ€§æ ¼ã€æ“…é•¿ä½ç½®..."></textarea>
            
            <!-- å›¾ç‰‡ä¸Šä¼ åŒº (æœ€å¤š3å¼ ) -->
            <div class="flex gap-2 mb-4">
                <div v-for="(img, idx) in postForm.images" :key="idx" class="w-20 h-20 rounded-lg bg-slate-100 relative overflow-hidden group">
                    <img :src="img" class="w-full h-full object-cover">
                    <button @click="removeImage(idx)" class="absolute top-0 right-0 bg-black/50 text-white w-5 h-5 flex items-center justify-center rounded-bl-lg text-xs">&times;</button>
                </div>
                <div v-if="postForm.images.length < 3" @click="$refs.postImgInput.click()" class="w-20 h-20 rounded-lg border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-300 cursor-pointer active:bg-slate-50">
                    <i class="ri-image-add-line text-xl"></i>
                    <span class="text-[10px]">æ·»åŠ å›¾ç‰‡</span>
                </div>
                <input type="file" ref="postImgInput" hidden accept="image/*" @change="handlePostImageUpload">
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-1">ç©ä»€ä¹ˆæ¸¸æˆ</label>
                    <select v-model="postForm.game" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm border-none outline-none">
                        <option v-for="g in games.slice(1)" :key="g">{{ g }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-1">å¯¹CP/é˜Ÿå‹çš„è¦æ±‚</label>
                    <input v-model="postForm.requirement" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm border-none outline-none" placeholder="æ¯”å¦‚ï¼šä¸å‹åŠ›ï¼Œå¿ƒæ€å¥½...">
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆå¤§å›¾ -->
    <div v-if="previewImg" @click="previewImg=null" class="fixed inset-0 z-[60] bg-black flex items-center justify-center">
        <img :src="previewImg" class="max-w-full max-h-full">
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const posts = ref([]);
            const loading = ref(true);
            
            // çŠ¶æ€
            const showAuthModal = ref(false);
            const authMode = ref('login'); // login | register
            const showPostModal = ref(false);
            const submitting = ref(false);
            const isAuthing = ref(false);
            const previewImg = ref(null);

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');

            // è¡¨å•
            const authForm = ref({ username: '', password: '', nickname: '', avatar: '' });
            const postForm = ref({ content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] });

            // åˆå§‹åŒ–
            onMounted(() => {
                const saved = localStorage.getItem('cp_user');
                if (saved) user.value = JSON.parse(saved);
                fetchPosts();
            });

            const refresh = () => fetchPosts();
            const logout = () => { user.value = null; localStorage.removeItem('cp_user'); };

            // --- å›¾ç‰‡å‹ç¼©é€»è¾‘ (æ ¸å¿ƒ) ---
            const compressImage = (file, maxWidth = 800, quality = 0.6) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width;
                            let h = img.height;
                            if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                            canvas.width = w;
                            canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            // è¾“å‡º compressed base64
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            // --- é‰´æƒé€»è¾‘ ---
            const handleAvatarUpload = async (e) => {
                if(e.target.files[0]) authForm.value.avatar = await compressImage(e.target.files[0], 200, 0.5); // å¤´åƒå‹ç¼©ç‹ ä¸€ç‚¹
            };
            
            const handleAuth = async () => {
                if (!authForm.value.username || !authForm.value.password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');
                isAuthing.value = true;
                try {
                    const res = await fetch(`${API}?action=${authMode.value}`, {
                        method: 'POST',
                        body: JSON.stringify(authForm.value)
                    });
                    const data = await res.json();
                    if (data.error) {
                        alert(data.error);
                    } else {
                        user.value = data.user;
                        localStorage.setItem('cp_user', JSON.stringify(data.user));
                        showAuthModal.value = false;
                        // å¦‚æœæ˜¯ç™»å½•åï¼Œé‡ç½®è¡¨å•
                        authForm.value = { username: '', password: '', nickname: '', avatar: '' };
                    }
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
                isAuthing.value = false;
            };

            // --- å¸–å­é€»è¾‘ ---
            const fetchPosts = async () => {
                loading.value = true;
                try {
                    const res = await fetch(API);
                    posts.value = await res.json();
                } catch(e) {}
                loading.value = false;
            };

            const checkAuthAndPost = () => {
                if (!user.value) {
                    showAuthModal.value = true;
                } else {
                    showPostModal.value = true;
                }
            };

            const handlePostImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (postForm.value.images.length >= 3) return alert('æœ€å¤š3å¼ å“¦');
                // å‹ç¼©åˆ°å®½800ï¼Œè´¨é‡0.5ï¼Œé€šå¸¸<100KB
                const base64 = await compressImage(file, 800, 0.5);
                postForm.value.images.push(base64);
                // æ¸…ç©ºinputå…è®¸é‡å¤é€‰åŒä¸€å¼ ï¼ˆå¦‚æœåˆ é™¤äº†ï¼‰
                e.target.value = ''; 
            };
            
            const removeImage = (idx) => postForm.value.images.splice(idx, 1);

            const submitPost = async () => {
                if (!postForm.value.content) return alert('è¯´ç‚¹ä»€ä¹ˆå§');
                submitting.value = true;
                try {
                    const payload = {
                        user: user.value,
                        ...postForm.value
                    };
                    const res = await fetch(`${API}?action=create_post`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        showPostModal.value = false;
                        postForm.value = { content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] };
                        fetchPosts();
                    } else {
                        const err = await res.json();
                        alert(err.error || 'å‘å¸ƒå¤±è´¥ï¼Œå›¾ç‰‡å¯èƒ½å¤ªå¤§äº†');
                    }
                } catch (e) { alert('å‘å¸ƒå¤±è´¥'); }
                submitting.value = false;
            };

            // --- äº’åŠ¨é€»è¾‘ ---
            const likePost = async (post) => {
                if(post.likedLocal) return;
                post.likedLocal = true;
                post.likes++;
                await fetch(`${API}?action=like`, { method: 'POST', body: JSON.stringify({ id: post.id }) });
            };

            const toggleComments = async (post) => {
                post.showComments = !post.showComments;
                if (post.showComments && !post.commentsLoaded) {
                    post.loadingComments = true;
                    try {
                        const res = await fetch(`${API}?action=get_comments&postId=${post.id}`);
                        post.comments = await res.json();
                        post.commentsLoaded = true;
                    } catch(e){}
                    post.loadingComments = false;
                }
            };

            const submitComment = async (post) => {
                if (!user.value) return showAuthModal.value = true;
                if (!post.newComment) return;
                
                const tempComment = {
                    id: Date.now(),
                    nickname: user.value.nickname,
                    content: post.newComment
                };
                
                // ä¹è§‚æ›´æ–°
                if (!post.comments) post.comments = [];
                post.comments.push(tempComment);
                post.commentsCount = (post.commentsCount || 0) + 1;
                
                const txt = post.newComment;
                post.newComment = '';

                await fetch(`${API}?action=add_comment`, {
                    method: 'POST',
                    body: JSON.stringify({
                        postId: post.id,
                        user: user.value,
                        content: txt
                    })
                });
            };
            
            const previewImage = (src) => previewImg.value = src;

            const filteredPosts = computed(() => {
                if (filterGame.value === 'å…¨éƒ¨') return posts.value;
                return posts.value.filter(p => p.game === filterGame.value);
            });

            return {
                user, posts, loading, games, filterGame, filteredPosts,
                showAuthModal, authMode, authForm, isAuthing,
                showPostModal, postForm, submitting, previewImg,
                refresh, logout, handleAuth, handleAvatarUpload,
                checkAuthAndPost, handlePostImageUpload, removeImage, submitPost,
                likePost, toggleComments, submitComment, previewImage
            };
        }
    }).mount('#app');
</script>
</body>
</html>
