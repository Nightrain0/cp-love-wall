<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* --- å…¨å±€ç¾åŒ– --- */
        body { 
            background: #fdf2f8; 
            background-image: radial-gradient(circle at 10% 20%, rgb(254, 242, 242) 0%, rgb(255, 241, 242) 90.2%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* åŠ¨ç”»ç±» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .slide-up-enter-from { transform: translateY(20px); opacity: 0; }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px -2px rgba(236, 72, 153, 0.05), 0 2px 6px -2px rgba(0,0,0,0.02);
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .game-tag { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 600; letter-spacing: 0.5px; }
        .tag-common { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .tag-active { background: #1e293b; color: #fff; border: 1px solid #1e293b; box-shadow: 0 2px 8px rgba(30,41,59,0.2); }

        /* å›¾ç‰‡ç½‘æ ¼ */
        .img-grid-1 { grid-template-columns: 1fr; }
        .img-grid-2 { grid-template-columns: 1fr 1fr; }
        .img-grid-3 { grid-template-columns: repeat(3, 1fr); }

        /* åº•éƒ¨å®‰å…¨åŒºé€‚é… */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .bottom-safe-margin { margin-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

<div id="app" class="max-w-2xl mx-auto min-h-screen pb-32 relative">
    
    <!-- é¡¶éƒ¨å¯¼èˆª (æ¯›ç»ç’ƒ) -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-lg border-b border-pink-100/50 px-4 h-14 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-2 cursor-pointer" @click="refresh">
            <div class="bg-gradient-to-tr from-pink-400 to-purple-400 w-8 h-8 rounded-xl flex items-center justify-center text-white shadow-md shadow-pink-200">
                <i class="ri-star-smile-fill"></i>
            </div>
            <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-purple-600">
                CPDDæ‰©åˆ—
            </h1>
        </div>
        <div v-if="user" class="flex items-center gap-3">
            <div class="flex flex-col items-end">
                <span class="text-xs font-bold text-slate-700">{{ user.nickname }}</span>
                <span v-if="user.isAdmin" class="text-[10px] bg-red-500 text-white px-1 rounded leading-tight">ADMIN</span>
            </div>
            <img :src="user.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+user.username" class="w-9 h-9 rounded-full border-2 border-white shadow-sm bg-pink-50">
            <button @click="logout" class="text-slate-400 hover:text-pink-500 transition-colors"><i class="ri-logout-box-r-line text-lg"></i></button>
        </div>
        <button v-else @click="showAuthModal = true" class="text-xs font-bold text-white bg-gradient-to-r from-pink-500 to-purple-500 px-4 py-1.5 rounded-full shadow-md shadow-pink-200 active:scale-95 transition-transform">
            ç™»å½• / æ³¨å†Œ
        </button>
    </header>

    <!-- æ¸¸æˆç­›é€‰æ  -->
    <div class="sticky top-14 z-30 bg-white/90 backdrop-blur-md border-b border-slate-50 px-4 py-3 overflow-x-auto hide-scrollbar">
        <div class="flex gap-2">
            <button v-for="g in games" :key="g" @click="filterGame = g"
                class="game-tag whitespace-nowrap transition-all duration-300"
                :class="filterGame === g ? 'tag-active' : 'tag-common'">
                {{ g }}
            </button>
        </div>
    </div>

    <!-- å¸–å­åˆ—è¡¨ -->
    <main class="p-4 space-y-5">
        <div v-if="loading" class="text-center py-20">
            <div class="inline-block animate-bounce text-3xl mb-2">ğŸ¡</div>
            <p class="text-sm text-slate-400 font-medium">æ­£åœ¨åŠ è½½å¥½æœ‹å‹...</p>
        </div>
        
        <transition-group name="slide-up">
            <div v-for="post in filteredPosts" :key="post.id" class="glass-card rounded-2xl p-5 transition-all hover:translate-y-[-2px]">
                <!-- å¤´éƒ¨ -->
                <div class="flex justify-between items-start mb-3">
                    <div class="flex gap-3">
                        <div class="w-11 h-11 rounded-full bg-slate-100 p-0.5 shadow-sm">
                            <img :src="post.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+post.username" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-800">{{ post.nickname }}</span>
                                <span class="game-tag bg-pink-50 text-pink-500 border-pink-100">{{ post.game }}</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-0.5 flex items-center gap-1">
                                <i class="ri-time-line"></i> {{ post.timeStr }}
                            </p>
                        </div>
                    </div>
                    <!-- â˜… ç®¡ç†å‘˜åˆ é™¤æŒ‰é’® -->
                    <button v-if="user && user.isAdmin" @click="deletePost(post)" class="text-xs bg-red-50 text-red-500 px-2 py-1 rounded hover:bg-red-100 font-bold transition-colors">
                        åˆ é™¤
                    </button>
                </div>

                <!-- æ–‡æ¡ˆ -->
                <div class="text-[15px] text-slate-700 mb-3 leading-relaxed tracking-wide whitespace-pre-wrap">{{ post.desc }}</div>
                
                <!-- è¦æ±‚ -->
                <div v-if="post.requirement" class="mb-4 bg-gradient-to-r from-pink-50/80 to-purple-50/80 p-3 rounded-xl border border-pink-100/50">
                    <p class="text-xs font-bold text-pink-500 mb-1"><i class="ri-magic-line"></i> å¯»æ‰¾é˜Ÿå‹</p>
                    <p class="text-xs text-slate-600 leading-relaxed">{{ post.requirement }}</p>
                </div>

                <!-- å›¾ç‰‡å¢™ (ç”»è´¨æå‡) -->
                <div v-if="post.images && post.images.length" class="grid gap-1.5 mb-4 rounded-xl overflow-hidden"
                     :class="'img-grid-' + (post.images.length > 3 ? 3 : post.images.length)">
                    <div v-for="(img, idx) in post.images" :key="idx" 
                         class="aspect-square bg-slate-100 cursor-zoom-in overflow-hidden relative group"
                         @click="previewImage(post.images, idx)">
                        <img :src="img" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                    </div>
                </div>

                <!-- åº•éƒ¨æ  -->
                <div class="flex items-center justify-between pt-3 border-t border-slate-100/50">
                    <button @click="toggleComments(post)" class="flex items-center gap-1.5 text-slate-400 hover:text-slate-600 transition-colors group">
                        <div class="p-1.5 rounded-full group-hover:bg-slate-100 transition-colors">
                            <i class="ri-chat-3-line text-lg"></i>
                        </div>
                        <span class="text-xs font-bold">{{ post.commentsCount || 0 }}</span>
                    </button>
                    
                    <button @click="likePost(post)" class="flex items-center gap-1.5 transition-colors group">
                        <div class="p-1.5 rounded-full group-hover:bg-pink-50 transition-colors" 
                             :class="isLiked(post.id) ? 'text-pink-500' : 'text-slate-400'">
                            <i :class="isLiked(post.id) ? 'ri-heart-fill' : 'ri-heart-line'" class="text-lg transition-transform active:scale-125"></i>
                        </div>
                        <span class="text-xs font-bold" :class="isLiked(post.id) ? 'text-pink-500' : 'text-slate-400'">
                            {{ post.likes + (isLiked(post.id) && !post.serverLiked ? 1 : 0) }}
                        </span>
                    </button>
                </div>

                <!-- è¯„è®ºåŒº -->
                <div v-if="post.showComments" class="mt-4 pt-3 animate-fade-in bg-slate-50/50 rounded-xl p-3 border border-slate-100">
                    <div v-if="post.loadingComments" class="text-center text-xs text-slate-400 py-2">åŠ è½½ä¸­...</div>
                    <div v-else>
                        <div v-if="!post.comments || post.comments.length === 0" class="text-center text-xs text-slate-300 py-4">
                            (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) è¿˜æ²¡æœ‰äººç†ta...
                        </div>
                        <div class="space-y-2 mb-3 max-h-40 overflow-y-auto custom-scrollbar">
                            <div v-for="cmt in post.comments" :key="cmt.id" class="flex gap-2 text-xs group">
                                <span class="font-bold text-slate-600 whitespace-nowrap">{{ cmt.nickname }}:</span>
                                <span class="text-slate-700 break-all leading-relaxed">{{ cmt.content }}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <img :src="user?.avatar || 'https://api.dicebear.com/7.x/avataaars/svg'" class="w-6 h-6 rounded-full border bg-white">
                            <input v-model="post.newComment" 
                                   placeholder="ç¤¼è²Œæ‰©åˆ—ï¼Œä»ä¸€å¥ä½ å¥½å¼€å§‹..." 
                                   class="flex-1 bg-white border-none rounded-full px-4 py-2 text-xs shadow-sm focus:ring-2 focus:ring-pink-200 outline-none transition-all">
                            <button @click="submitComment(post)" class="text-pink-500 font-bold text-xs px-2">å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition-group>
    </main>

    <!-- æ‚¬æµ®å‘å¸ƒæŒ‰é’® (é€‚é… iPhone åº•éƒ¨å®‰å…¨åŒº) -->
    <div class="fixed bottom-6 right-6 z-30 bottom-safe-margin">
        <button @click="checkAuthAndPost" class="bg-slate-900 text-white w-14 h-14 rounded-full shadow-xl shadow-slate-300 flex items-center justify-center text-2xl active:scale-90 transition-transform hover:rotate-90 hover:bg-black">
            <i class="ri-add-line"></i>
        </button>
    </div>

    <!-- è®¤è¯å¼¹çª— -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/30 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-xs rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="flex text-sm font-bold bg-slate-50 p-1 m-4 rounded-xl relative">
                <div class="absolute top-1 bottom-1 bg-white rounded-lg shadow-sm transition-all duration-300 w-1/2" :style="{left: authMode==='login'?'4px':'50%'}"></div>
                <button @click="authMode='login'" class="flex-1 py-2 relative z-10 transition-colors" :class="authMode==='login'?'text-slate-800':'text-slate-400'">ç™»å½•</button>
                <button @click="authMode='register'" class="flex-1 py-2 relative z-10 transition-colors" :class="authMode==='register'?'text-slate-800':'text-slate-400'">æ³¨å†Œ</button>
            </div>
            
            <div class="px-6 pb-6 space-y-4">
                <div v-if="authMode==='register'" class="flex justify-center">
                     <div class="w-20 h-20 rounded-full bg-slate-50 border-2 border-dashed border-pink-200 flex flex-col items-center justify-center text-pink-300 cursor-pointer relative overflow-hidden group hover:border-pink-400 transition-colors" @click="$refs.avatarInput.click()">
                        <img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover">
                        <div v-else class="flex flex-col items-center">
                            <i class="ri-camera-fill text-2xl"></i>
                            <span class="text-[10px] mt-1">ä¼ å¤´åƒ</span>
                        </div>
                        <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
                     </div>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-slate-50 rounded-xl px-4 py-2 border border-slate-100 focus-within:border-pink-300 focus-within:bg-white transition-colors">
                        <input v-model="authForm.username" placeholder="ç”¨æˆ·å / è´¦å·" class="w-full bg-transparent text-sm outline-none placeholder-slate-400">
                    </div>
                    <div class="bg-slate-50 rounded-xl px-4 py-2 border border-slate-100 focus-within:border-pink-300 focus-within:bg-white transition-colors">
                        <input v-model="authForm.password" type="password" placeholder="è®¾ç½®å¯†ç " class="w-full bg-transparent text-sm outline-none placeholder-slate-400">
                    </div>
                    <div v-if="authMode==='register'" class="bg-slate-50 rounded-xl px-4 py-2 border border-slate-100 focus-within:border-pink-300 focus-within:bg-white transition-colors">
                        <input v-model="authForm.nickname" placeholder="æ€ä¹ˆç§°å‘¼ä½  (æ˜µç§°)" class="w-full bg-transparent text-sm outline-none placeholder-slate-400">
                    </div>
                </div>
                
                <button @click="handleAuth" :disabled="isAuthing" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-200 active:scale-95 transition-transform disabled:opacity-70">
                    {{ isAuthing ? 'å¤„ç†ä¸­...' : (authMode==='login'?'âœ¨ ç™» å½•':'ğŸš€ æ³¨ å†Œ') }}
                </button>
                <p class="text-center text-xs text-slate-400 mt-2 cursor-pointer hover:text-pink-400" @click="showAuthModal=false">å…ˆé€›é€›ï¼Œä»¥åå†è¯´</p>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— (å…¨å±æ¨¡å¼) -->
    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col animate-fade-in">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
            <button @click="showPostModal = false" class="text-slate-500 px-2 py-1 rounded-full hover:bg-slate-100">å–æ¶ˆ</button>
            <h3 class="font-bold text-slate-800 text-lg">âœ¨ å‘å¸ƒåŠ¨æ€</h3>
            <button @click="submitPost" :disabled="submitting" class="bg-slate-900 text-white px-5 py-1.5 rounded-full text-sm font-bold disabled:opacity-50 transition-colors">
                {{ submitting ? 'å‘é€ä¸­' : 'å‘å¸ƒ' }}
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5 pb-20">
            <textarea v-model="postForm.content" class="w-full h-32 text-[15px] resize-none focus:outline-none placeholder-slate-300 leading-relaxed" placeholder="åˆ†äº«ä½ çš„æ¸¸æˆæ—¥å¸¸ï¼Œå¯»æ‰¾ä½ çš„å›ºç©CP..."></textarea>
            
            <!-- å›¾ç‰‡åˆ—è¡¨ -->
            <div class="flex flex-wrap gap-3 mb-6">
                <div v-for="(img, idx) in postForm.images" :key="idx" class="w-24 h-24 rounded-xl bg-slate-100 relative overflow-hidden group border border-slate-200">
                    <img :src="img" class="w-full h-full object-cover">
                    <button @click="removeImage(idx)" class="absolute top-1 right-1 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm backdrop-blur-sm">
                        <i class="ri-close-line"></i>
                    </button>
                    <div class="absolute bottom-0 left-0 right-0 bg-black/40 text-white text-[9px] text-center py-0.5 backdrop-blur-sm">
                        {{ getSizeKB(img) }}
                    </div>
                </div>
                
                <div v-if="postForm.images.length < 3" @click="$refs.postImgInput.click()" class="w-24 h-24 rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-300 cursor-pointer active:bg-slate-50 hover:border-pink-300 hover:text-pink-300 transition-colors">
                    <i class="ri-image-add-line text-2xl mb-1"></i>
                    <span class="text-[10px]">æ·»åŠ å›¾ç‰‡</span>
                </div>
                <input type="file" ref="postImgInput" hidden accept="image/*" @change="handlePostImageUpload">
            </div>

            <div class="space-y-5">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="text-xs font-bold text-slate-400 block mb-2 flex items-center gap-1"><i class="ri-gamepad-line"></i> å…³è”æ¸¸æˆ</label>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="g in games.slice(1)" :key="g" 
                              @click="postForm.game = g"
                              class="text-xs px-3 py-1.5 rounded-lg border transition-all cursor-pointer"
                              :class="postForm.game === g ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200'">
                            {{ g }}
                        </span>
                    </div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="text-xs font-bold text-slate-400 block mb-2 flex items-center gap-1"><i class="ri-user-heart-line"></i> æ‰©åˆ—è¦æ±‚</label>
                    <input v-model="postForm.requirement" class="w-full bg-transparent text-sm outline-none placeholder-slate-300" placeholder="æ¯”å¦‚ï¼šé‡ç‹ddï¼Œä¸å‹åŠ›ï¼Œå¿ƒæ€å¥½...">
                </div>
            </div>
            
            <!-- åº•éƒ¨æç¤º -->
            <p class="text-center text-xs text-slate-300 mt-8">è¯·æ–‡æ˜å‘è¨€ï¼Œæ‹’ç»ä¸è‰¯ä¿¡æ¯</p>
        </div>
    </div>

    <!-- å›¾ç‰‡å¤§å›¾é¢„è§ˆ (ç‚¹å‡»èƒŒæ™¯å…³é—­) -->
    <div v-if="preview.show" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center backdrop-blur-sm" @click="preview.show = false">
        <img :src="preview.list[preview.idx]" class="max-w-full max-h-screen object-contain transition-opacity duration-300" @click.stop>
        
        <!-- å·¦å³åˆ‡æ¢æŒ‰é’® -->
        <div v-if="preview.list.length > 1" class="absolute bottom-10 flex gap-4" @click.stop>
             <button v-for="(img, idx) in preview.list" :key="idx" 
                     @click="preview.idx = idx"
                     class="w-2 h-2 rounded-full transition-all"
                     :class="preview.idx === idx ? 'bg-white w-4' : 'bg-white/30'">
             </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const posts = ref([]);
            const loading = ref(true);
            const likedPostIds = ref(new Set()); // â˜… ä¿®å¤ç‚¹èµ Bugï¼šæœ¬åœ°å­˜å‚¨ç‚¹è¿‡çš„ID

            // çŠ¶æ€
            const showAuthModal = ref(false);
            const authMode = ref('login'); 
            const showPostModal = ref(false);
            const submitting = ref(false);
            const isAuthing = ref(false);
            const preview = ref({ show: false, list: [], idx: 0 });

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');

            const authForm = ref({ username: '', password: '', nickname: '', avatar: '' });
            const postForm = ref({ content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] });

            // åˆå§‹åŒ–
            onMounted(() => {
                // æ¢å¤ç”¨æˆ·
                const savedUser = localStorage.getItem('cp_user');
                if (savedUser) user.value = JSON.parse(savedUser);
                
                // â˜… æ¢å¤ç‚¹èµçŠ¶æ€
                const savedLikes = localStorage.getItem('cp_liked_ids');
                if (savedLikes) likedPostIds.value = new Set(JSON.parse(savedLikes));

                fetchPosts();
            });

            const refresh = () => fetchPosts();
            const logout = () => { user.value = null; localStorage.removeItem('cp_user'); };

            const getSizeKB = (base64Str) => {
                if (!base64Str) return '';
                return (base64Str.length * 0.75 / 1024).toFixed(1) + ' KB';
            };

            // --- â˜… ç”»è´¨å‡çº§ & æ™ºèƒ½å‹ç¼© ---
            const compressImage = (file, maxWidth = 1280, quality = 0.8) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width;
                            let h = img.height;
                            // ä¿æŒå®½é«˜æ¯”
                            if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                            if (h > maxWidth) { w *= maxWidth / h; h = maxWidth; }
                            
                            canvas.width = w;
                            canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            
                            // è¾“å‡º
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            // --- é‰´æƒ & ç®¡ç†å‘˜é€»è¾‘ ---
            const handleAvatarUpload = async (e) => {
                if(e.target.files[0]) authForm.value.avatar = await compressImage(e.target.files[0], 200, 0.7);
            };
            
            const handleAuth = async () => {
                if (!authForm.value.username || !authForm.value.password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');
                
                // ç®€å•çš„å‰ç«¯æç¤ºï¼Œå®é™…ä¸Šåç«¯ä¹Ÿä¼šåˆ¤æ–­
                if (authMode.value === 'register' && authForm.value.username === 'admin') {
                    if(!confirm("ä½ è¦æ³¨å†Œç®¡ç†å‘˜è´¦å·(admin)å—ï¼Ÿæ­¤è´¦å·æ‹¥æœ‰åˆ é™¤å¸–å­çš„æƒé™ã€‚")) return;
                }

                isAuthing.value = true;
                try {
                    const res = await fetch(`${API}?action=${authMode.value}`, {
                        method: 'POST',
                        body: JSON.stringify(authForm.value)
                    });
                    const data = await res.json();
                    if (data.error) {
                        alert(data.error);
                    } else {
                        user.value = data.user;
                        localStorage.setItem('cp_user', JSON.stringify(data.user));
                        showAuthModal.value = false;
                        authForm.value = { username: '', password: '', nickname: '', avatar: '' };
                    }
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
                isAuthing.value = false;
            };

            // --- å¸–å­é€»è¾‘ ---
            const fetchPosts = async () => {
                loading.value = true;
                try {
                    const res = await fetch(API);
                    posts.value = await res.json();
                } catch(e) {}
                loading.value = false;
            };

            const checkAuthAndPost = () => {
                if (!user.value) {
                    showAuthModal.value = true;
                } else {
                    showPostModal.value = true;
                }
            };

            const handlePostImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (postForm.value.images.length >= 3) return alert('æœ€å¤š3å¼ å“¦');
                
                // â˜… ç”»è´¨æå‡ï¼šæœ€å¤§å®½1280ï¼Œè´¨é‡0.8
                const base64 = await compressImage(file, 1280, 0.8);
                postForm.value.images.push(base64);
                e.target.value = ''; 
            };
            
            const removeImage = (idx) => postForm.value.images.splice(idx, 1);

            const submitPost = async () => {
                if (!postForm.value.content) return alert('è¯´ç‚¹ä»€ä¹ˆå§');
                
                // â˜… æ™ºèƒ½å®¹é‡æ£€æµ‹
                const totalSize = postForm.value.images.reduce((acc, img) => acc + (img.length * 0.75), 0);
                // Firestore é™åˆ¶ 1MB (1048576 bytes)ï¼Œé¢„ç•™ 100KB ç»™æ–‡å­—
                if (totalSize > 900 * 1024) { 
                     return alert(`å›¾ç‰‡å¤ªæ¸…æ™°å•¦ (æ€»å…± ${(totalSize/1024).toFixed(0)}KB)ï¼å·²è¶…è¿‡æ•°æ®åº“é™åˆ¶ï¼Œè¯·åˆ æ‰ä¸€å¼ æˆ–æ¢å°å›¾ã€‚`);
                }

                submitting.value = true;
                try {
                    const payload = { user: user.value, ...postForm.value };
                    const res = await fetch(`${API}?action=create_post`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        showPostModal.value = false;
                        postForm.value = { content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] };
                        fetchPosts();
                    } else {
                        const err = await res.json();
                        alert(err.error || 'å‘å¸ƒå¤±è´¥ï¼Œå›¾ç‰‡å¯èƒ½å¤ªå¤§äº†');
                    }
                } catch (e) { alert('å‘å¸ƒå¤±è´¥'); }
                submitting.value = false;
            };

            // --- â˜… ç®¡ç†å‘˜åˆ é™¤åŠŸèƒ½ ---
            const deletePost = async (post) => {
                if (!confirm('ç®¡ç†å‘˜æ“ä½œï¼šç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰©åˆ—å—ï¼Ÿ')) return;
                try {
                    const res = await fetch(`${API}?action=delete_post`, {
                        method: 'POST',
                        body: JSON.stringify({ id: post.id, user: user.value })
                    });
                    if (res.ok) {
                        // ä»åˆ—è¡¨ç§»é™¤
                        posts.value = posts.value.filter(p => p.id !== post.id);
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼Œæƒé™ä¸è¶³ï¼Ÿ');
                    }
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
            };

            // --- äº’åŠ¨é€»è¾‘ (ç‚¹èµ/è¯„è®º) ---
            const isLiked = (id) => likedPostIds.value.has(id);

            const likePost = async (post) => {
                if (isLiked(post.id)) return; // é¿å…é‡å¤ç‚¹èµ
                
                // ä¹è§‚æ›´æ–°
                likedPostIds.value.add(post.id);
                localStorage.setItem('cp_liked_ids', JSON.stringify([...likedPostIds.value]));
                
                // æ ‡è®°è¿™ä¸ªèµè¿˜æ²¡åŒæ­¥åˆ°æœåŠ¡å™¨(å¯é€‰)
                // UIä¸Šç›´æ¥æ˜¾ç¤º+1
                
                await fetch(`${API}?action=like`, { method: 'POST', body: JSON.stringify({ id: post.id }) });
            };

            const toggleComments = async (post) => {
                post.showComments = !post.showComments;
                if (post.showComments && !post.commentsLoaded) {
                    post.loadingComments = true;
                    try {
                        const res = await fetch(`${API}?action=get_comments&postId=${post.id}`);
                        post.comments = await res.json();
                        post.commentsLoaded = true;
                    } catch(e){}
                    post.loadingComments = false;
                }
            };

            const submitComment = async (post) => {
                if (!user.value) return showAuthModal.value = true;
                if (!post.newComment) return;
                
                const tempComment = {
                    id: Date.now(),
                    nickname: user.value.nickname,
                    content: post.newComment
                };
                
                if (!post.comments) post.comments = [];
                post.comments.push(tempComment);
                post.commentsCount = (post.commentsCount || 0) + 1;
                
                const txt = post.newComment;
                post.newComment = '';

                await fetch(`${API}?action=add_comment`, {
                    method: 'POST',
                    body: JSON.stringify({ postId: post.id, user: user.value, content: txt })
                });
            };
            
            const previewImage = (list, idx) => {
                preview.value = { show: true, list, idx };
            };

            const filteredPosts = computed(() => {
                if (filterGame.value === 'å…¨éƒ¨') return posts.value;
                return posts.value.filter(p => p.game === filterGame.value);
            });

            return {
                user, posts, loading, games, filterGame, filteredPosts,
                showAuthModal, authMode, authForm, isAuthing,
                showPostModal, postForm, submitting, preview,
                refresh, logout, handleAuth, handleAvatarUpload,
                checkAuthAndPost, handlePostImageUpload, removeImage, submitPost,
                likePost, isLiked, toggleComments, submitComment, previewImage, getSizeKB,
                deletePost // å¯¼å‡ºåˆ é™¤æ–¹æ³•
            };
        }
    }).mount('#app');
</script>
</body>
</html>
