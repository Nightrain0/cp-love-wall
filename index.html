<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <!-- ä½¿ç”¨å›½å†… CDN åŠ é€Ÿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    <link href="https://cdn.staticfile.org/remixicon/3.5.0/remixicon.css" rel="stylesheet">
    
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { 
            background-color: #f8fafc;
            background-image: linear-gradient(to bottom right, #fff1f2, #f8fafc, #f0f9ff);
            background-attachment: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #334155;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* v-cloak: VueåŠ è½½å®Œæˆå‰éšè—æœªç¼–è¯‘çš„å˜é‡ */
        [v-cloak] { display: none !important; }

        /* --- åŠ¨ç”» --- */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(30px); }
        .list-move { transition: transform 0.5s ease; }

        /* --- å¡ç‰‡ --- */
        .app-card {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid #f1f5f9;
            overflow: hidden;
            margin-bottom: 20px; /* ç€‘å¸ƒæµé—´è· */
            break-inside: avoid; /* é˜²æ­¢è¢«æˆªæ–­ */
        }
        .app-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px -5px rgba(244, 114, 182, 0.15); }

        /* --- æ ‡ç­¾ --- */
        .tag { font-size: 12px; font-weight: 600; padding: 6px 14px; border-radius: 100px; transition: all 0.2s; white-space: nowrap; }
        .tag-active { background: #1e293b; color: #fff; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tag-inactive { background: #fff; color: #64748b; border: 1px solid #e2e8f0; }

        /* --- å›¾ç‰‡ä¹å®«æ ¼ --- */
        .img-grid { display: grid; gap: 4px; border-radius: 12px; overflow: hidden; margin-top: 12px; }
        .img-grid-1 { grid-template-columns: 1fr; }
        .img-grid-2 { grid-template-columns: 1fr 1fr; }
        .img-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .img-item { aspect-ratio: 1/1; width: 100%; object-fit: cover; cursor: zoom-in; transition: filter 0.2s; }
        .img-item:hover { filter: brightness(0.9); }
        .img-grid-1 .img-item { aspect-ratio: 16/9; max-height: 260px; }

        .pb-safe { padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
        .fab-safe { bottom: calc(32px + env(safe-area-inset-bottom)); }
    </style>
</head>
<body>

<!-- çº¯ CSS Loading (åœ¨ Vue åŠ è½½å‰æ˜¾ç¤º) -->
<div id="static-loading" style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafc;z-index:9999;transition:opacity 0.5s;">
    <div style="font-size:40px;animation:bounce 1s infinite;">ğŸ¡</div>
    <p style="color:#94a3b8;font-size:12px;margin-top:10px;font-weight:bold;">èµ„æºåŠ è½½ä¸­...</p>
    <style>@keyframes bounce {0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);}}</style>
</div>

<div id="app" v-cloak class="min-h-screen">
    
    <!-- å¯¼èˆªæ  -->
    <header class="fixed top-0 inset-x-0 z-40 bg-white/80 backdrop-blur-xl border-b border-slate-100 h-16 flex items-center justify-between px-4 transition-shadow" :class="{'shadow-sm': scrollY > 10}">
        <div class="flex items-center gap-2 cursor-pointer" @click="refresh">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center text-white shadow-lg shadow-pink-200">
                <i class="ri-heart-fill"></i>
            </div>
            <h1 class="text-lg font-extrabold text-slate-800 tracking-tight">CPDD<span class="text-rose-500">.</span></h1>
        </div>

        <div v-if="user" class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
                <div class="text-xs font-bold text-slate-700">{{ user.nickname }}</div>
                <div v-if="user.isAdmin" class="text-[10px] text-rose-500 bg-rose-50 px-1 rounded">ç®¡ç†å‘˜</div>
            </div>
            <img :src="user.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`" class="w-9 h-9 rounded-full border bg-white object-cover">
            <button @click="logout" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center">
                <i class="ri-logout-box-r-line"></i>
            </button>
        </div>
        <button v-else @click="showAuthModal = true" class="bg-slate-900 text-white text-xs font-bold px-5 py-2 rounded-full shadow-lg">
            ç™»å½•/æ³¨å†Œ
        </button>
    </header>
    <div class="h-16"></div>

    <!-- ç­›é€‰ -->
    <div class="sticky top-16 z-30 bg-white/90 backdrop-blur-md border-b border-slate-50 py-3 px-4 overflow-x-auto hide-scrollbar">
        <div class="flex gap-2 min-w-max">
            <button v-for="g in games" :key="g" @click="changeFilter(g)"
                class="tag" :class="filterGame === g ? 'tag-active' : 'tag-inactive'">{{ g }}</button>
        </div>
    </div>

    <!-- å…¬å‘Š -->
    <div v-if="notice" class="max-w-5xl mx-auto px-4 mt-4">
        <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 flex gap-2 text-xs text-orange-700">
            <i class="ri-notification-4-fill"></i> {{ notice }}
        </div>
    </div>

    <!-- å†…å®¹åŒº -->
    <main class="max-w-5xl mx-auto px-4 pt-6 pb-safe">
        
        <!-- é”™è¯¯æç¤º -->
        <div v-if="error" class="text-center py-20">
             <div class="text-4xl mb-2">âš ï¸</div>
             <p class="text-sm text-slate-500 mb-4">{{ error }}</p>
             <button @click="refresh" class="bg-rose-500 text-white px-6 py-2 rounded-full text-sm font-bold">é‡è¯•</button>
        </div>

        <!-- Loading -->
        <div v-else-if="loading" class="text-center py-32 text-rose-300">
            <i class="ri-loader-4-line text-3xl animate-spin"></i>
            <p class="text-xs font-bold mt-2">åŠ è½½ä¸­...</p>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-else-if="!posts.length" class="text-center py-32 text-slate-400">
            <div class="text-5xl mb-2 grayscale opacity-50">ğŸ”ï¸</div>
            <p class="text-sm font-bold">æš‚æ— å†…å®¹</p>
            <button @click="checkAuthAndPost" class="mt-4 text-rose-500 text-xs font-bold hover:underline">å»å‘å¸ƒ</button>
        </div>

        <!-- ç€‘å¸ƒæµåˆ—è¡¨ -->
        <div v-else class="flex gap-4 items-start">
            <div v-for="(col, i) in columns" :key="i" class="flex-1 flex flex-col gap-4 min-w-0">
                <div v-for="post in col" :key="post.id" class="app-card p-4">
                    <!-- å¤´éƒ¨ -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <img :src="post.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.username}`" class="w-9 h-9 rounded-full bg-slate-100 object-cover">
                            <div>
                                <div class="flex items-center gap-1 flex-wrap">
                                    <span class="text-sm font-bold text-slate-800">{{ post.nickname }}</span>
                                    <span class="text-[10px] px-1.5 py-0.5 bg-slate-100 rounded text-slate-500">{{ post.game }}</span>
                                </div>
                                <div class="text-[10px] text-slate-400">{{ post.timeStr }}</div>
                            </div>
                        </div>
                        <button v-if="user && user.isAdmin" @click="deletePost(post.id)" class="text-slate-300 hover:text-red-500">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>

                    <!-- å†…å®¹ -->
                    <div class="text-sm text-slate-700 mb-3 whitespace-pre-wrap break-words">{{ post.desc }}</div>
                    
                    <!-- éœ€æ±‚ -->
                    <div v-if="post.requirement" class="bg-rose-50 rounded-lg p-2 mb-3 text-xs text-slate-600 border border-rose-100">
                        <span class="font-bold text-rose-500">éœ€æ±‚ï¼š</span>{{ post.requirement }}
                    </div>

                    <!-- å›¾ç‰‡ -->
                    <div v-if="post.images && post.images.length" class="img-grid" :class="'img-grid-' + Math.min(post.images.length, 3)">
                        <img v-for="(img, idx) in post.images" :key="idx" :src="img" class="img-item" @click="previewImage(post.images, idx)">
                    </div>

                    <!-- åº•éƒ¨ -->
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-50">
                        <button @click="toggleComments(post)" class="flex items-center gap-1 text-slate-400 hover:text-slate-600 text-xs font-bold">
                            <i class="ri-chat-1-line text-base"></i> {{ post.commentsCount || 0 }}
                        </button>
                        <button @click="handleLike(post)" :disabled="post.liking" class="flex items-center gap-1 text-xs font-bold transition-colors" :class="isLiked(post) ? 'text-rose-500' : 'text-slate-400'">
                            <i :class="isLiked(post) ? 'ri-heart-3-fill' : 'ri-heart-3-line'" class="text-base"></i> {{ post.likes || 0 }}
                        </button>
                    </div>

                    <!-- è¯„è®º -->
                    <div v-if="post.showComments" class="mt-3 pt-3 border-t border-dashed border-slate-100">
                        <div v-if="post.loadingComments" class="text-center text-xs text-slate-400">åŠ è½½ä¸­...</div>
                        <div v-else>
                            <div v-if="!post.commentList?.length" class="text-center text-xs text-slate-300 py-2">æš‚æ— è¯„è®º</div>
                            <div class="space-y-2 mb-2 max-h-40 overflow-y-auto">
                                <div v-for="cmt in post.commentList" :key="cmt.id" class="flex gap-2 text-xs">
                                    <span class="font-bold text-slate-700 shrink-0">{{ cmt.nickname }}:</span>
                                    <span class="text-slate-600 break-all">{{ cmt.content }}</span>
                                    <button v-if="user?.isAdmin" @click="deleteComment(post, cmt.id)" class="ml-auto text-slate-300 hover:text-red-500"><i class="ri-close-line"></i></button>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <input v-model="post.newCommentInput" placeholder="å›å¤..." class="flex-1 bg-slate-50 rounded-full px-3 py-1 text-xs outline-none">
                                <button @click="submitComment(post)" class="text-rose-500 text-xs font-bold">å‘é€</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ‚¬æµ®æŒ‰é’® -->
    <div class="fixed right-5 z-40 flex flex-col gap-3 fab-safe">
        <button v-show="scrollY > 300" @click="scrollToTop" class="w-10 h-10 bg-white rounded-full shadow-lg text-slate-400 flex items-center justify-center"><i class="ri-arrow-up-line"></i></button>
        <button @click="checkAuthAndPost" class="w-12 h-12 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 transition-transform"><i class="ri-add-line text-xl"></i></button>
    </div>

    <!-- å¼¹çª—ï¼šç™»å½•æ³¨å†Œ -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl">
            <h3 class="text-center font-bold text-lg mb-4">{{ authMode==='login'?'ç™»å½•':'æ³¨å†Œ' }}</h3>
            <div class="space-y-3">
                <div v-if="authMode==='register'" class="flex justify-center" @click="$refs.avatarInput.click()">
                    <div class="w-16 h-16 rounded-full bg-slate-50 border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-300 overflow-hidden">
                        <img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover">
                        <i v-else class="ri-camera-fill text-xl"></i>
                    </div>
                    <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
                </div>
                <input v-model="authForm.username" placeholder="è´¦å· (â‰¥8ä½)" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-xs">
                <input v-model="authForm.password" type="password" placeholder="å¯†ç  (â‰¥6ä½)" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-xs">
                <input v-if="authMode==='register'" v-model="authForm.nickname" placeholder="æ˜µç§°" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-xs">
                <button @click="handleAuth" :disabled="isAuthing" class="w-full bg-slate-900 text-white py-2 rounded-lg text-xs font-bold">{{ isAuthing?'å¤„ç†ä¸­...':'ç¡®å®š' }}</button>
            </div>
            <div class="flex justify-between mt-4 text-xs text-slate-400">
                <button @click="authMode = authMode==='login'?'register':'login'">åˆ‡æ¢{{ authMode==='login'?'æ³¨å†Œ':'ç™»å½•' }}</button>
                <button @click="showAuthModal=false">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå‘å¸ƒ -->
    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
            <button @click="showPostModal=false" class="text-slate-500">å–æ¶ˆ</button>
            <h3 class="font-bold">å‘å¸ƒåŠ¨æ€</h3>
            <button @click="submitPost" :disabled="submitting" class="bg-rose-500 text-white px-4 py-1 rounded-full text-xs font-bold">{{ submitting?'...':'å‘å¸ƒ' }}</button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <textarea v-model="postForm.content" class="w-full h-32 text-sm outline-none placeholder-slate-300 resize-none" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
            <div class="flex flex-wrap gap-2 mb-4">
                <div v-for="(img,i) in postForm.images" :key="i" class="w-20 h-20 rounded bg-slate-100 relative overflow-hidden">
                    <img :src="img" class="w-full h-full object-cover">
                    <button @click="removeImage(i)" class="absolute top-0 right-0 bg-black/50 text-white w-5 h-5 flex items-center justify-center text-xs">&times;</button>
                </div>
                <div v-if="postForm.images.length<3" @click="$refs.pInput.click()" class="w-20 h-20 rounded border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-300">
                    <i class="ri-add-line text-xl"></i>
                </div>
                <input type="file" ref="pInput" hidden accept="image/*" @change="handlePostImageUpload">
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-2">åˆ†åŒº</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="g in games.slice(1)" :key="g" @click="postForm.game=g" class="px-3 py-1 rounded border text-xs" :class="postForm.game===g?'bg-slate-800 text-white':'bg-white text-slate-500'">{{ g }}</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-2">è¦æ±‚</label>
                    <input v-model="postForm.requirement" class="w-full bg-slate-50 rounded px-3 py-2 text-xs outline-none" placeholder="é€‰å¡«...">
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆ -->
    <div v-if="preview.show" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center" @click="preview.show=false">
        <img :src="preview.list[preview.idx]" class="max-w-full max-h-screen object-contain">
    </div>

</div>

<script>
    const { createApp, ref, onMounted, watch } = Vue;

    createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const posts = ref([]);
            const loading = ref(true);
            const error = ref('');
            const scrollY = ref(0);
            const notice = "æ¬¢è¿æ¥åˆ° CPDD æ‰©åˆ—å°ç«™ï¼ä¸¥ç¦å‘å¸ƒè¿è§„ä¿¡æ¯ã€‚";

            const showAuthModal = ref(false);
            const authMode = ref('login');
            const showPostModal = ref(false);
            const submitting = ref(false);
            const isAuthing = ref(false);
            const preview = ref({show:false, list:[], idx:0});

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');
            const authForm = ref({username:'', password:'', nickname:'', avatar:''});
            const postForm = ref({content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]});
            
            const columns = ref([[], [], []]);
            const windowWidth = ref(window.innerWidth);

            // ç€‘å¸ƒæµæ ¸å¿ƒ
            const updateColumns = () => {
                if(!Array.isArray(posts.value)) { posts.value = []; return; }
                const cols = windowWidth.value < 640 ? 1 : (windowWidth.value < 1024 ? 2 : 3);
                const res = Array.from({length: cols}, () => []);
                const filtered = filterGame.value==='å…¨éƒ¨' ? posts.value : posts.value.filter(p => p.game === filterGame.value);
                filtered.forEach((p, i) => res[i % cols].push(p));
                columns.value = res;
            };

            watch([filterGame, posts], updateColumns);
            window.onresize = () => { windowWidth.value = window.innerWidth; updateColumns(); };
            window.onscroll = () => scrollY.value = window.scrollY;

            onMounted(() => {
                // ç§»é™¤çº¯CSS loading
                const staticLoading = document.getElementById('static-loading');
                if(staticLoading) { staticLoading.style.opacity = 0; setTimeout(()=>staticLoading.remove(), 500); }
                
                try {
                    const u = localStorage.getItem('cp_user');
                    if(u) user.value = JSON.parse(u);
                } catch(e){}
                fetchPosts();
            });

            const fetchPosts = async () => {
                loading.value = true; error.value = '';
                try {
                    const res = await fetch(API);
                    if(!res.ok) throw new Error('ç½‘ç»œå¼€å°å·®äº†');
                    const data = await res.json();
                    if(Array.isArray(data)) posts.value = data;
                    else throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                } catch(e) { error.value = e.message; posts.value = []; }
                loading.value = false;
            };

            // ä¿®å¤çš„ç‚¹èµé€»è¾‘
            const isLiked = (p) => {
                if(!p.likedIds) return false;
                if(user.value) return p.likedIds.includes('user:'+user.value.username);
                const locals = JSON.parse(localStorage.getItem('cp_likes')||'[]');
                return locals.includes(p.id);
            };

            const handleLike = async (p) => {
                if(p.liking) return;
                p.liking = true;
                const liked = isLiked(p);
                // ä¹è§‚æ›´æ–°
                if(liked) {
                    p.likes--;
                    if(user.value) p.likedIds = p.likedIds.filter(id => id !== 'user:'+user.value.username);
                    else {
                        const ls = JSON.parse(localStorage.getItem('cp_likes')||'[]');
                        localStorage.setItem('cp_likes', JSON.stringify(ls.filter(id=>id!==p.id)));
                        p.likedIds = []; // æ¸¸å®¢ç®€æ˜“å¤„ç†
                    }
                } else {
                    p.likes++;
                    if(user.value) { if(!p.likedIds) p.likedIds=[]; p.likedIds.push('user:'+user.value.username); }
                    else {
                        const ls = JSON.parse(localStorage.getItem('cp_likes')||'[]');
                        ls.push(p.id); localStorage.setItem('cp_likes', JSON.stringify(ls));
                        if(!p.likedIds) p.likedIds=[]; p.likedIds.push('temp');
                    }
                }
                try {
                    await fetch(`${API}?action=like`, {method:'POST', body:JSON.stringify({id:p.id, user:user.value})});
                } catch(e){ p.likes = liked ? p.likes+1 : p.likes-1; } // å›æ»š
                p.liking = false;
            };

            // å‹ç¼©å›¾ç‰‡
            const compress = (file) => new Promise(resolve => {
                const r = new FileReader();
                r.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        let w=img.width, h=img.height;
                        if(w>800){ h*=800/w; w=800; }
                        cvs.width=w; cvs.height=h;
                        cvs.getContext('2d').drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                r.readAsDataURL(file);
            });

            const handleAvatarUpload = async (e) => { if(e.target.files[0]) authForm.value.avatar = await compress(e.target.files[0]); };
            const handlePostImageUpload = async (e) => { 
                if(e.target.files[0] && postForm.value.images.length<3) postForm.value.images.push(await compress(e.target.files[0])); 
                e.target.value='';
            };

            const handleAuth = async () => {
                if(!authForm.value.username) return alert('è¯·è¾“å…¥è´¦å·');
                isAuthing.value = true;
                try {
                    const res = await fetch(`${API}?action=${authMode.value}`, {method:'POST', body:JSON.stringify(authForm.value)});
                    const d = await res.json();
                    if(d.error) alert(d.error);
                    else { user.value = d.user; localStorage.setItem('cp_user', JSON.stringify(d.user)); showAuthModal.value = false; }
                } catch(e){ alert('ç½‘ç»œé”™è¯¯'); }
                isAuthing.value = false;
            };

            const submitPost = async () => {
                if(!postForm.value.content) return alert('å†™ç‚¹ä»€ä¹ˆå§');
                submitting.value = true;
                try {
                    const res = await fetch(`${API}?action=create_post`, {method:'POST', body:JSON.stringify({user:user.value, ...postForm.value})});
                    if(res.ok) { showPostModal.value = false; postForm.value = {content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]}; fetchPosts(); }
                    else alert('å‘å¸ƒå¤±è´¥');
                } catch(e){ alert('ç½‘ç»œé”™è¯¯'); }
                submitting.value = false;
            };

            const deletePost = async (id) => {
                if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { await fetch(`${API}?action=delete_post`, {method:'POST', body:JSON.stringify({id, user:user.value})}); fetchPosts(); }
            };
            
            // è¯„è®ºç›¸å…³
            const toggleComments = async (p) => {
                p.showComments = !p.showComments;
                if(p.showComments && !p.loaded) {
                    p.loadingComments = true;
                    try { p.commentList = await (await fetch(`${API}?action=get_comments&postId=${p.id}`)).json(); p.loaded=true; } catch(e){}
                    p.loadingComments = false;
                }
            };
            const submitComment = async (p) => {
                if(!user.value) return showAuthModal.value = true;
                if(!p.newCommentInput) return;
                const txt = p.newCommentInput; p.newCommentInput='';
                if(!p.commentList) p.commentList=[];
                p.commentList.push({id:Date.now(), nickname:user.value.nickname, content:txt});
                p.commentsCount = (p.commentsCount||0)+1;
                await fetch(`${API}?action=add_comment`, {method:'POST', body:JSON.stringify({postId:p.id, user:user.value, content:txt})});
            };
            const deleteComment = async (p, cid) => {
                if(confirm('åˆ è¯„è®ºï¼Ÿ')) {
                    await fetch(`${API}?action=delete_comment`, {method:'POST', body:JSON.stringify({postId:p.id, commentId:cid, user:user.value})});
                    p.commentList = p.commentList.filter(c=>c.id!==cid); p.commentsCount--;
                }
            };

            // è¾…åŠ©
            const changeFilter = g => filterGame.value = g;
            const logout = () => { user.value=null; localStorage.removeItem('cp_user'); };
            const checkAuthAndPost = () => user.value ? showPostModal.value = true : showAuthModal.value = true;
            const removeImage = i => postForm.value.images.splice(i,1);
            const previewImage = (l,i) => preview.value = {show:true, list:l, idx:i};
            const scrollToTop = () => window.scrollTo({top:0, behavior:'smooth'});

            return {
                user, loading, error, posts, columns, games, filterGame, notice, scrollY,
                showAuthModal, authMode, authForm, isAuthing,
                showPostModal, postForm, submitting, preview,
                refresh:fetchPosts, handleAuth, handleAvatarUpload, handlePostImageUpload, submitPost,
                deletePost, isLiked, handleLike, toggleComments, submitComment, deleteComment,
                changeFilter, logout, checkAuthAndPost, removeImage, previewImage, scrollToTop
            };
        }
    }).mount('#app');
</script>
</body>
</html>
