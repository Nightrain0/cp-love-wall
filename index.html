<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Vue 3 (ä¸ºäº†å†™äº¤äº’é€»è¾‘æ–¹ä¾¿ï¼Œæ¯”çº¯åŸç”ŸJSæ›´æ˜“ç»´æŠ¤) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- å›¾æ ‡åº“ -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* è‡ªå®šä¹‰ä¸€äº›åŠ¨ç”»å’Œæ»šåŠ¨æ¡ */
        body { background-color: #fdf2f8; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active { transition: all 0.3s ease-out; }
        .slide-up-enter-from { transform: translateY(20px); opacity: 0; }
        
        /* æ¸¸æˆæ ‡ç­¾é¢œè‰² */
        .tag-wzry { background: #fef3c7; color: #d97706; }
        .tag-ys { background: #e0e7ff; color: #4f46e5; }
        .tag-lol { background: #dbeafe; color: #2563eb; }
        .tag-pubg { background: #dcfce7; color: #16a34a; }
        .tag-other { background: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body>

<div id="app" class="max-w-3xl mx-auto min-h-screen pb-20 relative">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-pink-100 px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-tr from-pink-400 to-purple-400 w-8 h-8 rounded-lg flex items-center justify-center text-white shadow-lg rotate-3">
                <i class="ri-gamepad-fill"></i>
            </div>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-purple-500">
                CPDDæ‰©åˆ—
            </h1>
        </div>
        <button @click="showPostModal = true" class="bg-pink-500 active:scale-95 transition-transform text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-md shadow-pink-200 flex items-center gap-1">
            <i class="ri-add-line"></i> å‘å¸ƒ
        </button>
    </header>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="px-4 py-4 sticky top-16 z-30 bg-[#fdf2f8]/95 backdrop-blur-sm">
        <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
            <button 
                v-for="g in games" :key="g"
                @click="filterGame = g"
                class="whitespace-nowrap px-3 py-1 rounded-full text-xs font-bold transition-all border"
                :class="filterGame === g ? 'bg-pink-500 text-white border-pink-500 shadow-md' : 'bg-white text-slate-500 border-slate-200'"
            >
                {{ g }}
            </button>
        </div>
    </div>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <main class="px-4 space-y-4">
        <div v-if="loading" class="text-center py-20 text-pink-300">
            <i class="ri-loader-4-line text-3xl animate-spin"></i>
            <p class="text-sm mt-2">æ­£åœ¨å¬å”¤é˜Ÿå‹...</p>
        </div>

        <div v-else-if="filteredPosts.length === 0" class="text-center py-20 text-slate-400">
            <i class="ri-ghost-line text-4xl mb-2"></i>
            <p>è¿˜æ²¡æœ‰è¿™ä¸ªæ¸¸æˆçš„å¸–å­å“¦~</p>
        </div>

        <transition-group name="slide-up">
            <div v-for="post in filteredPosts" :key="post.id" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                <!-- å¤´éƒ¨ä¿¡æ¯ -->
                <div class="flex justify-between items-start mb-3">
                    <div class="flex gap-3">
                        <!-- å¤´åƒ (å¦‚æœæœ‰å›¾ç‰‡æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ²¡æœ‰æ˜¾ç¤ºé»˜è®¤) -->
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex-shrink-0 overflow-hidden border border-slate-200">
                            <img v-if="post.imageBase64" :src="post.imageBase64" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-slate-300">
                                <i class="ri-user-smile-line text-xl"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-800">{{ post.nickname }}</span>
                                <span class="text-[10px] px-1.5 py-0.5 rounded-full" 
                                      :class="post.gender === 'å°å§å§' ? 'bg-pink-100 text-pink-500' : 'bg-blue-100 text-blue-500'">
                                    {{ post.gender }}
                                </span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs px-2 py-0.5 rounded bg-slate-100 text-slate-600 font-medium">
                                    {{ post.game }}
                                </span>
                                <span class="text-xs text-slate-400">{{ post.timeStr }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å†…å®¹ -->
                <div class="space-y-2 mb-4">
                    <div class="bg-slate-50 p-2.5 rounded-xl text-sm text-slate-600 leading-relaxed">
                        <span class="font-bold text-slate-400 mr-1">#å…³äºæˆ‘</span>
                        {{ post.desc }}
                    </div>
                    <div v-if="post.requirement" class="bg-pink-50/50 p-2.5 rounded-xl text-sm text-slate-600 leading-relaxed">
                        <span class="font-bold text-pink-300 mr-1">#æ‰¾CP</span>
                        {{ post.requirement }}
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œ -->
                <div class="flex items-center justify-between pt-2 border-t border-slate-50">
                    <button @click="likePost(post)" class="flex items-center gap-1 text-sm text-slate-400 hover:text-pink-500 transition-colors" :class="{'text-pink-500': post.likedLocal}">
                        <i :class="post.likedLocal ? 'ri-heart-fill' : 'ri-heart-line'"></i>
                        <span>{{ post.likes + (post.likedLocal ? 1 : 0) }}</span>
                    </button>
                    <button class="bg-slate-800 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-slate-700">
                        <i class="ri-chat-1-line mr-1"></i> DDTA
                    </button>
                </div>
            </div>
        </transition-group>
    </main>

    <!-- å‘å¸ƒå¼¹çª— -->
    <transition name="fade">
        <div v-if="showPostModal" class="fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4">
            <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-5 shadow-2xl h-[85vh] sm:h-auto flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">âœ¨ å‘å¸ƒæ‰©åˆ—</h3>
                    <button @click="showPostModal = false" class="text-slate-400 hover:text-slate-600 text-xl">
                        <i class="ri-close-circle-fill"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto space-y-4 pr-1">
                    <!-- å¤´åƒä¸Šä¼  -->
                    <div class="flex justify-center">
                        <div @click="$refs.fileInput.click()" class="w-20 h-20 rounded-full bg-slate-50 border-2 border-dashed border-pink-200 flex flex-col items-center justify-center text-pink-300 cursor-pointer overflow-hidden relative">
                            <img v-if="form.imageBase64" :src="form.imageBase64" class="w-full h-full object-cover">
                            <div v-else class="text-center">
                                <i class="ri-camera-fill text-xl"></i>
                                <span class="text-[10px] block">ä¼ å¤´åƒ</span>
                            </div>
                            <input type="file" ref="fileInput" @change="handleImageUpload" class="hidden" accept="image/*">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">æ˜µç§°</label>
                            <input v-model="form.nickname" class="w-full bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-pink-200 outline-none" placeholder="ä½ çš„åå­—">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">æ€§åˆ«</label>
                            <select v-model="form.gender" class="w-full bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-pink-200 outline-none">
                                <option>å°å§å§</option>
                                <option>å°å“¥å“¥</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1 block">å¸¸ç©æ¸¸æˆ</label>
                        <select v-model="form.game" class="w-full bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-pink-200 outline-none">
                            <option v-for="g in games.slice(1)" :key="g">{{ g }}</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1 block">å…³äºæˆ‘</label>
                        <textarea v-model="form.desc" rows="3" class="w-full bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-pink-200 outline-none resize-none" placeholder="æ¯”å¦‚ï¼šäººçš®è¯å¤šï¼Œä¸å‹åŠ›..."></textarea>
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1 block">æ‰¾ä»€ä¹ˆæ ·çš„</label>
                        <textarea v-model="form.requirement" rows="2" class="w-full bg-slate-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-pink-200 outline-none resize-none" placeholder="æ¯”å¦‚ï¼šé‡ç‹dd..."></textarea>
                    </div>
                </div>

                <div class="pt-4 mt-2 border-t border-slate-100">
                    <button @click="submitPost" :disabled="submitting" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-200 active:scale-95 transition-transform disabled:opacity-50">
                        {{ submitting ? 'å‘é€ä¸­...' : 'å‘å°„ä¿¡å· ğŸ“¡' }}
                    </button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // API åœ°å€ï¼šæŒ‡å‘ä½ çš„ Vercel å‡½æ•°
            const API_URL = '/api/cp'; 
            
            const loading = ref(true);
            const showPostModal = ref(false);
            const submitting = ref(false);
            const posts = ref([]);
            
            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');

            const form = ref({
                nickname: '',
                gender: 'å°å§å§',
                game: 'ç‹è€…è£è€€',
                desc: '',
                requirement: '',
                imageBase64: ''
            });

            // è·å–æ•°æ®
            const fetchPosts = async () => {
                try {
                    const res = await fetch(API_URL);
                    if (res.ok) {
                        posts.value = await res.json();
                    }
                } catch (e) {
                    console.error("Fetch error", e);
                } finally {
                    loading.value = false;
                }
            };

            // è®¡ç®—å±æ€§ï¼šç­›é€‰é€»è¾‘
            const filteredPosts = computed(() => {
                if (filterGame.value === 'å…¨éƒ¨') return posts.value;
                return posts.value.filter(p => p.game === filterGame.value);
            });

            // å›¾ç‰‡å¤„ç†ï¼šå‹ç¼© + è½¬Base64
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // ä½¿ç”¨ Canvas å‹ç¼©å›¾ç‰‡
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // é™åˆ¶æœ€å¤§å®½é«˜ï¼Œå‡å°ä½“ç§¯
                        const MAX_SIZE = 300; 
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // å‹ç¼©è´¨é‡ 0.6
                        form.value.imageBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            // æäº¤å‘å¸ƒ
            const submitPost = async () => {
                if (!form.value.nickname || !form.value.desc) {
                    alert("æ˜µç§°å’Œä»‹ç»è®°å¾—å¡«å“¦~");
                    return;
                }
                
                submitting.value = true;
                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify(form.value)
                    });
                    
                    if (res.ok) {
                        showPostModal.value = false;
                        // é‡ç½®è¡¨å•
                        form.value.desc = '';
                        form.value.requirement = '';
                        form.value.imageBase64 = '';
                        // åˆ·æ–°åˆ—è¡¨
                        await fetchPosts();
                    } else {
                        alert("å‘å¸ƒå¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡å¤ªå¤§äº†ï¼Ÿ");
                    }
                } catch (e) {
                    alert("ç½‘ç»œé”™è¯¯");
                } finally {
                    submitting.value = false;
                }
            };

            // ç‚¹èµé€»è¾‘
            const likePost = async (post) => {
                if (post.likedLocal) return;
                
                // ä¹è§‚æ›´æ–° UI
                post.likedLocal = true;
                
                try {
                    await fetch(API_URL, {
                        method: 'PUT',
                        body: JSON.stringify({ id: post.id })
                    });
                } catch(e) {
                    console.error("Like failed");
                }
            };

            onMounted(() => {
                fetchPosts();
            });

            return {
                loading, posts, filteredPosts, games, filterGame,
                showPostModal, form, submitting,
                handleImageUpload, submitPost, likePost
            };
        }
    }).mount('#app');
</script>

</body>
</html>
