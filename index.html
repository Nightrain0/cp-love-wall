<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    
    <!-- ä»…ä¿ç•™å›¾æ ‡åº“å’Œ Vue -->
    <link href="https://cdn.staticfile.org/remixicon/3.5.0/remixicon.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>

    <!-- å…¨å±€é”™è¯¯æ•è· -->
    <script>
        window.onerror = function(msg) {
            document.getElementById('global-error').style.display = 'flex';
            document.getElementById('error-msg').innerText = msg;
            document.getElementById('static-loading').style.display = 'none';
        };
    </script>

    <style>
        /* --- åŸç”Ÿ CSS é‡æ„ï¼Œå½»åº•å‘Šåˆ« Tailwind ä¾èµ– --- */
        :root {
            --primary: #e11d48; /* ç«ç‘°çº¢ */
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #334155;
            --text-sub: #94a3b8;
            --border: #f1f5f9;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-page);
            background-image: linear-gradient(to bottom right, #fff1f2, #f8fafc, #f0f9ff);
            background-attachment: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
            padding-bottom: 100px;
        }

        /* å¸ƒå±€å·¥å…·ç±» */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 4px; } .gap-2 { gap: 8px; } .gap-3 { gap: 12px; }
        .hidden { display: none; }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; z-index: 100;
        }
        .logo { font-weight: 900; font-size: 18px; letter-spacing: -0.5px; }
        .logo span { color: var(--primary); }
        .avatar-sm { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-login {
            background: #0f172a; color: white; border: none; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer;
        }

        /* ç­›é€‰æ  */
        .filter-bar {
            position: sticky; top: 60px; z-index: 90;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 12px 16px; border-bottom: 1px solid var(--border);
            overflow-x: auto; white-space: nowrap;
            display: flex; gap: 8px;
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        .tag {
            padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: bold;
            border: 1px solid transparent; cursor: pointer; transition: all 0.2s;
        }
        .tag.active { background: #0f172a; color: white; transform: scale(1.05); }
        .tag.inactive { background: #fff; color: var(--text-sub); border-color: var(--border); }

        /* ä¸»å®¹å™¨ & ç€‘å¸ƒæµ */
        .main-container { max-width: 1024px; margin: 0 auto; padding: 16px; }
        .waterfall { display: flex; gap: 16px; align-items: flex-start; }
        .column { flex: 1; display: flex; flex-direction: column; gap: 16px; min-width: 0; }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--bg-card); border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow); padding: 16px;
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .user-info { display: flex; gap: 8px; align-items: center; }
        .nickname { font-size: 14px; font-weight: bold; color: #0f172a; }
        .time { font-size: 10px; color: var(--text-sub); }
        .game-badge { font-size: 10px; background: #f1f5f9; color: var(--text-sub); padding: 2px 6px; border-radius: 4px; }
        
        .card-content { font-size: 14px; line-height: 1.5; margin-bottom: 12px; word-break: break-all; }
        .req-tag { background: #fff1f2; color: var(--primary); padding: 8px; border-radius: 8px; font-size: 12px; margin-bottom: 12px; }
        
        /* å›¾ç‰‡ç½‘æ ¼ */
        .img-grid { display: grid; gap: 4px; border-radius: 12px; overflow: hidden; }
        .img-grid.cols-1 { grid-template-columns: 1fr; }
        .img-grid.cols-2 { grid-template-columns: 1fr 1fr; }
        .img-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
        .img-item { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .img-grid.cols-1 .img-item { aspect-ratio: 16/9; }

        /* åº•éƒ¨æ“ä½œæ  */
        .card-footer { 
            display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; 
            border-top: 1px solid var(--border); 
        }
        .btn-action { 
            background: transparent; border: none; color: var(--text-sub); 
            font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px; cursor: pointer; 
        }
        .btn-action.active { color: var(--primary); }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab-group { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 90; }
        .fab { 
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background: #0f172a; color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer;
        }
        .fab.white { background: white; color: var(--text-sub); font-size: 20px; }

        /* å¼¹çª—é€šç”¨ */
        .modal-mask { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box { 
            background: white; width: 100%; max-width: 320px; border-radius: 24px; padding: 24px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;
        }
        .input-field { 
            width: 100%; background: #f8fafc; border: none; padding: 12px; border-radius: 12px; 
            font-size: 14px; outline: none; margin-bottom: 10px;
        }
        .btn-primary { 
            width: 100%; background: var(--primary); color: white; border: none; padding: 12px; 
            border-radius: 12px; font-weight: bold; font-size: 14px; margin-top: 10px; cursor: pointer;
        }
        .btn-primary:disabled { opacity: 0.6; }

        /* èŠå¤©ç•Œé¢ */
        .chat-modal { max-width: 400px; height: 70vh; padding: 0; }
        .chat-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; overflow-y: auto; padding: 16px; background: #f8fafc; }
        .chat-footer { padding: 12px; background: white; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        
        .msg-row { display: flex; gap: 8px; margin-bottom: 16px; align-items: flex-end; }
        .msg-row.mine { flex-direction: row-reverse; }
        .msg-avatar { width: 32px; height: 32px; border-radius: 50%; border: 1px solid white; }
        .msg-bubble { 
            max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-break: break-all; 
            position: relative;
        }
        .msg-row.mine .msg-bubble { background: #1e293b; color: white; border-bottom-right-radius: 4px; }
        .msg-row.other .msg-bubble { background: white; color: #333; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
        .msg-time { font-size: 10px; color: #ccc; margin-top: 4px; text-align: right; }

        /* è¯„è®ºåŒº */
        .comment-area { margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border); }
        .comment-item { display: flex; gap: 8px; margin-bottom: 8px; font-size: 12px; }
        .comment-content { background: #f8fafc; padding: 6px 10px; border-radius: 12px; flex: 1; }
        .comment-name { font-weight: bold; color: #334155; margin-bottom: 2px; }
        
        /* çº¢ç‚¹ */
        .badge { 
            position: absolute; top: -2px; right: -2px; background: red; color: white; 
            font-size: 10px; width: 16px; height: 16px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;
        }
        
        /* è¾…åŠ© */
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<!-- é”™è¯¯æç¤ºå…œåº• -->
<div id="global-error" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;flex-direction:column;align-items:center;justify-content:center;">
    <div style="font-size:40px">ğŸ˜µ</div>
    <p id="error-msg" style="margin:20px;color:red;font-size:12px;"></p>
    <button onclick="location.reload()" style="padding:10px 30px;border-radius:20px;border:1px solid #ccc;background:white;">åˆ·æ–°</button>
</div>

<!-- é™æ€ Loading -->
<div id="static-loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f8fafc;z-index:9999;display:flex;justify-content:center;align-items:center;font-weight:bold;color:#ccc;">
    LOADING...
</div>

<div id="app" v-cloak>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <div class="logo" @click="refresh">CPDD<span>.</span></div>
        <div style="display:flex; gap:16px; align-items:center;">
            <div v-if="user" style="position:relative; cursor:pointer;" @click="openInbox">
                <i class="ri-mail-line" style="font-size:24px; color:#64748b;"></i>
                <div v-if="totalUnread > 0" class="badge">{{ totalUnread > 9 ? '9+' : totalUnread }}</div>
            </div>
            <div v-if="user" @click="handleAvatarClick(user.username)">
                <img :src="user.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`" class="avatar-sm">
            </div>
            <button v-else class="btn-login" @click="showAuthModal=true">ç™»å½•/æ³¨å†Œ</button>
        </div>
    </div>

    <!-- ç­›é€‰ -->
    <div class="filter-bar">
        <div v-for="g in games" :key="g" class="tag" :class="filterGame===g?'active':'inactive'" @click="changeFilter(g)">{{g}}</div>
    </div>
    
    <!-- å…¬å‘Š -->
    <div v-if="notice" class="main-container" style="padding-bottom:0;">
        <div style="background:#fff7ed; color:#ea580c; padding:10px; border-radius:12px; font-size:12px; display:flex; gap:6px; border:1px solid #fed7aa;">
            <i class="ri-notification-4-fill"></i> {{notice}}
        </div>
    </div>

    <!-- å†…å®¹ -->
    <div class="main-container">
        <div v-if="loading" style="text-center; padding: 50px; color:#ccc;">åŠ è½½ä¸­...</div>
        <div v-else-if="!posts.length" style="text-center; padding: 50px; color:#ccc;">æš‚æ— å†…å®¹</div>
        
        <div v-else class="waterfall">
            <div v-for="(col, i) in columns" :key="i" class="column">
                <div v-for="post in col" :key="post.id" class="card">
                    <!-- å¸–å­å¤´ -->
                    <div class="card-header">
                        <div class="user-info" @click.stop="handleAvatarClick(post.username)">
                            <img :src="post.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.username}`" class="avatar-sm">
                            <div>
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <div class="nickname">{{post.nickname}}</div>
                                    <i v-if="post.gender==='male'" class="ri-men-line" style="color:#60a5fa;font-size:12px;"></i>
                                    <i v-if="post.gender==='female'" class="ri-women-line" style="color:#f472b6;font-size:12px;"></i>
                                </div>
                                <div class="time">{{post.timeStr}}</div>
                            </div>
                        </div>
                        <button v-if="user && (user.isAdmin || user.username===post.username)" @click="deletePost(post.id)" style="border:none;background:none;color:#cbd5e1;"><i class="ri-delete-bin-line"></i></button>
                    </div>
                    
                    <!-- å†…å®¹ -->
                    <div class="card-content">{{post.desc}}</div>
                    <div v-if="post.requirement" class="req-tag">éœ€æ±‚ï¼š{{post.requirement}}</div>
                    
                    <!-- å›¾ç‰‡ -->
                    <div v-if="post.images && post.images.length" class="img-grid" :class="'cols-'+Math.min(post.images.length,3)">
                        <img v-for="(img, idx) in post.images" :src="img" class="img-item" @click="previewImage(post.images, idx)">
                    </div>
                    
                    <!-- åº•éƒ¨æ“ä½œ -->
                    <div class="card-footer">
                        <button class="btn-action" @click="toggleComments(post)">
                            <i class="ri-chat-1-line" style="font-size:16px;"></i> {{post.commentsCount||0}}
                        </button>
                        <button class="btn-action" :class="{active: isLiked(post)}" @click="handleLike(post)">
                            <i :class="isLiked(post)?'ri-heart-3-fill':'ri-heart-3-line'" style="font-size:16px;"></i> {{post.likes||0}}
                        </button>
                    </div>

                    <!-- è¯„è®º -->
                    <div v-if="post.showComments" class="comment-area">
                        <div v-if="!post.commentList?.length" style="text-align:center;font-size:12px;color:#ccc;margin:10px 0;">æš‚æ— è¯„è®º</div>
                        <div style="max-height:200px;overflow-y:auto;">
                            <div v-for="cmt in post.commentList" :key="cmt.id" class="comment-item" @click="triggerReply(post, cmt)">
                                <img :src="cmt.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${cmt.username}`" style="width:24px;height:24px;border-radius:50%;">
                                <div class="comment-content">
                                    <div class="comment-name">
                                        {{cmt.nickname}}
                                        <span v-if="user && (user.isAdmin || user.username===cmt.username)" @click.stop="deleteComment(post, cmt.id)" style="float:right;color:#f87171;cursor:pointer;">åˆ é™¤</span>
                                    </div>
                                    <div>{{cmt.content}}</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;">
                            <input v-model="post.newCommentInput" :id="'input-'+post.id" class="input-field" style="margin:0;" placeholder="è¯„è®º...">
                            <button @click="submitComment(post)" style="background:#0f172a;color:white;border:none;border-radius:50%;width:36px;height:36px;"><i class="ri-send-plane-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®æŒ‰é’® -->
    <div class="fab-group">
        <button v-show="scrollY>300" class="fab white" @click="scrollToTop"><i class="ri-arrow-up-line"></i></button>
        <button class="fab" @click="checkAuthAndPost"><i class="ri-add-line"></i></button>
    </div>

    <!-- å¼¹çª—ï¼šç™»å½• -->
    <div v-if="showAuthModal" class="modal-mask">
        <div class="modal-box">
            <h3 style="text-align:center;margin-bottom:20px;font-size:18px;font-weight:900;">{{authMode==='login'?'æ¬¢è¿å›æ¥':'æ³¨å†Œè´¦å·'}}</h3>
            <div v-if="authMode==='register'" style="text-align:center;margin-bottom:10px;" @click="$refs.avatarInput.click()">
                <div style="width:60px;height:60px;background:#f1f5f9;border-radius:50%;margin:0 auto;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                    <img v-if="authForm.avatar" :src="authForm.avatar" style="width:100%;height:100%;object-fit:cover;">
                    <i v-else class="ri-camera-fill" style="font-size:24px;color:#cbd5e1;"></i>
                </div>
                <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
            </div>
            <input v-model="authForm.username" class="input-field" placeholder="è´¦å· (>=8ä½)">
            <input v-model="authForm.password" type="password" class="input-field" placeholder="å¯†ç  (>=6ä½)">
            <input v-if="authMode==='register'" v-model="authForm.nickname" class="input-field" placeholder="æ˜µç§°">
            <button class="btn-primary" @click="handleAuth" :disabled="isAuthing">{{isAuthing?'å¤„ç†ä¸­...':'ç¡®å®š'}}</button>
            <div style="text-align:center;margin-top:15px;font-size:12px;color:#94a3b8;">
                <span @click="authMode=authMode==='login'?'register':'login'" style="cursor:pointer;">åˆ‡æ¢æ¨¡å¼</span>
                <span style="margin:0 10px;">|</span>
                <span @click="showAuthModal=false" style="cursor:pointer;">å…³é—­</span>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šèŠå¤© -->
    <div v-if="showChatModal" class="modal-mask">
        <div class="modal-box chat-modal">
            <div class="chat-header">
                <i class="ri-arrow-left-line" style="font-size:20px;cursor:pointer;" @click="showChatModal=false"></i>
                <span style="font-weight:bold;">{{chatTarget.nickname}}</span>
                <div style="width:20px;"></div>
            </div>
            <div class="chat-body" ref="chatContainer">
                <div v-if="!chatMessages.length" style="text-align:center;color:#ccc;margin-top:20px;font-size:12px;">æ‰“ä¸ªæ‹›å‘¼å§</div>
                <div v-for="msg in chatMessages" :key="msg.id" class="msg-row" :class="msg.sender===user.username?'mine':'other'">
                    <img :src="(msg.sender===user.username?user.avatar:chatTarget.avatar)||`https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.sender}`" class="msg-avatar">
                    <div style="display:flex;flex-direction:column;max-width:75%;">
                        <div class="msg-bubble" :style="{opacity: msg.pending?0.6:1}">{{msg.content}}</div>
                        <div class="msg-time" v-if="msg.timeStr">{{msg.timeStr}}</div>
                    </div>
                </div>
            </div>
            <div class="chat-footer">
                <input v-model="chatInput" id="chat-input" class="input-field" style="margin:0;" placeholder="å‘æ¶ˆæ¯..." @keyup.enter="sendChat">
                <button @click="sendChat" style="background:#0f172a;color:white;border:none;border-radius:50%;width:40px;height:40px;flex-shrink:0;"><i class="ri-send-plane-fill"></i></button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šæ¶ˆæ¯åˆ—è¡¨ -->
    <div v-if="showInboxModal" class="modal-mask">
        <div class="modal-box" style="height:60vh;">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
                <h3 style="font-weight:bold;">æ¶ˆæ¯</h3>
                <i class="ri-close-line" @click="showInboxModal=false" style="font-size:20px;"></i>
            </div>
            <div v-if="!inboxList.length" style="text-align:center;color:#ccc;font-size:12px;">æš‚æ— æ¶ˆæ¯</div>
            <div style="overflow-y:auto;">
                <div v-for="c in inboxList" :key="c.chatId" @click="openChat({username:c.otherUsername, nickname:c.otherNickname, avatar:c.otherAvatar}, c.chatId)" style="display:flex;gap:10px;padding:10px;border-bottom:1px solid #f1f5f9;cursor:pointer;position:relative;">
                    <img :src="c.otherAvatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${c.otherUsername}`" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                    <div style="flex:1;overflow:hidden;">
                        <div style="font-weight:bold;font-size:14px;">{{c.otherNickname}}</div>
                        <div style="color:#94a3b8;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{c.lastMsg}}</div>
                    </div>
                    <div v-if="c.unread>0" style="background:red;color:white;font-size:10px;height:16px;min-width:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px;">{{c.unread}}</div>
                    <i class="ri-delete-bin-line" style="color:#cbd5e1;" @click.stop="deleteChatSession(c.chatId)"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šä¸ªäººèµ„æ–™ -->
    <div v-if="showProfileModal" class="modal-mask">
        <div class="modal-box">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
                <h3 style="font-weight:bold;">{{isMyProfile?'ç¼–è¾‘èµ„æ–™':'ç”¨æˆ·èµ„æ–™'}}</h3>
                <i class="ri-close-line" @click="showProfileModal=false" style="font-size:20px;"></i>
            </div>
            <div style="text-align:center;margin-bottom:15px;">
                <img :src="viewingUser.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${viewingUser.username}`" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid white;box-shadow:0 4px 10px rgba(0,0,0,0.1);" @click="isMyProfile && $refs.profileAvatarInput.click()">
                <div style="font-weight:900;font-size:18px;margin-top:8px;">{{viewingUser.nickname}}</div>
                <div style="font-size:12px;color:#94a3b8;">@{{viewingUser.username}}</div>
                <input v-if="isMyProfile" type="file" ref="profileAvatarInput" hidden accept="image/*" @change="handleProfileAvatarChange">
            </div>
            
            <!-- æŸ¥çœ‹æ¨¡å¼ -->
            <div v-if="!isMyProfile" style="display:flex;flex-direction:column;gap:10px;">
                <div style="background:#f8fafc;padding:10px;border-radius:8px;font-size:12px;">
                    <div style="display:flex;justify-content:space-between;"><span>æ€§åˆ«</span><b>{{genderMap[viewingUser.gender]||'ä¿å¯†'}}</b></div>
                    <div style="display:flex;justify-content:space-between;margin-top:5px;"><span>æƒ³æ‰¾</span><b>{{targetMap[viewingUser.target]||'ä¸é™'}}</b></div>
                </div>
                <div v-if="viewingUser.qq" style="display:flex;justify-content:space-between;font-size:12px;background:#eff6ff;padding:8px;border-radius:8px;color:#3b82f6;"><span>QQ</span><span @click="copyText(viewingUser.qq,'QQ')">{{viewingUser.qq}} (å¤åˆ¶)</span></div>
                <div v-if="viewingUser.wx" style="display:flex;justify-content:space-between;font-size:12px;background:#f0fdf4;padding:8px;border-radius:8px;color:#22c55e;"><span>å¾®ä¿¡</span><span @click="copyText(viewingUser.wx,'VX')">{{viewingUser.wx}} (å¤åˆ¶)</span></div>
                <button class="btn-primary" @click="openChat(viewingUser)">å‘ç§ä¿¡</button>
            </div>
            
            <!-- ç¼–è¾‘æ¨¡å¼ -->
            <div v-else style="display:flex;flex-direction:column;gap:10px;">
                <input v-model="profileForm.qq" class="input-field" placeholder="QQ (é€‰å¡«)">
                <input v-model="profileForm.wx" class="input-field" placeholder="å¾®ä¿¡ (é€‰å¡«)">
                <div style="display:flex;gap:5px;">
                    <button style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;background:white;font-size:12px;" @click="profileForm.gender='male'" :style="profileForm.gender==='male'?'border-color:#3b82f6;color:#3b82f6':''">æˆ‘æ˜¯ç”·ç”Ÿ</button>
                    <button style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;background:white;font-size:12px;" @click="profileForm.gender='female'" :style="profileForm.gender==='female'?'border-color:#ec4899;color:#ec4899':''">æˆ‘æ˜¯å¥³ç”Ÿ</button>
                </div>
                <button class="btn-primary" @click="handleProfileUpdate" :disabled="isUpdatingProfile">ä¿å­˜</button>
                <button style="width:100%;padding:10px;background:none;border:none;color:#ef4444;font-size:12px;" @click="logout">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div v-if="showPostModal" class="modal-mask">
        <div class="modal-box" style="max-width:400px;">
            <h3 style="font-weight:bold;margin-bottom:15px;">å‘å¸ƒæ‰©åˆ—</h3>
            <textarea v-model="postForm.content" class="input-field" style="height:100px;resize:none;" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
            <div style="display:flex;gap:8px;margin-bottom:10px;">
                <div v-for="(img,i) in postForm.images" :key="i" style="width:60px;height:60px;border-radius:8px;overflow:hidden;position:relative;">
                    <img :src="img" style="width:100%;height:100%;object-fit:cover;">
                    <div @click="removeImage(i)" style="position:absolute;top:0;right:0;background:rgba(0,0,0,0.5);color:white;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;">x</div>
                </div>
                <div v-if="postForm.images.length<3" @click="$refs.pInput.click()" style="width:60px;height:60px;border:2px dashed #cbd5e1;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:24px;">+</div>
                <input type="file" ref="pInput" hidden accept="image/*" @change="handlePostImageUpload">
            </div>
            <div style="display:flex;gap:5px;overflow-x:auto;padding-bottom:5px;">
                <div v-for="g in games.slice(1)" :key="g" style="padding:4px 10px;border-radius:12px;font-size:10px;white-space:nowrap;border:1px solid #e2e8f0;" :style="postForm.game===g?'background:#0f172a;color:white':''" @click="postForm.game=g">{{g}}</div>
            </div>
            <input v-model="postForm.requirement" class="input-field" style="margin-top:10px;" placeholder="è¦æ±‚ (é€‰å¡«)">
            <div style="display:flex;gap:10px;margin-top:10px;">
                <button style="flex:1;padding:10px;border-radius:12px;border:1px solid #e2e8f0;background:white;" @click="showPostModal=false">å–æ¶ˆ</button>
                <button class="btn-primary" style="flex:1;margin:0;" @click="submitPost" :disabled="submitting">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆ -->
    <div v-if="preview.show" class="modal-mask" @click="preview.show=false" style="background:black;">
        <img :src="preview.list[preview.idx]" style="max-width:100%;max-height:100%;">
    </div>
</div>

<script>
    const { createApp, ref, onMounted, watch, nextTick, computed } = Vue;

    createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const posts = ref([]);
            const loading = ref(true);
            const error = ref('');
            const scrollY = ref(0);
            const notice = "æ¬¢è¿æ¥åˆ° CPDD æ‰©åˆ—å°ç«™ï¼ä¸¥ç¦å‘å¸ƒè¿è§„ä¿¡æ¯ã€‚";
            const windowWidth = ref(window.innerWidth);

            // Modals
            const showAuthModal = ref(false);
            const authMode = ref('login');
            const showPostModal = ref(false);
            const showProfileModal = ref(false);
            const showInboxModal = ref(false);
            const showChatModal = ref(false);
            const preview = ref({show:false, list:[], idx:0});

            // Forms
            const authForm = ref({username:'', password:'', nickname:'', avatar:''});
            const postForm = ref({content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]});
            const profileForm = ref({nickname:'', avatar:'', gender:'', target:'all', qq:'', wx:''});
            
            // Chat
            const inboxList = ref([]);
            const chatMessages = ref([]);
            const pendingMessages = ref([]);
            const chatTarget = ref({});
            const chatInput = ref('');
            const totalUnread = ref(0);
            let chatPoller = null;
            let inboxPoller = null;

            // Status
            const submitting = ref(false);
            const isAuthing = ref(false);
            const isUpdatingProfile = ref(false);
            const viewingUser = ref({});
            const isMyProfile = ref(false);

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');
            const columns = ref([[], [], []]);
            
            const genderMap = { male:'ç”·ç”Ÿ', female:'å¥³ç”Ÿ', secret:'ä¿å¯†' };
            const targetMap = { male:'æ‰¾ç”·ç”Ÿ', female:'æ‰¾å¥³ç”Ÿ', all:'ä¸é™' };

            // --- æ ¸å¿ƒé€»è¾‘ ---
            const updateColumns = () => {
                if(!Array.isArray(posts.value)) { posts.value=[]; return; }
                const cols = windowWidth.value < 640 ? 1 : (windowWidth.value < 1024 ? 2 : 3);
                const res = Array.from({length: cols}, () => []);
                const filtered = filterGame.value==='å…¨éƒ¨' ? posts.value : posts.value.filter(p => p.game === filterGame.value);
                filtered.forEach((p, i) => res[i % cols].push(p));
                columns.value = res;
            };

            const fetchPosts = async () => {
                loading.value = true;
                try {
                    const res = await fetch(API);
                    const data = await res.json();
                    if(Array.isArray(data)) posts.value = data;
                    else throw new Error('æ•°æ®å¼‚å¸¸');
                } catch(e) { error.value = e.message; posts.value = []; }
                loading.value = false;
            };

            // --- èŠå¤©é€»è¾‘ ---
            const currentChatId = computed(() => {
                if (!user.value || !chatTarget.value.username) return null;
                return [user.value.username, chatTarget.value.username].sort().join('_');
            });

            const mergedMessages = computed(() => {
                return [...serverMessages.value, ...pendingMessages.value].sort((a,b) => {
                    const ta = a.timestamp?._seconds ? a.timestamp._seconds * 1000 : a.timestamp;
                    const tb = b.timestamp?._seconds ? b.timestamp._seconds * 1000 : b.timestamp;
                    return ta - tb;
                });
            });

            const serverMessages = ref([]);

            const fetchChatHistory = async () => {
                if (!showChatModal.value) return;
                const reqId = currentChatId.value;
                const res = await fetch(`${API}?action=chat_history&u1=${user.value.username}&u2=${chatTarget.value.username}`);
                if (reqId !== currentChatId.value) return;
                const msgs = await res.json();
                if(Array.isArray(msgs)) {
                    serverMessages.value = msgs;
                    pendingMessages.value = pendingMessages.value.filter(p => 
                        !msgs.some(s => s.content === p.content && s.sender === p.sender && Math.abs(p.timestamp - (s.timestamp?s.timestamp._seconds*1000:0)) < 10000)
                    );
                    nextTick(() => {
                        const el = app._instance.refs.chatContainer;
                        // ç®€å•é€»è¾‘ï¼šåªè¦æœ‰æ–°æ¶ˆæ¯å°±æ»šåŠ¨åˆ°åº•éƒ¨
                        if(el) el.scrollTop = el.scrollHeight;
                    });
                }
            };

            const sendChat = async () => {
                if(!chatInput.value.trim()) return;
                const txt = chatInput.value; chatInput.value = '';
                const now = Date.now();
                pendingMessages.value.push({ id: now, sender: user.value.username, content: txt, timestamp: now, pending: true });
                
                // ç«‹å³æ»šåŠ¨
                nextTick(() => { const el = app._instance.refs.chatContainer; if(el) el.scrollTop = el.scrollHeight; });

                try {
                    await fetch(`${API}?action=chat_send`, {
                        method:'POST', body:JSON.stringify({ user:user.value, toUsername:chatTarget.value.username, content:txt })
                    });
                    fetchChatHistory();
                } catch(e) { alert('å‘é€å¤±è´¥'); pendingMessages.value = pendingMessages.value.filter(m=>m.id!==now); }
            };

            const openChat = async (target, chatId) => {
                showProfileModal.value = false; showInboxModal.value = false;
                chatTarget.value = target; serverMessages.value = []; pendingMessages.value = [];
                showChatModal.value = true;
                if(chatId) {
                    const c = inboxList.value.find(x=>x.chatId===chatId);
                    if(c && c.unread>0) { totalUnread.value -= c.unread; c.unread = 0; }
                    await fetch(`${API}?action=chat_read`, {method:'POST', body:JSON.stringify({user:user.value, chatId})});
                }
                fetchChatHistory();
                if(chatPoller) clearInterval(chatPoller);
                chatPoller = setInterval(fetchChatHistory, 3000);
                nextTick(() => document.getElementById('chat-input')?.focus());
            };
            
            const checkUnread = async () => {
                if (!user.value) return;
                try {
                    const res = await fetch(`${API}?action=chat_inbox&username=${user.value.username}`);
                    const list = await res.json();
                    if(Array.isArray(list)) {
                        totalUnread.value = list.reduce((s, c) => s + (c.unread || 0), 0);
                        inboxList.value = list;
                    }
                } catch(e){}
            };

            const openInbox = () => { if(!user.value) return showAuthModal.value=true; showInboxModal.value=true; checkUnread(); };

            // --- å…¶ä»–åŸºç¡€é€»è¾‘ ---
            const handleAvatarClick = async (u) => {
                if(!user.value) return showAuthModal.value=true;
                if(u===user.value.username) {
                    viewingUser.value=user.value; isMyProfile.value=true;
                    profileForm.value={...user.value, gender:user.value.gender||'', target:user.value.target||'all'};
                } else {
                    try {
                        const res = await fetch(`${API}?action=get_user_profile&username=${u}`);
                        if(res.ok) { viewingUser.value=await res.json(); isMyProfile.value=false; }
                    } catch(e){ return; }
                }
                showProfileModal.value=true;
            };

            const handleAuth = async () => {
                if(!authForm.value.username) return alert('è¯·è¾“å…¥è´¦å·');
                isAuthing.value = true;
                try {
                    const res = await fetch(`${API}?action=${authMode.value}`, {method:'POST', body:JSON.stringify(authForm.value)});
                    const d = await res.json();
                    if(d.error) alert(d.error);
                    else { user.value = d.user; localStorage.setItem('cp_user', JSON.stringify(d.user)); showAuthModal.value = false; fetchPosts(); }
                } catch(e){ alert('ç½‘ç»œé”™è¯¯'); }
                isAuthing.value = false;
            };

            const compress = (file) => new Promise(resolve => {
                const r = new FileReader(); r.onload = e => {
                    const img = new Image(); img.onload = () => {
                        const cvs = document.createElement('canvas');
                        let w=img.width, h=img.height; const MAX=1200;
                        if(w>MAX){ h*=MAX/w; w=MAX; } cvs.width=w; cvs.height=h;
                        cvs.getContext('2d').drawImage(img,0,0,w,h);
                        let q=0.9, d=cvs.toDataURL('image/jpeg', q);
                        while(d.length>300000 && q>0.3){ q-=0.1; d=cvs.toDataURL('image/jpeg', q); }
                        resolve(d);
                    }; img.src = e.target.result;
                }; r.readAsDataURL(file);
            });

            const handleAvatarUpload = async (e) => { if(e.target.files[0]) authForm.value.avatar = await compress(e.target.files[0]); };
            const handleProfileAvatarChange = async (e) => { if(e.target.files[0]) profileForm.value.avatar = await compress(e.target.files[0]); };
            const handlePostImageUpload = async (e) => { if(e.target.files[0] && postForm.value.images.length<3) postForm.value.images.push(await compress(e.target.files[0])); e.target.value=''; };

            const submitPost = async () => {
                if(!postForm.value.content) return alert('å†™ç‚¹ä»€ä¹ˆ');
                submitting.value = true;
                try {
                    const res = await fetch(`${API}?action=create_post`, {method:'POST', body:JSON.stringify({user:user.value, ...postForm.value})});
                    if(res.ok) { showPostModal.value=false; postForm.value={content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]}; fetchPosts(); }
                    else alert('å‘å¸ƒå¤±è´¥');
                } catch(e){ alert('ç½‘ç»œé”™è¯¯'); }
                submitting.value = false;
            };
            
            const deletePost = async (id) => { if(confirm('åˆ ï¼Ÿ')) { await fetch(`${API}?action=delete_post`, {method:'POST', body:JSON.stringify({id, user:user.value})}); fetchPosts(); } };
            const handleProfileUpdate = async () => { isUpdatingProfile.value = true; await fetch(`${API}?action=update_profile`, {method:'POST', body:JSON.stringify({username:user.value.username, user:user.value, ...profileForm.value})}); user.value={...user.value, ...profileForm.value}; localStorage.setItem('cp_user', JSON.stringify(user.value)); isUpdatingProfile.value = false; alert('ä¿å­˜æˆåŠŸ'); showProfileModal.value = false; };
            
            const triggerReply = (p, c) => { if(!user.value) return showAuthModal.value=true; p.newCommentInput = `å›å¤ @${c.nickname} : `; nextTick(()=>document.getElementById('input-'+p.id)?.focus()); };
            const submitComment = async (p) => { if(!user.value) return showAuthModal.value=true; if(!p.newCommentInput) return; const txt = p.newCommentInput; p.newCommentInput=''; if(!p.commentList) p.commentList=[]; p.commentList.push({id:Date.now(), nickname:user.value.nickname, username:user.value.username, content:txt}); await fetch(`${API}?action=add_comment`, {method:'POST', body:JSON.stringify({postId:p.id, user:user.value, content:txt})}); };
            const deleteComment = async (p, cid) => { if(confirm('åˆ ï¼Ÿ')) { await fetch(`${API}?action=delete_comment`, {method:'POST', body:JSON.stringify({postId:p.id, commentId:cid, user:user.value})}); p.commentList = p.commentList.filter(c=>c.id!==cid); } };
            const toggleComments = async (p) => { p.showComments=!p.showComments; if(p.showComments && !p.loaded) { try { p.commentList=await (await fetch(`${API}?action=get_comments&postId=${p.id}`)).json(); p.loaded=true; } catch(e){} } };
            const isLiked = (p) => { if(!p.likedIds) return false; if(user.value) return p.likedIds.includes('user:'+user.value.username); const l=JSON.parse(localStorage.getItem('cp_likes')||'[]'); return l.includes(p.id); };
            const handleLike = async (p) => { 
                const liked = isLiked(p);
                if(liked) { p.likes--; if(user.value) p.likedIds=p.likedIds.filter(x=>x!=='user:'+user.value.username); else { const l=JSON.parse(localStorage.getItem('cp_likes')||'[]'); localStorage.setItem('cp_likes', JSON.stringify(l.filter(x=>x!==p.id))); p.likedIds=[]; } }
                else { p.likes++; if(user.value) { if(!p.likedIds) p.likedIds=[]; p.likedIds.push('user:'+user.value.username); } else { const l=JSON.parse(localStorage.getItem('cp_likes')||'[]'); l.push(p.id); localStorage.setItem('cp_likes', JSON.stringify(l)); if(!p.likedIds) p.likedIds=[]; p.likedIds.push('temp'); } }
                await fetch(`${API}?action=like`, {method:'POST', body:JSON.stringify({id:p.id, user:user.value})});
            };

            const logout = () => { user.value = null; localStorage.removeItem('cp_user'); showProfileModal.value = false; };
            const copyText = (t, l) => { navigator.clipboard.writeText(t).then(()=>alert(`å¤åˆ¶${l}æˆåŠŸ`)); };
            const removeImage = (i) => postForm.value.images.splice(i,1);
            const previewImage = (l,i) => preview.value = {show:true, list:l, idx:i};
            const scrollToTop = () => window.scrollTo({top:0, behavior:'smooth'});
            const checkAuthAndPost = () => user.value ? showPostModal.value = true : showAuthModal.value = true;
            const deleteChatSession = async (cid) => { if(confirm('åˆ ï¼Ÿ')) { await fetch(`${API}?action=delete_chat_session`, {method:'POST', body:JSON.stringify({user:user.value, chatId:cid})}); inboxList.value=inboxList.value.filter(x=>x.chatId!==cid); } };

            watch([filterGame, posts], updateColumns);
            window.onresize = () => { windowWidth.value = window.innerWidth; updateColumns(); };
            window.onscroll = () => scrollY.value = window.scrollY;
            watch(showChatModal, (v) => { if(!v && chatPoller) clearInterval(chatPoller); });
            watch(user, (u) => { if(u && !inboxPoller) inboxPoller=setInterval(checkUnread, 10000); else if(!u && inboxPoller) clearInterval(inboxPoller); });

            onMounted(() => {
                const load = document.getElementById('static-loading');
                if(load) { load.style.opacity=0; setTimeout(()=>load.remove(), 500); }
                try { const u = localStorage.getItem('cp_user'); if(u) user.value = JSON.parse(u); } catch(e){}
                fetchPosts();
                if(user.value) { checkUnread(); inboxPoller = setInterval(checkUnread, 10000); }
            });

            return {
                user, loading, error, posts, columns, games, filterGame, notice, scrollY,
                showAuthModal, authMode, authForm, isAuthing, showPostModal, postForm, submitting, preview,
                showProfileModal, profileForm, isUpdatingProfile, viewingUser, isMyProfile, genderMap, targetMap,
                showInboxModal, inboxList, showChatModal, chatMessages: mergedMessages, chatTarget, chatInput, totalUnread,
                refresh: fetchPosts, changeFilter: (g)=>filterGame.value=g,
                handleAuth, handleAvatarUpload, handlePostImageUpload, submitPost, handleProfileAvatarChange, handleProfileUpdate,
                deletePost, toggleComments, submitComment, deleteComment, isLiked, handleLike,
                logout, copyText, removeImage, previewImage, scrollToTop, checkAuthAndPost,
                handleAvatarClick, openInbox, openChat, sendChat, deleteChatSession, triggerReply
            };
        }
    }).mount('#app');
</script>
</body>
</html>
