<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å°ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* --- æ¢¦å¹»èƒŒæ™¯ --- */
        body { 
            background-color: #fdf4f6;
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 228, 230, 0.5) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(233, 213, 255, 0.5) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(196, 181, 253, 0.3) 0px, transparent 50%);
            background-attachment: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #334155;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* --- ä¸æ»‘åŠ¨ç”» --- */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(20px); }
        .list-move { transition: transform 0.4s ease; }

        /* --- ç²¾è‡´å¡ç‰‡ --- */
        .app-card {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px -10px rgba(244, 114, 182, 0.15), 0 4px 6px -2px rgba(0,0,0,0.02);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255,255,255,0.6);
            overflow: hidden;
        }
        .app-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px -10px rgba(244, 114, 182, 0.25);
        }

        /* --- æ ‡ç­¾é£æ ¼ --- */
        .tag { font-size: 11px; font-weight: 700; padding: 4px 12px; border-radius: 20px; transition: all 0.3s; }
        .tag-active { background: #333; color: #fff; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tag-inactive { background: #fff; color: #94a3b8; border: 1px solid #e2e8f0; }
        .tag-inactive:hover { color: #64748b; border-color: #cbd5e1; }

        /* --- æ¸¸æˆè§’æ ‡ --- */
        .game-badge {
            background: #fff1f2; color: #e11d48; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
        }

        /* --- åº•éƒ¨å®‰å…¨åŒº --- */
        .pb-safe { padding-bottom: calc(80px + env(safe-area-inset-bottom)); }
        .fab-safe { bottom: calc(24px + env(safe-area-inset-bottom)); }

        /* --- å›¾ç‰‡ Grid (ä¿®æ­£ç‰ˆ) --- */
        .img-grid { display: grid; gap: 4px; border-radius: 12px; overflow: hidden; margin-top: 12px; }
        .img-grid-1 { grid-template-columns: 1fr; }
        .img-grid-2 { grid-template-columns: 1fr 1fr; }
        .img-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .img-item { aspect-ratio: 1/1; width: 100%; object-fit: cover; cursor: zoom-in; transition: filter 0.2s; }
        .img-item:hover { filter: brightness(0.95); }
        /* å•å¼ å›¾ç‰¹æ®Šå¤„ç† */
        .img-grid-1 .img-item { aspect-ratio: 16/9; max-height: 240px; }

    </style>
</head>
<body>

<div id="app" class="min-h-screen">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="fixed top-0 inset-x-0 z-40 bg-white/80 backdrop-blur-xl border-b border-pink-100/50 h-16 flex items-center justify-between px-4 sm:px-8 transition-all" :class="{'shadow-sm': scrollY > 20}">
        <div class="flex items-center gap-2 cursor-pointer" @click="refresh">
            <div class="bg-gradient-to-br from-rose-400 to-orange-300 w-9 h-9 rounded-xl flex items-center justify-center text-white shadow-lg shadow-rose-200">
                <i class="ri-heart-fill"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight hidden sm:block">CPDD æ‰©åˆ—å°ç«™</h1>
            <h1 class="text-lg font-bold text-slate-800 tracking-tight sm:hidden">CPDD</h1>
        </div>

        <div v-if="user" class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
                <div class="text-xs font-bold text-slate-700">{{ user.nickname }}</div>
                <div v-if="user.isAdmin" class="text-[10px] text-rose-500 font-bold">ç®¡ç†å‘˜</div>
            </div>
            <img :src="user.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`" class="w-9 h-9 rounded-full border border-white shadow-md object-cover bg-rose-50">
            <button @click="logout" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-rose-50 hover:text-rose-500 flex items-center justify-center transition-colors">
                <i class="ri-logout-box-line"></i>
            </button>
        </div>
        <button v-else @click="showAuthModal = true" class="bg-slate-900 text-white text-xs font-bold px-5 py-2.5 rounded-full shadow-lg shadow-slate-200 hover:scale-105 active:scale-95 transition-all">
            ç™»å½• / æ³¨å†Œ
        </button>
    </header>

    <!-- å ä½ï¼Œå› ä¸º Header æ˜¯ fixed -->
    <div class="h-16"></div>

    <!-- æ¸¸æˆç­›é€‰ (å¸é¡¶) -->
    <div class="sticky top-16 z-30 bg-white/90 backdrop-blur-md border-b border-slate-50 py-3 px-4 overflow-x-auto hide-scrollbar">
        <div class="flex gap-2 sm:justify-center min-w-max">
            <button v-for="g in games" :key="g" 
                @click="changeFilter(g)"
                class="tag"
                :class="filterGame === g ? 'tag-active' : 'tag-inactive'">
                {{ g }}
            </button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ï¼šæ™ºèƒ½ç€‘å¸ƒæµ -->
    <main class="max-w-7xl mx-auto px-4 pt-6 pb-safe">
        
        <!-- Loading -->
        <div v-if="loading" class="flex flex-col items-center justify-center py-32 text-rose-300 animate-pulse">
            <i class="ri-heart-pulse-fill text-5xl mb-4"></i>
            <p class="text-sm font-medium tracking-widest">æ­£åœ¨å¯»æ‰¾å¿ƒåŠ¨ä¿¡å·...</p>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-else-if="posts.length === 0" class="text-center py-32 animate-fade-in">
            <div class="text-6xl mb-4">ğŸ“ª</div>
            <h3 class="text-slate-800 font-bold text-lg">è¿˜æ²¡æœ‰äººå‘å¸–å‘¢</h3>
            <p class="text-slate-400 text-sm mt-1">å¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªæ‰©åˆ—çš„äººå§ï¼</p>
        </div>

        <!-- ç€‘å¸ƒæµåˆ—å®¹å™¨ -->
        <div v-else class="flex gap-5 items-start">
            <!-- åŠ¨æ€ç”Ÿæˆåˆ—ï¼šåˆ—1, åˆ—2, (åˆ—3) -->
            <div v-for="(col, colIndex) in columns" :key="colIndex" class="flex-1 flex flex-col gap-5 min-w-0">
                <transition-group name="list">
                    <div v-for="post in col" :key="post.id" class="app-card p-5 group relative">
                        
                        <!-- å¤´éƒ¨ -->
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-rose-50 p-0.5 shrink-0">
                                    <img :src="post.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.username}`" class="w-full h-full rounded-full object-cover bg-white">
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="text-sm font-bold text-slate-800">{{ post.nickname }}</span>
                                        <span class="game-badge">{{ post.game }}</span>
                                    </div>
                                    <div class="text-[10px] text-slate-400 mt-0.5 font-medium">{{ post.timeStr }}</div>
                                </div>
                            </div>
                            <!-- ç®¡ç†å‘˜åˆ å¸– -->
                            <button v-if="user && user.isAdmin" @click="deletePost(post.id)" class="text-slate-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>

                        <!-- æ­£æ–‡ -->
                        <div class="text-[14px] text-slate-600 leading-relaxed whitespace-pre-wrap break-words mb-3">{{ post.desc }}</div>

                        <!-- å¯»æ‰¾é˜Ÿå‹ Tag -->
                        <div v-if="post.requirement" class="bg-gradient-to-r from-rose-50 to-white border border-rose-100 rounded-xl p-3 mb-3">
                            <div class="flex items-center gap-1 text-xs font-bold text-rose-500 mb-1">
                                <i class="ri-magic-line"></i> å¯»æ‰¾é˜Ÿå‹
                            </div>
                            <div class="text-xs text-slate-500 leading-relaxed break-words">{{ post.requirement }}</div>
                        </div>

                        <!-- å›¾ç‰‡ Grid -->
                        <div v-if="post.images && post.images.length" 
                             class="img-grid" 
                             :class="'img-grid-' + Math.min(post.images.length, 3)">
                            <img v-for="(img, idx) in post.images" :key="idx" 
                                 :src="img" 
                                 class="img-item"
                                 @click.stop="previewImage(post.images, idx)">
                        </div>

                        <!-- åº•éƒ¨æ  -->
                        <div class="flex items-center justify-between mt-4 pt-3 border-t border-slate-50">
                            <button @click="toggleComments(post)" class="flex items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors px-2 py-1 rounded-full hover:bg-slate-50">
                                <i class="ri-chat-3-line text-lg"></i>
                                <span class="text-xs font-bold">{{ post.commentsCount || 0 }}</span>
                            </button>

                            <button @click="handleLike(post)" 
                                class="flex items-center gap-1 px-2 py-1 rounded-full transition-all active:scale-90"
                                :class="isLiked(post) ? 'text-rose-500 bg-rose-50' : 'text-slate-400 hover:bg-slate-50'">
                                <i :class="isLiked(post) ? 'ri-heart-3-fill' : 'ri-heart-3-line'" class="text-lg"></i>
                                <span class="text-xs font-bold">{{ post.likes || 0 }}</span>
                            </button>
                        </div>

                        <!-- è¯„è®ºåŒº (å±•å¼€) -->
                        <div v-if="post.showComments" class="mt-3 pt-3 border-t border-dashed border-slate-200 animate-fade-in">
                            <div v-if="post.loadingComments" class="text-center text-xs text-slate-400 py-2">åŠ è½½ä¸­...</div>
                            <div v-else>
                                <div v-if="!post.commentList || post.commentList.length === 0" class="text-center text-xs text-slate-300 py-4">
                                    æ²™å‘æ˜¯ç©ºçš„ï¼Œå¿«æ¥å~
                                </div>
                                <div class="space-y-3 mb-3 max-h-40 overflow-y-auto pr-1">
                                    <div v-for="cmt in post.commentList" :key="cmt.id" class="flex gap-2 text-xs group/cmt">
                                        <img :src="cmt.avatar || `https://api.dicebear.com/7.x/avataaars/svg`" class="w-5 h-5 rounded-full bg-slate-100">
                                        <div class="flex-1">
                                            <div class="flex justify-between">
                                                <span class="font-bold text-slate-700">{{ cmt.nickname }}</span>
                                                <button v-if="user && user.isAdmin" @click="deleteComment(post, cmt.id)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover/cmt:opacity-100"><i class="ri-delete-bin-line"></i></button>
                                            </div>
                                            <p class="text-slate-500 mt-0.5 break-all">{{ cmt.content }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <input v-model="post.newCommentInput" placeholder="å‹å–„å‘è¨€..." class="flex-1 bg-slate-50 border-none rounded-full px-3 py-1.5 text-xs focus:ring-1 focus:ring-rose-200 outline-none">
                                    <button @click="submitComment(post)" class="text-rose-500 font-bold text-xs px-2">å‘é€</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </transition-group>
            </div>
        </div>

    </main>

    <!-- æ‚¬æµ®æŒ‰é’®ç»„ -->
    <div class="fixed right-5 z-40 flex flex-col gap-3 fab-safe">
        <!-- å›åˆ°é¡¶éƒ¨ -->
        <transition name="fade">
            <button v-show="scrollY > 400" @click="scrollToTop" class="w-12 h-12 bg-white text-slate-400 rounded-full shadow-lg border border-slate-100 flex items-center justify-center hover:text-rose-500 transition-colors">
                <i class="ri-arrow-up-line text-xl"></i>
            </button>
        </transition>
        <!-- å‘å¸ƒæŒ‰é’® -->
        <button @click="checkAuthAndPost" class="w-14 h-14 bg-slate-900 text-white rounded-full shadow-xl shadow-slate-300 flex items-center justify-center hover:scale-105 active:scale-95 transition-all group">
            <i class="ri-add-line text-2xl group-hover:rotate-90 transition-transform duration-300"></i>
        </button>
    </div>

    <!-- è®¤è¯å¼¹çª— -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/50 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-xs rounded-[32px] shadow-2xl overflow-hidden p-6">
            <h3 class="text-center font-bold text-xl mb-6 text-slate-800">{{ authMode === 'login' ? 'æ¬¢è¿å›æ¥' : 'åŠ å…¥æˆ‘ä»¬' }}</h3>
            
            <!-- åˆ‡æ¢æ  -->
            <div class="flex bg-slate-50 p-1 rounded-xl mb-6">
                <button @click="authMode='login'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all" :class="authMode==='login' ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'">ç™»å½•</button>
                <button @click="authMode='register'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all" :class="authMode==='register' ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'">æ³¨å†Œ</button>
            </div>

            <div class="space-y-4">
                <!-- å¤´åƒä¸Šä¼  (ä»…æ³¨å†Œ) -->
                <div v-if="authMode==='register'" class="flex justify-center">
                     <div class="w-20 h-20 rounded-full bg-slate-50 border-2 border-dashed border-rose-200 flex items-center justify-center text-rose-300 cursor-pointer hover:bg-rose-50 transition-colors relative overflow-hidden" @click="$refs.avatarInput.click()">
                        <img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover">
                        <i v-else class="ri-camera-fill text-2xl"></i>
                        <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
                     </div>
                </div>

                <input v-model="authForm.username" placeholder="è´¦å· (è‡³å°‘8ä½)" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-rose-100 outline-none transition-all">
                <input v-model="authForm.password" type="password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-rose-100 outline-none transition-all">
                <input v-if="authMode==='register'" v-model="authForm.nickname" placeholder="ç»™è‡ªå·±èµ·ä¸ªæ˜µç§°" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-rose-100 outline-none transition-all">
            
                <button @click="handleAuth" :disabled="isAuthing" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-200 active:scale-95 transition-all disabled:opacity-70 mt-2">
                    {{ isAuthing ? 'å¤„ç†ä¸­...' : (authMode==='login' ? 'ç™» å½•' : 'åˆ›å»ºè´¦å·') }}
                </button>
            </div>
            <div class="text-center mt-4">
                <button @click="showAuthModal=false" class="text-xs font-bold text-slate-400 hover:text-slate-600">æš‚ä¸ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col animate-fade-in">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-50">
            <button @click="showPostModal = false" class="w-8 h-8 rounded-full bg-slate-50 text-slate-500 flex items-center justify-center"><i class="ri-close-line"></i></button>
            <h3 class="font-bold text-slate-800">å‘å¸ƒåŠ¨æ€</h3>
            <button @click="submitPost" :disabled="submitting" class="bg-rose-500 text-white px-5 py-1.5 rounded-full text-sm font-bold disabled:opacity-50 shadow-lg shadow-rose-200">
                {{ submitting ? 'å‘é€ä¸­' : 'å‘å¸ƒ' }}
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 pb-20">
            <textarea v-model="postForm.content" class="w-full h-32 text-base resize-none focus:outline-none placeholder-slate-300 leading-relaxed" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea>
            
            <div class="flex flex-wrap gap-3 mb-8">
                <div v-for="(img, idx) in postForm.images" :key="idx" class="w-24 h-24 rounded-2xl bg-slate-50 relative overflow-hidden border border-slate-100">
                    <img :src="img" class="w-full h-full object-cover">
                    <button @click="removeImage(idx)" class="absolute top-1 right-1 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm backdrop-blur-sm"><i class="ri-close-line"></i></button>
                </div>
                <div v-if="postForm.images.length < 3" @click="$refs.postImgInput.click()" class="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-300 cursor-pointer active:bg-slate-50 transition-colors">
                    <i class="ri-image-add-line text-2xl"></i>
                    <span class="text-[10px] mt-1">æœ€å¤š3å¼ </span>
                </div>
                <input type="file" ref="postImgInput" hidden accept="image/*" @change="handlePostImageUpload">
            </div>

            <div class="space-y-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wider">é€‰æ‹©åˆ†åŒº</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="g in games.slice(1)" :key="g" 
                              @click="postForm.game = g"
                              class="px-4 py-2 rounded-xl text-xs font-bold border transition-all"
                              :class="postForm.game === g ? 'bg-slate-800 text-white border-slate-800 shadow-lg shadow-slate-200' : 'bg-white text-slate-500 border-slate-200'">
                            {{ g }}
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">æ‰©åˆ—è¦æ±‚ (é€‰å¡«)</label>
                    <div class="bg-slate-50 rounded-2xl px-4 py-3 border border-slate-100 focus-within:bg-white focus-within:border-rose-200 transition-colors flex items-center gap-2">
                        <i class="ri-vip-crown-line text-rose-300"></i>
                        <input v-model="postForm.requirement" class="flex-1 bg-transparent text-sm outline-none placeholder-slate-400" placeholder="ä¾‹å¦‚ï¼šå¿ƒæ€å¥½ï¼Œä¸å‹åŠ›...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆ -->
    <div v-if="preview.show" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center backdrop-blur-sm animate-fade-in" @click="preview.show = false">
        <img :src="preview.list[preview.idx]" class="max-w-full max-h-[90vh] object-contain shadow-2xl" @click.stop>
        <div v-if="preview.list.length > 1" class="absolute bottom-10 flex gap-3" @click.stop>
             <button v-for="(img, idx) in preview.list" :key="idx" @click="preview.idx = idx" class="w-2 h-2 rounded-full transition-all" :class="preview.idx === idx ? 'bg-white scale-150' : 'bg-white/30'"></button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const allPosts = ref([]); // åŸå§‹æ•°æ®
            const loading = ref(true);
            const scrollY = ref(0);
            
            // å“åº”å¼çŠ¶æ€
            const showAuthModal = ref(false);
            const authMode = ref('login');
            const showPostModal = ref(false);
            const submitting = ref(false);
            const isAuthing = ref(false);
            const preview = ref({ show: false, list: [], idx: 0 });

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');

            const authForm = ref({ username: '', password: '', nickname: '', avatar: '' });
            const postForm = ref({ content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] });

            // --- æ ¸å¿ƒï¼šæ™ºèƒ½åˆ—å¸ƒå±€ (Masonry) ---
            const columns = ref([[], [], []]); // é»˜è®¤3åˆ—
            const windowWidth = ref(window.innerWidth);

            const updateColumns = () => {
                // æ ¹æ®å±å¹•å®½åº¦å†³å®šåˆ—æ•°
                const colCount = windowWidth.value < 640 ? 1 : (windowWidth.value < 1024 ? 2 : 3);
                
                // é‡æ–°åˆ†é…æ•°æ®åˆ°åˆ—ä¸­
                const newCols = Array.from({ length: colCount }, () => []);
                const filtered = filterGame.value === 'å…¨éƒ¨' ? allPosts.value : allPosts.value.filter(p => p.game === filterGame.value);
                
                // ç®€å•åˆ†é…ç­–ç•¥ï¼šè½®æµå‘ç‰Œ (ä¿è¯æ—¶é—´é¡ºåºå¤§è‡´æ­£ç¡®ï¼šå·¦->å³ï¼Œä¸Š->ä¸‹)
                filtered.forEach((post, index) => {
                    newCols[index % colCount].push(post);
                });
                
                columns.value = newCols;
            };

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            const handleResize = () => {
                windowWidth.value = window.innerWidth;
                updateColumns();
            };

            watch(filterGame, () => updateColumns());
            watch(allPosts, () => updateColumns(), { deep: true });

            // --- ç”Ÿå‘½å‘¨æœŸ ---
            onMounted(() => {
                const savedUser = localStorage.getItem('cp_user');
                if (savedUser) user.value = JSON.parse(savedUser);
                
                window.addEventListener('scroll', () => scrollY.value = window.scrollY);
                window.addEventListener('resize', handleResize);
                fetchPosts();
            });

            onUnmounted(() => {
                window.removeEventListener('resize', handleResize);
            });

            // --- API äº¤äº’ ---
            const fetchPosts = async () => {
                loading.value = true;
                try {
                    const res = await fetch(API);
                    const data = await res.json();
                    allPosts.value = data;
                } catch(e) { console.error(e); }
                loading.value = false;
                updateColumns();
            };

            // --- ç‚¹èµé€»è¾‘ (æ ¸å¿ƒä¿®å¤) ---
            const likeCooldown = ref(false); // é˜²æŠ–é”

            const isLiked = (post) => {
                // 1. å¦‚æœæœ‰åç«¯è¿”å›çš„ likedIds
                if (post.likedIds && post.likedIds.length > 0) {
                    // æ£€æŸ¥ç™»å½•ç”¨æˆ·
                    if (user.value) {
                        return post.likedIds.includes(`user:${user.value.username}`);
                    }
                    // æ£€æŸ¥æœ¬åœ°è®°å½•çš„æ¸¸å®¢æ ‡è¯† (LocalStorage)
                    const localLikes = JSON.parse(localStorage.getItem('cp_likes_record') || '[]');
                    // è¿™é‡Œæ²¡åŠæ³•è·Ÿåç«¯å®Œå…¨ä¸€è‡´ï¼Œå› ä¸ºå‰ç«¯ä¸çŸ¥é“è‡ªå·±çš„ IP
                    // æ‰€ä»¥æˆ‘ä»¬é€€è€Œæ±‚å…¶æ¬¡ï¼šæ¸¸å®¢æ¨¡å¼ä¸‹ï¼Œä¾èµ– LocalStorage
                    return localLikes.includes(post.id);
                }
                return false;
            };

            const handleLike = async (post) => {
                if (likeCooldown.value) return;
                likeCooldown.value = true;
                setTimeout(() => likeCooldown.value = false, 500); // 500ms å†·å´

                const wasLiked = isLiked(post); // å½“å‰æ˜¯å¦å·²èµ
                
                // ä¹è§‚æ›´æ–° UI
                if (wasLiked) {
                    post.likes--;
                    // å¦‚æœæ˜¯æœ¬åœ°è®°å½•ï¼Œç§»é™¤
                    if (!user.value) {
                        const localLikes = JSON.parse(localStorage.getItem('cp_likes_record') || '[]');
                        const idx = localLikes.indexOf(post.id);
                        if (idx > -1) {
                            localLikes.splice(idx, 1);
                            localStorage.setItem('cp_likes_record', JSON.stringify(localLikes));
                        }
                        // å¼ºè¡Œåˆ·æ–°è§†å›¾ä¾èµ–
                        post.likedIds = []; // å‡è£…æ¸…ç©ºä¸€ä¸‹è§¦å‘é‡ç»˜ (ä¸å®Œç¾ä½†æœ‰æ•ˆ)
                    } else {
                         // æ¨¡æ‹Ÿä» likedIds ç§»é™¤è‡ªå·±
                         post.likedIds = post.likedIds.filter(id => id !== `user:${user.value.username}`);
                    }
                } else {
                    post.likes++;
                    // æœ¬åœ°è®°å½•æ·»åŠ 
                    if (!user.value) {
                        const localLikes = JSON.parse(localStorage.getItem('cp_likes_record') || '[]');
                        localLikes.push(post.id);
                        localStorage.setItem('cp_likes_record', JSON.stringify(localLikes));
                         // å¼ºè¡Œåˆ·æ–°
                        if(!post.likedIds) post.likedIds = [];
                        post.likedIds.push('temp'); // å ä½
                    } else {
                         if(!post.likedIds) post.likedIds = [];
                         post.likedIds.push(`user:${user.value.username}`);
                    }
                }

                try {
                    const res = await fetch(`${API}?action=like`, { 
                        method: 'POST', 
                        body: JSON.stringify({ id: post.id, user: user.value }) 
                    });
                    const data = await res.json();
                    // å¯ä»¥åœ¨è¿™é‡Œæ ¹æ® data.identifier ä¿®æ­£æœ¬åœ°å­˜å‚¨
                } catch (e) {
                    // å¤±è´¥å›æ»š
                    if (wasLiked) post.likes++; else post.likes--;
                }
            };

            // --- è¯„è®ºé€»è¾‘ ---
            const toggleComments = async (post) => {
                post.showComments = !post.showComments;
                if (post.showComments && !post.commentsLoaded) {
                    post.loadingComments = true;
                    try {
                        const res = await fetch(`${API}?action=get_comments&postId=${post.id}`);
                        post.commentList = await res.json();
                        post.commentsLoaded = true;
                    } catch(e){}
                    post.loadingComments = false;
                }
            };

            const submitComment = async (post) => {
                if (!user.value) return showAuthModal.value = true;
                if (!post.newCommentInput) return;
                
                const tempCmt = {
                    id: Date.now(),
                    nickname: user.value.nickname,
                    avatar: user.value.avatar,
                    content: post.newCommentInput
                };
                
                if (!post.commentList) post.commentList = [];
                post.commentList.push(tempCmt);
                post.commentsCount = (post.commentsCount || 0) + 1;
                const txt = post.newCommentInput;
                post.newCommentInput = '';

                await fetch(`${API}?action=add_comment`, {
                    method: 'POST',
                    body: JSON.stringify({ postId: post.id, user: user.value, content: txt })
                });
            };

            // --- å›¾ç‰‡ä¸å‘å¸ƒ ---
            const compressImage = (file, maxWidth = 800, quality = 0.8) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                            if (h > maxWidth) { w *= maxWidth/h; h = maxWidth; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleAvatarUpload = async (e) => {
                if(e.target.files[0]) authForm.value.avatar = await compressImage(e.target.files[0], 200, 0.7);
            };

            const handlePostImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (postForm.value.images.length >= 3) return alert('æœ€å¤š3å¼ å“¦');
                const base64 = await compressImage(file, 1024, 0.8);
                postForm.value.images.push(base64);
                e.target.value = ''; 
            };

            const handleAuth = async () => {
                const { username, password } = authForm.value;
                if (!username || !password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');
                if (authMode.value === 'register') {
                     if (username.length < 8) return alert('è´¦å·å¤ªçŸ­å•¦ (è‡³å°‘8ä½)');
                     if (username === 'admin' && !confirm("æ³¨å†Œç®¡ç†å‘˜?")) return;
                }
                isAuthing.value = true;
                try {
                    const res = await fetch(`${API}?action=${authMode.value}`, {
                        method: 'POST', body: JSON.stringify(authForm.value)
                    });
                    const data = await res.json();
                    if (data.error) alert(data.error);
                    else {
                        user.value = data.user;
                        localStorage.setItem('cp_user', JSON.stringify(data.user));
                        showAuthModal.value = false;
                    }
                } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
                isAuthing.value = false;
            };

            const submitPost = async () => {
                if (!postForm.value.content) return alert('å†™ç‚¹ä»€ä¹ˆå§');
                // æ£€æŸ¥å›¾ç‰‡å¤§å°
                const totalSize = postForm.value.images.reduce((acc, img) => acc + (img.length * 0.75), 0);
                if (totalSize > 950 * 1024) return alert('å›¾ç‰‡æ€»å¤§å°è¶…é™ï¼Œè¯·åˆ å‡');

                submitting.value = true;
                try {
                    const res = await fetch(`${API}?action=create_post`, {
                        method: 'POST', body: JSON.stringify({ user: user.value, ...postForm.value })
                    });
                    if (res.ok) {
                        showPostModal.value = false;
                        postForm.value = { content: '', game: 'ç‹è€…è£è€€', requirement: '', images: [] };
                        fetchPosts();
                    } else {
                        const err = await res.json();
                        alert(err.error || 'å‘å¸ƒå¤±è´¥');
                    }
                } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
                submitting.value = false;
            };

            // åˆ å¸– & åˆ è¯„è®º
            const deletePost = async (id) => {
                if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                await fetch(`${API}?action=delete_post`, { method: 'POST', body: JSON.stringify({ id, user: user.value }) });
                fetchPosts();
            };
            const deleteComment = async (post, cmtId) => {
                if (!confirm('ç¡®å®šåˆ é™¤è¯„è®ºï¼Ÿ')) return;
                await fetch(`${API}?action=delete_comment`, { method: 'POST', body: JSON.stringify({ postId: post.id, commentId: cmtId, user: user.value }) });
                post.commentList = post.commentList.filter(c => c.id !== cmtId);
                post.commentsCount--;
            };

            // å·¥å…·
            const changeFilter = (g) => { filterGame.value = g; };
            const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            const logout = () => { user.value = null; localStorage.removeItem('cp_user'); };
            const checkAuthAndPost = () => user.value ? showPostModal.value = true : showAuthModal.value = true;
            const removeImage = (idx) => postForm.value.images.splice(idx, 1);
            const previewImage = (list, idx) => preview.value = { show: true, list, idx };

            return {
                user, columns, loading, games, filterGame, changeFilter,
                showAuthModal, authMode, authForm, isAuthing,
                showPostModal, postForm, submitting, preview, scrollY,
                refresh: fetchPosts, logout, handleAuth, handleAvatarUpload,
                checkAuthAndPost, handlePostImageUpload, removeImage, submitPost,
                isLiked, handleLike, toggleComments, submitComment,
                deletePost, deleteComment, scrollToTop, previewImage
            };
        }
    }).mount('#app');
</script>
</body>
</html>
