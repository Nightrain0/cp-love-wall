<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CPDD æ‰©åˆ—å¼‚ä¸–ç•Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    <link href="https://cdn.staticfile.org/remixicon/3.5.0/remixicon.css" rel="stylesheet">
    <!-- å¼•å…¥æ›´åœ†æ¶¦çš„å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-pink: #ff9a9e;
            --primary-blue: #a18cd1;
            --bg-pattern: radial-gradient(#e5e7eb 1px, transparent 1px);
        }

        body { 
            background-color: #fdfbfb; 
            /* äºŒæ¬¡å…ƒé£æ ¼èƒŒæ™¯ï¼šæ¸å˜+æ³¢ç‚¹ */
            background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            font-family: 'Noto Sans SC', system-ui, -apple-system, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            color: #475569; 
            user-select: none; 
            position: relative;
        }

        /* å¯çˆ±çš„èƒŒæ™¯çº¹ç† */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-image: radial-gradient(#ffcce0 1.5px, transparent 1.5px), radial-gradient(#dbeafe 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            background-position: 0 0, 12px 12px;
            opacity: 0.4;
            z-index: -1;
            pointer-events: none;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        [v-cloak] { display: none !important; }
        
        /* åŠ¨ç”»ä¼˜åŒ–ï¼šæ›´æœ‰å¼¹æ€§çš„æ„Ÿè§‰ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .list-enter-active, .list-leave-active { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(40px) scale(0.9); }

        /* å¡ç‰‡æ ·å¼ï¼šæ›´è½¯èŒ */
        .app-card { 
            background: rgba(255, 255, 255, 0.9); /* å¢åŠ ä¸é€æ˜åº¦ï¼Œå‡å°‘èƒŒæ™¯å¹²æ‰° */
            backdrop-filter: blur(10px);
            border-radius: 24px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03), inset 0 0 0 1px rgba(255,255,255,0.5); 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            border: 1px solid rgba(255, 255, 255, 0.6);
            overflow: hidden; 
            margin-bottom: 20px; 
            break-inside: avoid; 
        }
        
        @media (min-width: 768px) { 
            .app-card:hover { 
                transform: translateY(-4px); /* ç§»é™¤ scaleï¼Œé˜²æ­¢å­—ä½“æ¨¡ç³Šï¼Œåªä¿ç•™ä¸Šæµ® */
                box-shadow: 0 15px 30px -5px rgba(255, 154, 158, 0.25); 
                border-color: #ffeff1;
            } 
        }

        /* æ ‡ç­¾æ ·å¼ï¼šç³–æœé£ */
        .tag { font-size: 13px; font-weight: 700; padding: 8px 18px; border-radius: 100px; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); white-space: nowrap; cursor: pointer; position: relative; overflow: hidden;}
        .tag-active { 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); 
            color: #fff; 
            transform: scale(1.05); 
            box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4); 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: none;
        }
        .tag-inactive { background: rgba(255,255,255,0.8); color: #64748b; border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .tag:active { transform: scale(0.95); }

        /* å›¾ç‰‡ç½‘æ ¼ */
        .img-grid { display: grid; gap: 6px; border-radius: 16px; overflow: hidden; margin-top: 12px; }
        .img-grid-1 { grid-template-columns: 1fr; }
        .img-grid-2 { grid-template-columns: 1fr 1fr; }
        .img-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .img-item { aspect-ratio: 1/1; width: 100%; object-fit: cover; cursor: zoom-in; transition: transform 0.3s; }
        .img-item:hover { transform: scale(1.05); }
        .img-grid-1 .img-item { aspect-ratio: 16/9; max-height: 280px; }

        .pb-safe { padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
        .fab-safe { bottom: calc(32px + env(safe-area-inset-bottom)); }

        /* éª¨æ¶å±åŠ¨ç”» */
        .skeleton { background: linear-gradient(90deg, #f0f9ff 25%, #e0f2fe 50%, #f0f9ff 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        /* èŠå¤©æ°”æ³¡ï¼šæ›´åœ†æ¶¦ */
        .chat-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 18px; }
        .chat-row.mine { flex-direction: row-reverse; }
        .chat-avatar { width: 36px; height: 36px; border-radius: 50%; background: #f1f5f9; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .chat-bubble-container { max-width: 78%; display: flex; flex-direction: column; }
        .chat-row.mine .chat-bubble-container { align-items: flex-end; }
        .chat-bubble { padding: 12px 16px; border-radius: 24px; font-size: 14px; line-height: 1.6; word-break: break-all; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .chat-row.mine .chat-bubble { 
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); 
            color: white; 
            border-bottom-right-radius: 4px; 
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .chat-row.other .chat-bubble { background: #fff; color: #475569; border-top-left-radius: 4px; border: 1px solid #eff6ff; }
        .chat-time { font-size: 10px; color: #94a3b8; margin-top: 5px; margin-left: 4px; margin-right: 4px; opacity: 0.8; }
        .chat-pending { opacity: 0.7; }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn-primary {
            background: linear-gradient(to right, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            color: white;
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:active { transform: scale(0.95); }
        .btn-dark {
            background: #334155;
            color: white;
            transition: all 0.2s;
        }
        .btn-dark:hover { background: #1e293b; transform: translateY(-1px); }

        /* å¼¹çª—ç»ç’ƒè´¨æ„Ÿ */
        .glass-modal {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* èŒç³» Loading */
        .loading-cat { font-size: 48px; animation: cat-bounce 0.8s infinite alternate; }
        @keyframes cat-bounce { from { transform: translateY(0); } to { transform: translateY(-15px) rotate(5deg); } }
    </style>
</head>
<body>

<!-- å¼€å±åŠ è½½ï¼šæ›´å¯çˆ± -->
<div id="static-loading" style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff;z-index:9999;transition:opacity 0.5s;">
    <div class="loading-cat">ğŸ±</div>
    <p style="color:#ff9a9e;font-size:14px;margin-top:15px;font-weight:bold;letter-spacing: 2px;">å°‘å¥³ç¥ˆç¥·ä¸­...</p>
</div>

<div id="app" v-cloak class="min-h-screen">
    
    <!-- å¤´éƒ¨ï¼šç»ç’ƒè´¨æ„Ÿ -->
    <header class="fixed top-0 inset-x-0 z-40 bg-white/70 backdrop-blur-xl border-b border-white/50 h-16 flex items-center justify-between px-5 transition-all" :class="{'shadow-sm': scrollY > 10}">
        <div class="flex items-center gap-2 cursor-pointer group" @click="refresh">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-300 to-purple-300 flex items-center justify-center text-white shadow-lg shadow-pink-200 group-hover:scale-110 transition-transform duration-300">
                <i class="ri-gamepad-fill text-xl"></i>
            </div>
            <div class="flex flex-col -space-y-1">
                <h1 class="text-xl font-black text-slate-800 tracking-tight">CPDD<span class="text-pink-400">.</span></h1>
                <span class="text-[10px] font-bold text-pink-300 tracking-widest">æ‰©åˆ—å¼‚ä¸–ç•Œ</span>
            </div>
        </div>
        <div v-if="user" class="flex items-center gap-3">
            <!-- ä¼˜åŒ–ï¼šæ›´é†’ç›®çš„ç§ä¿¡å…¥å£ï¼Œä½¿ç”¨æ¸å˜è‰²å¡«å…… -->
            <div class="relative cursor-pointer group transition-transform active:scale-90" @click="openInbox">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-violet-500 to-fuchsia-500 flex items-center justify-center shadow-lg shadow-fuchsia-200 hover:shadow-xl hover:-translate-y-0.5 transition-all border-2 border-white/50">
                     <i class="ri-chat-smile-3-fill text-xl text-white"></i>
                </div>
                <!-- çº¢ç‚¹åªåœ¨æœ‰æ¶ˆæ¯æ—¶æ˜¾ç¤ºï¼Œä½†æŒ‰é’®æœ¬èº«å¸¸é©» -->
                <div v-if="totalUnread > 0" class="absolute -top-1 -right-1 min-w-[18px] h-[18px] bg-rose-500 rounded-full text-[10px] text-white flex items-center justify-center border-2 border-white font-bold shadow-sm animate-bounce">
                    {{ totalUnread > 99 ? '99+' : totalUnread }}
                </div>
            </div>

            <div class="relative cursor-pointer group" @click="handleAvatarClick(user.username)">
                <div class="p-0.5 rounded-full bg-gradient-to-tr from-pink-300 to-blue-300 group-hover:rotate-12 transition-transform">
                    <img :src="user.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`" class="w-9 h-9 rounded-full border-2 border-white object-cover bg-white">
                </div>
            </div>
        </div>
        <button v-else @click="showAuthModal = true" class="bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold px-6 py-2.5 rounded-full shadow-lg shadow-slate-200 transition-all active:scale-95">
            <i class="ri-login-circle-line mr-1"></i> ç™»å…¥
        </button>
    </header>
    <div class="h-16"></div>

    <!-- æ ‡ç­¾æ ï¼šæ‚¬æµ®æ„Ÿ -->
    <div class="sticky top-16 z-30 bg-white/80 backdrop-blur-md py-3 px-4 overflow-x-auto hide-scrollbar mask-linear">
        <div class="flex gap-3 min-w-max px-1 py-1">
            <button v-for="g in games" :key="g" @click="changeFilter(g)" class="tag" :class="filterGame === g ? 'tag-active' : 'tag-inactive'">
                <span v-if="filterGame === g">âœ¨</span> {{ g }}
            </button>
        </div>
    </div>

    <div v-if="notice" class="max-w-5xl mx-auto px-4 mt-4">
        <div class="bg-gradient-to-r from-pink-50 to-white border border-pink-100 rounded-2xl p-3 flex gap-2 items-center text-xs text-pink-600 shadow-sm">
            <span class="bg-pink-100 text-pink-500 p-1 rounded-lg"><i class="ri-notification-heart-fill"></i></span> 
            <span class="font-medium">{{ notice }}</span>
        </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 pt-6 pb-safe">
        <div v-if="error" class="text-center py-20">
             <div class="text-5xl mb-4 animate-pulse">ğŸ˜µâ€ğŸ’«</div>
             <p class="text-sm text-slate-400 mb-6 font-bold bg-slate-100 inline-block px-4 py-2 rounded-full">{{ error }}</p>
             <button @click="refresh" class="btn-primary px-8 py-2.5 rounded-full text-sm font-bold shadow-lg shadow-pink-200">é‡æ–°è¿æ¥</button>
        </div>
        <div v-else-if="loading" class="text-center py-32 text-pink-300">
            <div class="loading-cat text-4xl mb-4">ğŸ¡</div>
            <p class="text-xs font-bold tracking-widest text-slate-300">æ­£åœ¨å¬å”¤é˜Ÿå‹...</p>
            <p v-if="showSlowTip" class="text-[10px] text-slate-400 mt-4 animate-pulse font-bold bg-slate-100 inline-block px-3 py-1 rounded-full">å¼‚ä¸–ç•Œé€šé“æœ‰ç‚¹æ‹¥å µï¼Œè¯·è€å¿ƒä¸€ç‚¹ç‚¹...</p>
        </div>
        <div v-else-if="!posts.length" class="text-center py-32 text-slate-400">
            <div class="text-6xl mb-4 opacity-50 grayscale">ğŸï¸</div>
            <p class="text-sm font-bold text-slate-400">è¿™é‡Œè¿˜æ˜¯æ— äººå²›å‘¢</p>
            <button @click="checkAuthAndPost" class="mt-6 text-pink-500 text-sm font-bold hover:text-pink-600 transition-colors flex items-center justify-center gap-1 mx-auto bg-pink-50 px-4 py-2 rounded-full">
                <i class="ri-add-circle-fill"></i> æˆä¸ºå²›ä¸»
            </button>
        </div>
        <div v-else class="flex gap-4 items-start">
            <div v-for="(col, i) in columns" :key="i" class="flex-1 flex flex-col gap-5 min-w-0">
                <!-- å¸–å­å¡ç‰‡ -->
                <div v-for="post in col" :key="post.id" class="app-card p-4 group relative">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3 cursor-pointer" @click.stop="handleAvatarClick(post.username)">
                            <div class="relative">
                                <img :src="post.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.username}`" class="w-11 h-11 rounded-full bg-white object-cover border-2 border-white shadow-sm">
                                <div v-if="post.gender==='female'" class="absolute -bottom-1 -right-1 w-4 h-4 bg-pink-400 rounded-full text-white flex items-center justify-center text-[10px] border border-white"><i class="ri-women-line"></i></div>
                                <div v-if="post.gender==='male'" class="absolute -bottom-1 -right-1 w-4 h-4 bg-blue-400 rounded-full text-white flex items-center justify-center text-[10px] border border-white"><i class="ri-men-line"></i></div>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-[15px] font-extrabold text-slate-700">{{ post.nickname }}</span>
                                </div>
                                <div class="flex gap-2 items-center mt-0.5">
                                    <span class="text-[10px] px-1.5 py-0.5 bg-slate-100 rounded-md text-slate-500 font-bold">{{ post.game }}</span>
                                    <span v-if="post.target==='male'" class="text-[9px] bg-blue-50 text-blue-400 px-1.5 py-0.5 rounded-md font-bold">æ‰¾å“¥å“¥</span>
                                    <span v-if="post.target==='female'" class="text-[9px] bg-pink-50 text-pink-400 px-1.5 py-0.5 rounded-md font-bold">æ‰¾å§å§</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-[10px] text-slate-300 font-mono mb-1">{{ post.timeStr }}</span>
                            <button v-if="user && (user.isAdmin || user.username === post.username)" @click="deletePost(post.id)" class="text-slate-300 hover:text-red-400 p-1 transition-colors"><i class="ri-delete-bin-2-line"></i></button>
                        </div>
                    </div>
                    
                    <div class="text-[14px] text-slate-600 mb-3 whitespace-pre-wrap break-words leading-relaxed font-medium">{{ post.desc }}</div>
                    
                    <div v-if="post.qq || post.wx" class="flex gap-2 mb-4">
                        <button v-if="post.qq" @click="copyText(post.qq, 'QQ')" class="flex items-center gap-1.5 text-[11px] bg-blue-50 text-blue-500 px-3 py-1.5 rounded-xl font-bold hover:bg-blue-100 hover:scale-105 transition-all shadow-sm border border-blue-100"><i class="ri-qq-fill"></i> {{ post.qq }}</button>
                        <button v-if="post.wx" @click="copyText(post.wx, 'å¾®ä¿¡')" class="flex items-center gap-1.5 text-[11px] bg-emerald-50 text-emerald-500 px-3 py-1.5 rounded-xl font-bold hover:bg-emerald-100 hover:scale-105 transition-all shadow-sm border border-emerald-100"><i class="ri-wechat-fill"></i> {{ post.wx }}</button>
                    </div>
                    
                    <div v-if="post.requirement" class="bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl p-3 mb-4 text-xs text-rose-700 border border-pink-100/50 flex gap-2 items-start">
                        <i class="ri-star-smile-fill text-pink-400 mt-0.5"></i>
                        <div class="leading-relaxed">{{ post.requirement }}</div>
                    </div>
                    
                    <div v-if="post.images && post.images.length" class="img-grid" :class="'img-grid-' + Math.min(post.images.length, 3)">
                        <img v-for="(img, idx) in post.images" :key="idx" :src="img" class="img-item" @click="previewImage(post.images, idx)">
                    </div>
                    
                    <div class="flex items-center justify-between mt-2 pt-3 border-t border-slate-100/50">
                        <button @click="toggleComments(post)" class="flex items-center gap-1.5 text-slate-400 hover:text-slate-600 text-xs font-bold px-2 py-1 rounded-lg hover:bg-slate-50 transition-colors">
                            <i class="ri-chat-smile-3-line text-lg"></i> {{ post.commentsCount || 'è¯„è®º' }}
                        </button>
                        <button @click="handleLike(post)" :disabled="post.liking" class="flex items-center gap-1.5 text-xs font-bold transition-all px-2 py-1 rounded-lg active:scale-90" :class="isLiked(post) ? 'text-pink-500' : 'text-slate-300 hover:text-pink-300'">
                            <i :class="isLiked(post) ? 'ri-heart-3-fill' : 'ri-heart-3-line'" class="text-lg"></i> {{ post.likes || 'ç‚¹èµ' }}
                        </button>
                    </div>
                    
                    <!-- è¯„è®ºåŒº -->
                    <div v-if="post.showComments" class="mt-3 pt-3 border-t border-dashed border-slate-200 animate-fade-in bg-slate-50/50 -mx-4 px-4 pb-2 rounded-b-2xl">
                        <div v-if="post.loadingComments" class="space-y-3 py-2"><div class="flex gap-2 items-center"><div class="skeleton w-7 h-7 rounded-full shrink-0"></div><div class="skeleton h-4 w-32 rounded-full"></div></div></div>
                        <div v-else>
                            <div v-if="!post.commentList?.length" class="text-center text-xs text-slate-300 py-4 italic">å¿«æ¥æŠ¢å æ²™å‘ (ï½¡â€¢Ì€á´—-)âœ§</div>
                            <div class="space-y-4 mb-3 max-h-60 overflow-y-auto custom-scrollbar pr-1 pt-2">
                                <div v-for="cmt in post.commentList" :key="cmt.id" class="flex gap-2.5 text-xs group/cmt" @touchstart="startLongPress(post, cmt)" @touchend="endLongPress" @touchmove="endLongPress">
                                    <img @click.stop="handleAvatarClick(cmt.username)" :src="cmt.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${cmt.username}`" class="w-8 h-8 rounded-full bg-white shrink-0 border border-white shadow-sm cursor-pointer hover:scale-110 transition-transform">
                                    <div class="flex-1 min-w-0 bg-white rounded-r-xl rounded-bl-xl p-2.5 shadow-sm border border-slate-100">
                                        <div class="flex justify-between items-baseline mb-1">
                                            <span class="font-bold text-slate-700">{{ cmt.nickname }}</span>
                                            <div class="flex items-center gap-2">
                                                <button v-if="user && user.username !== cmt.username" @click="triggerReply(post, cmt)" class="hidden md:block text-pink-400 hover:text-pink-600 font-bold opacity-0 group-hover/cmt:opacity-100 transition-opacity">å›å¤</button>
                                                <button v-if="user && (user.isAdmin || user.username === cmt.username)" @click="deleteComment(post, cmt.id)" class="text-slate-300 hover:text-red-400 font-bold"><i class="ri-close-circle-line"></i></button>
                                            </div>
                                        </div>
                                        <p class="text-slate-600 leading-relaxed break-all">{{ cmt.content }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 items-center mt-2 sticky bottom-0">
                                <input v-model="post.newCommentInput" :ref="'input-'+post.id" placeholder="âœ¨ è¯´ç‚¹å¥½å¬çš„..." class="flex-1 bg-white border border-slate-200 rounded-full px-4 py-2.5 text-xs focus:border-pink-300 focus:ring-2 focus:ring-pink-100 outline-none transition-all shadow-sm">
                                <button @click="submitComment(post)" class="w-9 h-9 rounded-full bg-gradient-to-r from-slate-700 to-slate-800 text-white flex items-center justify-center hover:shadow-lg hover:scale-105 active:scale-90 transition-all"><i class="ri-send-plane-2-fill text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æµ®åŠ¨æŒ‰é’®ç»„ -->
    <div class="fixed right-5 z-40 flex flex-col gap-4 fab-safe">
        <button v-show="scrollY > 300" @click="scrollToTop" class="w-11 h-11 bg-white/90 backdrop-blur rounded-full shadow-lg shadow-slate-200 text-slate-400 flex items-center justify-center border border-white hover:-translate-y-1 transition-all"><i class="ri-arrow-up-s-line text-xl"></i></button>
        <button @click="checkAuthAndPost" class="w-14 h-14 btn-primary rounded-full shadow-xl shadow-pink-200 flex items-center justify-center hover:-translate-y-1 active:scale-90 transition-all animate-bounce-slow">
            <i class="ri-add-line text-2xl"></i>
        </button>
    </div>

    <!-- æ¶ˆæ¯ä¸­å¿ƒå¼¹çª— -->
    <div v-if="showInboxModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/20 backdrop-blur-sm animate-fade-in">
        <div class="glass-modal w-full max-w-xs rounded-[32px] shadow-2xl flex flex-col h-[65vh] overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white/50">
                <h3 class="font-extrabold text-lg text-slate-700">ç§ä¿¡åˆ—è¡¨</h3>
                <button @click="showInboxModal=false" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-colors"><i class="ri-close-line"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-3 bg-white/30">
                <div v-if="!inboxList.length" class="flex flex-col items-center justify-center h-full text-slate-300 space-y-2">
                    <i class="ri-chat-private-line text-4xl opacity-50"></i>
                    <span class="text-xs font-bold">æš‚æ—¶æ²¡æœ‰ç§ä¿¡å“¦</span>
                </div>
                <div v-for="chat in inboxList" :key="chat.chatId" class="flex gap-3 items-center p-3 hover:bg-white rounded-2xl cursor-pointer transition-all mb-2 relative group border border-transparent hover:border-white hover:shadow-sm" @click="openChat({username: chat.otherUsername, nickname: chat.otherNickname, avatar: chat.otherAvatar}, chat.chatId)">
                    <img :src="chat.otherAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${chat.otherUsername}`" class="w-11 h-11 rounded-full bg-white object-cover border-2 border-white shadow-sm">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-sm text-slate-700">{{ chat.otherNickname }}</span>
                            <button @click.stop="deleteChatSession(chat.chatId)" class="w-6 h-6 rounded-full flex items-center justify-center text-slate-300 hover:bg-red-50 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all"><i class="ri-close-line"></i></button>
                        </div>
                        <p class="text-xs text-slate-400 truncate">{{ chat.lastMsg }}</p>
                    </div>
                    <div v-if="chat.unread > 0" class="absolute top-3 right-3 w-2.5 h-2.5 bg-red-400 rounded-full border border-white shadow-sm animate-pulse"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- èŠå¤©çª—å£ -->
    <div v-if="showChatModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/30 backdrop-blur-sm animate-fade-in">
        <div class="bg-white/95 w-full max-w-sm rounded-[32px] shadow-2xl flex flex-col h-[75vh] overflow-hidden border border-white/60">
            <!-- èŠå¤©å¤´ -->
            <div class="p-4 border-b border-slate-50 flex justify-between items-center bg-white/80 backdrop-blur-md z-10">
                <div class="flex items-center gap-3">
                    <button @click="showChatModal=false" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-50 transition-colors"><i class="ri-arrow-left-s-line text-2xl"></i></button>
                    <div class="flex items-center gap-2">
                        <img :src="chatTarget.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${chatTarget.username}`" class="w-9 h-9 rounded-full bg-white border shadow-sm">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-slate-800">{{ chatTarget.nickname }}</span>
                            <!-- ç§»é™¤è¯¯å¯¼æ€§çš„åœ¨çº¿çŠ¶æ€ -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- æ¶ˆæ¯åŒº -->
            <div class="flex-1 overflow-y-auto p-4 bg-[#f8fafc] custom-scrollbar" ref="chatContainer" style="background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px;">
                <div v-for="msg in chatMessages" :key="msg.id" class="chat-row" :class="[msg.sender === user.username ? 'mine' : 'other', msg.pending ? 'chat-pending' : '']">
                    <img :src="(msg.sender === user.username ? user.avatar : chatTarget.avatar) || `https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.sender}`" class="chat-avatar shadow-sm">
                    <div class="chat-bubble-container">
                        <div class="chat-bubble">
                            {{ msg.content }}
                            <div v-if="msg.pending" class="absolute -left-5 top-3 text-slate-300 text-xs"><i class="ri-loader-4-line animate-spin"></i></div>
                        </div>
                        <span v-if="msg.timeStr && !msg.pending" class="chat-time">{{ msg.timeStr }}</span>
                    </div>
                </div>
            </div>
            <!-- è¾“å…¥åŒº -->
            <div class="p-3 bg-white flex gap-2 items-center shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
                <input v-model="chatInput" @keyup.enter="sendChat" placeholder="âœ¨ å‘é€æ¶ˆæ¯..." class="flex-1 bg-slate-50 border border-slate-100 rounded-full px-5 py-2.5 text-sm outline-none focus:bg-white focus:border-pink-200 focus:ring-2 focus:ring-pink-50 transition-all">
                <button @click="sendChat" :disabled="!chatInput" class="w-10 h-10 rounded-full btn-primary flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:scale-105 active:scale-90 transition-all">
                    <i class="ri-send-plane-fill"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- è®¤è¯å¼¹çª—ï¼šå¯çˆ±é£ -->
    <div v-if="showAuthModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/20 backdrop-blur-sm animate-fade-in">
        <div class="glass-modal w-full max-w-xs rounded-[32px] p-8 shadow-2xl transform transition-all overflow-y-auto max-h-[90vh]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto bg-gradient-to-tr from-pink-200 to-blue-200 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg shadow-pink-100 mb-4 rotate-3">
                    <i :class="authMode==='login'?'ri-user-heart-fill':'ri-user-add-fill'"></i>
                </div>
                <h3 class="font-black text-xl text-slate-700">{{ authMode==='login'?'æ¬¢è¿å›æ¥':'åŠ å…¥æˆ‘ä»¬' }}</h3>
            </div>
            
            <div class="space-y-4">
                <div v-if="authMode==='register'" class="flex justify-center mb-2" @click="$refs.avatarInput.click()">
                    <div class="w-20 h-20 rounded-full bg-slate-50 border-2 border-dashed border-pink-200 flex items-center justify-center text-pink-300 overflow-hidden relative cursor-pointer hover:border-pink-400 transition-colors group">
                        <img v-if="authForm.avatar" :src="authForm.avatar" class="w-full h-full object-cover">
                        <div v-else class="flex flex-col items-center">
                            <i class="ri-camera-fill text-2xl group-hover:scale-110 transition-transform"></i>
                            <span class="text-[10px] font-bold mt-1">é€‰ä¸ªå¤´åƒ</span>
                        </div>
                    </div>
                    <input type="file" ref="avatarInput" hidden accept="image/*" @change="handleAvatarUpload">
                </div>
                <input v-model="authForm.username" :placeholder="authMode==='register' && authForm.username!=='admin' ? 'è´¦å· (è‡³å°‘8ä½)' : 'è´¦å·'" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-xs outline-none focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-all">
                <input v-model="authForm.password" type="password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-xs outline-none focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-all">
                
                <div v-if="authMode==='register'" class="space-y-4">
                    <input v-model="authForm.nickname" placeholder="ç»™è‡ªå·±èµ·ä¸ªå¥½å¬çš„æ˜µç§°" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-xs outline-none focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-all">
                    
                    <!-- æ–°å¢ï¼šæ³¨å†Œæ—¶å¡«å†™è¯¦ç»†ä¿¡æ¯ -->
                    <div>
                        <label class="text-xs font-black text-slate-400 block mb-2 ml-1">æ€§åˆ«</label>
                        <div class="flex gap-3">
                            <button @click="authForm.gender='male'" class="flex-1 py-2.5 rounded-xl text-xs font-bold border-2 transition-all flex items-center justify-center gap-1" :class="authForm.gender==='male'?'bg-blue-50 border-blue-200 text-blue-500 shadow-sm':'bg-white border-slate-100 text-slate-400'">
                                <i class="ri-men-line"></i> ç”·ç”Ÿ
                            </button>
                            <button @click="authForm.gender='female'" class="flex-1 py-2.5 rounded-xl text-xs font-bold border-2 transition-all flex items-center justify-center gap-1" :class="authForm.gender==='female'?'bg-pink-50 border-pink-200 text-pink-500 shadow-sm':'bg-white border-slate-100 text-slate-400'">
                                <i class="ri-women-line"></i> å¥³ç”Ÿ
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-400 block mb-2 ml-1">æ‰©åˆ—ç›®æ ‡</label>
                        <div class="flex gap-2">
                            <button @click="authForm.target='male'" class="flex-1 py-2 rounded-xl text-[10px] font-bold border transition-all" :class="authForm.target==='male'?'bg-blue-50 border-blue-200 text-blue-500':'bg-white border-slate-100 text-slate-400'">æ‰¾ç”·ç”Ÿ</button>
                            <button @click="authForm.target='female'" class="flex-1 py-2 rounded-xl text-[10px] font-bold border transition-all" :class="authForm.target==='female'?'bg-pink-50 border-pink-200 text-pink-500':'bg-white border-slate-100 text-slate-400'">æ‰¾å¥³ç”Ÿ</button>
                            <button @click="authForm.target='all'" class="flex-1 py-2 rounded-xl text-[10px] font-bold border transition-all" :class="authForm.target==='all'?'bg-purple-50 border-purple-200 text-purple-500':'bg-white border-slate-100 text-slate-400'">éƒ½å¯ä»¥</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <input v-model="authForm.qq" placeholder="QQ (é€‰å¡«)" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-xs outline-none focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-all">
                        <input v-model="authForm.wx" placeholder="å¾®ä¿¡ (é€‰å¡«)" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-xs outline-none focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-all">
                    </div>
                </div>
                
                <button @click="handleAuth" :disabled="isAuthing" class="w-full btn-primary py-3 rounded-xl text-sm font-bold shadow-lg shadow-pink-200/50 mt-2">
                    <i v-if="isAuthing" class="ri-loader-4-line animate-spin mr-1"></i>
                    {{ isAuthing ? 'å°‘å¥³ç¥ˆç¥·ä¸­...' : (authMode==='login'?'ç«‹å³ç™»å½•':'åˆ›å»ºè´¦å·') }}
                </button>
            </div>
            
            <div class="flex justify-center mt-6 text-xs">
                <button @click="authMode = authMode==='login'?'register':'login'" class="text-slate-400 hover:text-pink-500 transition-colors font-bold border-b border-dashed border-slate-300 hover:border-pink-400 pb-0.5">
                    {{ authMode==='login'?'æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ â†’':'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½• â†’' }}
                </button>
            </div>
            <div class="absolute top-4 right-4">
                <button @click="showAuthModal=false" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-red-50 hover:text-red-400 transition-colors flex items-center justify-center"><i class="ri-close-line"></i></button>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div v-if="showPostModal" class="fixed inset-0 z-50 bg-white flex flex-col animate-fade-in">
        <div class="flex justify-between items-center p-4 border-b border-slate-50 bg-white/80 backdrop-blur">
            <button @click="showPostModal=false" class="text-slate-400 font-bold text-sm px-2 hover:text-slate-600">å–æ¶ˆ</button>
            <h3 class="font-black text-lg text-slate-700 tracking-tight">å‘å¸ƒåŠ¨æ€</h3>
            <button @click="submitPost" :disabled="submitting" class="btn-primary px-5 py-1.5 rounded-full text-xs font-bold shadow-md shadow-pink-100">
                {{ submitting?'å‘å¸ƒä¸­...':'å‘å¸ƒ' }}
            </button>
        </div>
        <div class="p-5 flex-1 overflow-y-auto bg-slate-50/50">
            <div class="bg-white rounded-3xl p-4 shadow-sm border border-slate-100 mb-4">
                <textarea v-model="postForm.content" class="w-full h-32 text-sm outline-none placeholder-slate-300 resize-none bg-transparent leading-relaxed" placeholder="åˆ†äº«ä½ çš„æ‰©åˆ—å®£è¨€ï¼Œå¸¦ä¸Šä½ çš„æ•…äº‹..."></textarea>
                <div class="flex flex-wrap gap-3 mt-2">
                    <div v-for="(img,i) in postForm.images" :key="i" class="w-20 h-20 rounded-xl bg-slate-50 relative overflow-hidden group shadow-sm border border-slate-100">
                        <img :src="img" class="w-full h-full object-cover">
                        <button @click="removeImage(i)" class="absolute top-1 right-1 bg-black/50 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm">&times;</button>
                    </div>
                    <div v-if="postForm.images.length<3" @click="$refs.pInput.click()" class="w-20 h-20 rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-300 cursor-pointer hover:border-pink-300 hover:text-pink-300 transition-colors bg-slate-50">
                        <i class="ri-image-add-line text-xl mb-1"></i>
                        <span class="text-[10px] font-bold">æ·»åŠ å›¾ç‰‡</span>
                    </div>
                    <input type="file" ref="pInput" hidden accept="image/*" @change="handlePostImageUpload">
                </div>
            </div>
            
            <div class="space-y-5">
                <div class="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
                    <label class="text-xs font-black text-slate-400 block mb-3 flex items-center gap-1"><i class="ri-gamepad-line"></i> é€‰æ‹©åˆ†åŒº</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="g in games.slice(1)" :key="g" @click="postForm.game=g" class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-all" :class="postForm.game===g?'bg-slate-800 text-white border-slate-800 shadow-md':'bg-white text-slate-500 border-slate-200 hover:border-slate-300'">{{ g }}</button>
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
                    <label class="text-xs font-black text-slate-400 block mb-3 flex items-center gap-1"><i class="ri-star-smile-line"></i> æ‰©åˆ—è¦æ±‚</label>
                    <input v-model="postForm.requirement" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-2.5 text-xs outline-none focus:bg-white focus:border-pink-200 focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ä¾‹å¦‚ï¼šå£°éŸ³å¥½å¬ã€ä¸å‹åŠ›æ€ªã€å¯è¿éº¦...">
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆ -->
    <div v-if="preview.show" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-center justify-center p-2" @click="preview.show=false">
        <img :src="preview.list[preview.idx]" class="max-w-full max-h-screen object-contain rounded-lg shadow-2xl animate-fade-in">
    </div>

    <!-- ä¸ªäººèµ„æ–™å¼¹çª— -->
    <div v-if="showProfileModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/30 backdrop-blur-sm animate-fade-in">
        <div class="glass-modal w-full max-w-xs rounded-[32px] shadow-2xl p-6 overflow-y-auto max-h-[85vh] relative overflow-hidden">
            <!-- è£…é¥°èƒŒæ™¯ -->
            <div class="absolute top-0 left-0 right-0 h-24 bg-gradient-to-br from-pink-100 to-blue-100 opacity-50 -z-10"></div>
            
            <div class="flex justify-between items-center mb-6 relative">
                <h3 class="font-black text-lg text-slate-800">{{ isMyProfile ? 'æˆ‘çš„æ¡£æ¡ˆ' : 'è®­ç»ƒå¸ˆå¡ç‰‡' }}</h3>
                <button @click="showProfileModal=false" class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center text-slate-400 hover:bg-white hover:text-slate-600 transition-colors"><i class="ri-close-line text-xl"></i></button>
            </div>
            
            <div class="space-y-5 text-center">
                <div class="flex justify-center">
                    <div class="relative w-28 h-28 group" :class="{'cursor-pointer': isMyProfile}" @click="isMyProfile && $refs.profileAvatarInput.click()">
                        <img :src="viewingUser.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${viewingUser.username}`" class="w-full h-full rounded-full object-cover border-4 border-white shadow-xl bg-white">
                        <div v-if="isMyProfile" class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-[2px]"><i class="ri-camera-fill text-2xl"></i></div>
                        <input v-if="isMyProfile" type="file" ref="profileAvatarInput" hidden accept="image/*" @change="handleProfileAvatarChange">
                    </div>
                </div>
                
                <div>
                    <h2 class="font-black text-2xl text-slate-800 tracking-tight">{{ viewingUser.nickname }}</h2>
                    <p class="text-xs text-slate-400 font-mono mt-1 bg-slate-100 inline-block px-2 py-0.5 rounded-md">UID: {{ viewingUser.username }}</p>
                </div>
                
                <div v-if="!isMyProfile" class="space-y-3 text-left bg-white/60 p-5 rounded-3xl border border-white/60 shadow-sm">
                    <div class="flex justify-between text-sm"><span class="text-slate-400 font-bold text-xs">æ€§åˆ«</span> <span class="font-bold text-slate-700">{{ genderMap[viewingUser.gender] || 'ä¿å¯†' }}</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-400 font-bold text-xs">æ‰©åˆ—ç›®æ ‡</span> <span class="font-bold text-slate-700">{{ targetMap[viewingUser.target] || 'ä¸é™' }}</span></div>
                    <div class="h-px bg-slate-100 my-2"></div>
                    <div v-if="viewingUser.qq" class="flex justify-between text-sm items-center">
                        <span class="text-slate-400 font-bold text-xs flex items-center gap-1"><i class="ri-qq-fill text-blue-400"></i> QQ</span> 
                        <button @click="copyText(viewingUser.qq, 'QQ')" class="text-blue-500 font-bold text-xs bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition-colors">å¤åˆ¶</button>
                    </div>
                    <div v-if="viewingUser.wx" class="flex justify-between text-sm items-center">
                        <span class="text-slate-400 font-bold text-xs flex items-center gap-1"><i class="ri-wechat-fill text-emerald-400"></i> å¾®ä¿¡</span> 
                        <button @click="copyText(viewingUser.wx, 'å¾®ä¿¡')" class="text-emerald-500 font-bold text-xs bg-emerald-50 px-3 py-1 rounded-full hover:bg-emerald-100 transition-colors">å¤åˆ¶</button>
                    </div>
                    <button @click="openChat(viewingUser)" class="w-full bg-slate-800 text-white py-3 rounded-2xl font-bold mt-4 shadow-lg shadow-slate-200 active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-slate-900">
                        <i class="ri-message-3-fill"></i> å‘èµ·ç§èŠ
                    </button>
                </div>
                
                <div v-else class="space-y-5 text-left">
                    <div>
                        <label class="text-xs font-black text-slate-400 block mb-2 ml-1">æˆ‘çš„æ€§åˆ«</label>
                        <div class="flex gap-3">
                            <button @click="profileForm.gender='male'" class="flex-1 py-2.5 rounded-xl text-xs font-bold border-2 transition-all flex items-center justify-center gap-1" :class="profileForm.gender==='male'?'bg-blue-50 border-blue-200 text-blue-500 shadow-sm':'bg-white border-slate-100 text-slate-400'">
                                <i class="ri-men-line"></i> ç”·ç”Ÿ
                            </button>
                            <button @click="profileForm.gender='female'" class="flex-1 py-2.5 rounded-xl text-xs font-bold border-2 transition-all flex items-center justify-center gap-1" :class="profileForm.gender==='female'?'bg-pink-50 border-pink-200 text-pink-500 shadow-sm':'bg-white border-slate-100 text-slate-400'">
                                <i class="ri-women-line"></i> å¥³ç”Ÿ
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-400 block mb-2 ml-1">æƒ³æ‰¾</label>
                        <div class="flex gap-2">
                            <button @click="profileForm.target='male'" class="flex-1 py-2 rounded-xl text-[10px] font-bold border transition-all" :class="profileForm.target==='male'?'bg-blue-50 border-blue-200 text-blue-500':'bg-white border-slate-100 text-slate-400'">æ‰¾ç”·ç”Ÿ</button>
                            <button @click="profileForm.target='female'" class="flex-1 py-2 rounded-xl text-[10px] font-bold border transition-all" :class="profileForm.target==='female'?'bg-pink-50 border-pink-200 text-pink-500':'bg-white border-slate-100 text-slate-400'">æ‰¾å¥³ç”Ÿ</button>
                            <button @click="profileForm.target='all'" class="flex-1 py-2 rounded-xl text-[10px] font-bold border transition-all" :class="profileForm.target==='all'?'bg-purple-50 border-purple-200 text-purple-500':'bg-white border-slate-100 text-slate-400'">éƒ½å¯ä»¥</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 bg-white px-4 py-3 rounded-2xl border border-slate-100 focus-within:border-blue-200 focus-within:ring-2 focus-within:ring-blue-50 transition-all">
                            <i class="ri-qq-fill text-blue-400 text-lg"></i>
                            <input v-model="profileForm.qq" placeholder="QQå· (é€‰å¡«)" class="bg-transparent text-xs w-full outline-none font-medium">
                        </div>
                        <div class="flex items-center gap-3 bg-white px-4 py-3 rounded-2xl border border-slate-100 focus-within:border-green-200 focus-within:ring-2 focus-within:ring-green-50 transition-all">
                            <i class="ri-wechat-fill text-emerald-400 text-lg"></i>
                            <input v-model="profileForm.wx" placeholder="å¾®ä¿¡å· (é€‰å¡«)" class="bg-transparent text-xs w-full outline-none font-medium">
                        </div>
                    </div>
                    <button @click="handleProfileUpdate" :disabled="isUpdatingProfile" class="w-full btn-primary font-bold py-3.5 rounded-2xl shadow-lg shadow-pink-200 active:scale-95 transition-all disabled:opacity-50 mt-4">
                        {{ isUpdatingProfile ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜èµ„æ–™' }}
                    </button>
                    <button @click="logout" class="w-full text-xs text-slate-400 hover:text-red-400 py-2 font-bold transition-colors">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, watch, nextTick, computed } = Vue;

    const app = createApp({
        setup() {
            const API = '/api/cp';
            const user = ref(null);
            const posts = ref([]);
            const loading = ref(true);
            const error = ref('');
            const scrollY = ref(0);
            const notice = ref("æ¬¢è¿æ¥åˆ° CPDD æ‰©åˆ—å¼‚ä¸–ç•Œï¼è¿™é‡Œç¦æ­¢å‘å¸ƒè¿è§„ä¿¡æ¯ï¼Œè¦åšä¸ªå¯çˆ±çš„è®­ç»ƒå¸ˆå“¦~");

            const showAuthModal = ref(false);
            const authMode = ref('login');
            const showPostModal = ref(false);
            const showProfileModal = ref(false);
            const showInboxModal = ref(false);
            const showChatModal = ref(false);
            const chatContainer = ref(null);
            const showSlowTip = ref(false);
            
            const submitting = ref(false);
            const isAuthing = ref(false);
            const isUpdatingProfile = ref(false);
            const preview = ref({show:false, list:[], idx:0});
            const viewingUser = ref({});
            const isMyProfile = ref(false);
            const inboxList = ref([]);
            const pendingMessages = ref([]);
            const serverMessages = ref([]);
            const chatTarget = ref({});
            const chatInput = ref('');
            const totalUnread = ref(0);
            let chatPoller = null;
            let inboxPoller = null;

            const games = ['å…¨éƒ¨', 'ç‹è€…è£è€€', 'åŸç¥', 'å…‰é‡', 'è‹±é›„è”ç›Ÿ', 'å’Œå¹³ç²¾è‹±', 'è›‹ä»”æ´¾å¯¹', 'æ— ç•å¥‘çº¦', 'å´©å:æ˜Ÿç©¹é“é“', 'å…¶ä»–'];
            const filterGame = ref('å…¨éƒ¨');
            // â˜… ä¿®å¤ï¼šæ³¨å†Œè¡¨å•å¢åŠ æ€§åˆ«ã€ç›®æ ‡ã€qqã€wx çš„åˆå§‹å€¼
            const authForm = ref({username:'', password:'', nickname:'', avatar:'', gender: 'male', target: 'all', qq: '', wx: ''});
            const postForm = ref({content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]});
            const profileForm = ref({ nickname:'', avatar:'', gender:'', target:'all', qq:'', wx:'' });
            const columns = ref([[], [], []]);
            const windowWidth = ref(window.innerWidth);
            const genderMap = { male:'ç”·ç”Ÿ', female:'å¥³ç”Ÿ', secret:'ä¿å¯†' };
            const targetMap = { male:'æ‰¾ç”·ç”Ÿ', female:'æ‰¾å¥³ç”Ÿ', all:'ä¸é™' };

            // è¾…åŠ©å‡½æ•°ï¼šæ»šåŠ¨åˆ°åº•éƒ¨
            const scrollToBottom = (force = false) => {
                setTimeout(() => {
                    const el = chatContainer.value;
                    if (el) {
                        el.scrollTo({
                            top: el.scrollHeight,
                            behavior: force ? 'auto' : 'smooth'
                        });
                    }
                }, 50);
            };

            const checkUnread = async () => {
                if (!user.value) return;
                try {
                    const res = await fetch(`${API}?action=chat_inbox&username=${user.value.username}`);
                    const list = await res.json();
                    if(Array.isArray(list)) {
                        const count = list.reduce((sum, chat) => sum + (chat.unread || 0), 0);
                        totalUnread.value = count;
                        inboxList.value = list;
                    }
                } catch(e) {}
            };

            onMounted(() => {
                const staticLoading = document.getElementById('static-loading');
                if(staticLoading) { staticLoading.style.opacity = 0; setTimeout(()=>staticLoading.remove(), 500); }
                try { const u = localStorage.getItem('cp_user'); if(u) user.value = JSON.parse(u); } catch(e){}
                fetchPosts();
                if(user.value) { checkUnread(); inboxPoller = setInterval(checkUnread, 10000); }
            });

            watch(user, (u) => {
                if (u && !inboxPoller) inboxPoller = setInterval(checkUnread, 10000);
                else if (!u && inboxPoller) { clearInterval(inboxPoller); inboxPoller = null; }
            });

            const openInbox = async () => {
                if (!user.value) return showAuthModal.value = true;
                showInboxModal.value = true;
                checkUnread();
            };

            const openChat = async (target, chatId) => {
                showProfileModal.value = false;
                showInboxModal.value = false;
                chatTarget.value = target;
                serverMessages.value = [];
                pendingMessages.value = [];
                showChatModal.value = true;
                scrollToBottom(true);

                if(chatId) {
                    const chat = inboxList.value.find(c => c.chatId === chatId);
                    if(chat && chat.unread > 0) { 
                        totalUnread.value = Math.max(0, totalUnread.value - chat.unread); 
                        chat.unread = 0; 
                    }
                    await fetch(`${API}?action=chat_read`, {method:'POST', body:JSON.stringify({user:user.value, chatId})});
                }

                fetchChatHistory();
                if (chatPoller) clearInterval(chatPoller);
                chatPoller = setInterval(fetchChatHistory, 3000);
            };

            const currentChatId = computed(() => {
                if (!user.value || !chatTarget.value.username) return null;
                return [user.value.username, chatTarget.value.username].sort().join('_');
            });

            const fetchChatHistory = async () => {
                if (!showChatModal.value) return;
                const reqChatId = currentChatId.value; 
                const res = await fetch(`${API}?action=chat_history&u1=${user.value.username}&u2=${chatTarget.value.username}`);
                if (reqChatId !== currentChatId.value) return;

                const msgs = await res.json();
                const isNewMessage = msgs.length > serverMessages.value.length || 
                                     (msgs.length > 0 && serverMessages.value.length > 0 && msgs[msgs.length-1].id !== serverMessages.value[serverMessages.value.length-1].id);
                
                serverMessages.value = msgs;
                pendingMessages.value = pendingMessages.value.filter(p => 
                    !msgs.some(s => s.content === p.content && s.sender === p.sender && Math.abs(p.timestamp - (s.timestamp?s.timestamp._seconds*1000:0)) < 10000)
                );

                if (isNewMessage) scrollToBottom();
            };

            const mergedMessages = computed(() => {
                const list = [...serverMessages.value, ...pendingMessages.value].sort((a,b) => {
                    const ta = a.timestamp?._seconds ? a.timestamp._seconds * 1000 : a.timestamp;
                    const tb = b.timestamp?._seconds ? b.timestamp._seconds * 1000 : b.timestamp;
                    return ta - tb;
                });
                return list;
            });

            const sendChat = async () => {
                if (!chatInput.value.trim()) return;
                const txt = chatInput.value;
                chatInput.value = '';
                const now = Date.now();
                const tempMsg = { id: now, sender: user.value.username, content: txt, timestamp: now, pending: true };
                pendingMessages.value.push(tempMsg);
                scrollToBottom();

                try {
                    await fetch(`${API}?action=chat_send`, {
                        method: 'POST', 
                        body: JSON.stringify({ user: user.value, toUsername: chatTarget.value.username, content: txt })
                    });
                    fetchChatHistory();
                } catch(e) {
                    alert('å‘é€å¤±è´¥');
                    pendingMessages.value = pendingMessages.value.filter(m => m.id !== now);
                }
            };

            watch(showChatModal, (val) => { if (!val && chatPoller) clearInterval(chatPoller); });

            const deleteChatSession = async (chatId) => {
                if(!confirm('è¦åˆ é™¤è¿™ä¸ªä¼šè¯å—?')) return;
                await fetch(`${API}?action=delete_chat_session`, {method:'POST', body:JSON.stringify({user:user.value, chatId})});
                inboxList.value = inboxList.value.filter(c => c.chatId !== chatId);
            };

            const handleAvatarClick = async (username) => {
                if (!user.value) return showAuthModal.value = true;
                if (username === user.value.username) { viewingUser.value = user.value; profileForm.value = { ...user.value, gender:user.value.gender||'', target:user.value.target||'all' }; isMyProfile.value = true; } 
                else { try { const res = await fetch(`${API}?action=get_user_profile&username=${username}`); if (res.ok) { viewingUser.value = await res.json(); isMyProfile.value = false; } } catch(e) { alert('è·å–èµ„æ–™å¤±è´¥'); return; } }
                showProfileModal.value = true;
            };
            let longPressTimer = null;
            const startLongPress = (post, cmt) => { longPressTimer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); triggerReply(post, cmt); }, 600); };
            const endLongPress = () => { clearTimeout(longPressTimer); };
            const triggerReply = (post, cmt) => { if(!user.value) return showAuthModal.value = true; post.newCommentInput = `å›å¤ @${cmt.nickname} : `; nextTick(() => { const el = app._instance.refs['input-'+post.id]; if(el) (Array.isArray(el)?el[0]:el).focus(); }); };
            const updateColumns = () => { if(!Array.isArray(posts.value)) { posts.value = []; return; } const cols = windowWidth.value < 640 ? 1 : (windowWidth.value < 1024 ? 2 : 3); const res = Array.from({length: cols}, () => []); const filtered = filterGame.value==='å…¨éƒ¨' ? posts.value : posts.value.filter(p => p.game === filterGame.value); filtered.forEach((p, i) => res[i % cols].push(p)); columns.value = res; };
            watch([filterGame, posts], updateColumns);
            window.onresize = () => { windowWidth.value = window.innerWidth; updateColumns(); };
            window.onscroll = () => scrollY.value = window.scrollY;
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¼˜åŒ–ï¼šç¼“å­˜+é™é»˜æ›´æ–°æœºåˆ¶ â˜…â˜…â˜…
            const fetchPosts = async () => { 
                const cached = localStorage.getItem('cp_posts_cache');
                if(cached && posts.value.length === 0) {
                    try {
                        posts.value = JSON.parse(cached);
                        loading.value = false; 
                        updateColumns();
                    } catch(e){}
                }

                if(posts.value.length === 0) {
                    loading.value = true;
                    setTimeout(() => showSlowTip.value = true, 3000);
                }
                
                error.value = ''; 
                
                try { 
                    const res = await fetch(`${API}?t=${Date.now()}`); 
                    if(!res.ok) throw new Error('è¿æ¥è¶…æ—¶å•¦'); 
                    const data = await res.json(); 
                    if(Array.isArray(data)) {
                        posts.value = data; 
                        localStorage.setItem('cp_posts_cache', JSON.stringify(data)); 
                    } else throw new Error('æ•°æ®æ ¼å¼é”™è¯¯'); 
                } catch(e) { 
                    if(posts.value.length === 0) error.value = e.message; 
                    else console.log("é™é»˜æ›´æ–°å¤±è´¥", e);
                } finally {
                    loading.value = false; 
                }
            };

            const isLiked = (p) => { if(!p.likedIds) return false; if(user.value) return p.likedIds.includes('user:'+user.value.username); const locals = JSON.parse(localStorage.getItem('cp_likes')||'[]'); return locals.includes(p.id); };
            const handleLike = async (p) => { if(p.liking) return; p.liking = true; const liked = isLiked(p); if(liked) { p.likes--; if(user.value) p.likedIds = p.likedIds.filter(id => id !== 'user:'+user.value.username); else { const ls = JSON.parse(localStorage.getItem('cp_likes')||'[]'); localStorage.setItem('cp_likes', JSON.stringify(ls.filter(id=>id!==p.id))); p.likedIds = []; } } else { p.likes++; if(user.value) { if(!p.likedIds) p.likedIds=[]; p.likedIds.push('user:'+user.value.username); } else { const ls = JSON.parse(localStorage.getItem('cp_likes')||'[]'); ls.push(p.id); localStorage.setItem('cp_likes', JSON.stringify(ls)); if(!p.likedIds) p.likedIds=[]; p.likedIds.push('temp'); } } try { await fetch(`${API}?action=like`, {method:'POST', body:JSON.stringify({id:p.id, user:user.value})}); } catch(e){ p.likes = liked ? p.likes+1 : p.likes-1; } p.liking = false; };
            
            const compress = (file) => new Promise(resolve => { 
                const r = new FileReader(); 
                r.onload = e => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const cvs = document.createElement('canvas'); 
                        let w=img.width, h=img.height; 
                        const MAX = 1280; 
                        if(w>MAX){ h*=MAX/w; w=MAX; } 
                        cvs.width=w; cvs.height=h; 
                        const ctx = cvs.getContext('2d'); 
                        ctx.drawImage(img,0,0,w,h); 
                        
                        let q = 0.8; 
                        let dataUrl = cvs.toDataURL('image/jpeg', q); 
                        const LIMIT = 200000; 
                        
                        while(dataUrl.length > LIMIT && q > 0.2) { q-=0.1; dataUrl = cvs.toDataURL('image/jpeg', q); } 
                        while(dataUrl.length > LIMIT) { w*=0.7; h*=0.7; cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); dataUrl = cvs.toDataURL('image/jpeg', 0.6); if(w < 200) break; } 
                        resolve(dataUrl); 
                    }; 
                    img.src = e.target.result; 
                }; 
                r.readAsDataURL(file); 
            });

            const handleAvatarUpload = async (e) => { if(e.target.files[0]) authForm.value.avatar = await compress(e.target.files[0]); };
            const handleProfileAvatarChange = async (e) => { if(e.target.files[0]) profileForm.value.avatar = await compress(e.target.files[0]); };
            const handlePostImageUpload = async (e) => { if(e.target.files[0] && postForm.value.images.length<3) postForm.value.images.push(await compress(e.target.files[0])); e.target.value=''; };
            const handleAuth = async () => { if(!authForm.value.username) return alert('è¯·è¾“å…¥è´¦å·'); if (authMode.value === 'register' && authForm.value.username !== 'admin') { if(authForm.value.username.length < 8) return alert('è´¦å·è‡³å°‘8ä½'); } isAuthing.value = true; try { const res = await fetch(`${API}?action=${authMode.value}`, {method:'POST', body:JSON.stringify(authForm.value)}); const d = await res.json(); if(d.error) alert(d.error); else { user.value = d.user; localStorage.setItem('cp_user', JSON.stringify(d.user)); showAuthModal.value = false; } } catch(e){ alert('ç½‘ç»œè¿æ¥é”™è¯¯'); } isAuthing.value = false; };
            const handleProfileUpdate = async () => { isUpdatingProfile.value = true; try { const payload = { username: user.value.username, user: user.value, ...profileForm.value }; const res = await fetch(`${API}?action=update_profile`, { method:'POST', body:JSON.stringify(payload) }); const d = await res.json(); if(d.success) { user.value = d.user; localStorage.setItem('cp_user', JSON.stringify(d.user)); alert('ä¿å­˜æˆåŠŸ'); showProfileModal.value = false; } else { alert(d.error || 'ä¿å­˜å¤±è´¥'); } } catch(e) { alert('ç½‘ç»œé”™è¯¯'); } isUpdatingProfile.value = false; };
            
            const submitPost = async () => { 
                if(!postForm.value.content) return alert('å†™ç‚¹ä»€ä¹ˆå§'); 
                const totalSize = postForm.value.images.reduce((acc, img) => acc + img.length, 0); 
                if (totalSize > 800000) return alert('å›¾ç‰‡æ€»å¤§å°è¶…é™ï¼Œè¯·åˆ é™¤ä¸€å¼ æˆ–æ¢å°å›¾é‡è¯•'); 
                submitting.value = true; 
                
                // â˜… æ ¸å¿ƒä¿®å¤ï¼šæ„å»ºå®‰å…¨çš„ payloadï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰é»˜è®¤å€¼ï¼Œé˜²æ­¢ undefined
                const safeUser = {
                    ...user.value,
                    gender: user.value.gender || 'secret',
                    target: user.value.target || 'all',
                    qq: user.value.qq || '',
                    wx: user.value.wx || ''
                };

                try { 
                    // ä½¿ç”¨ safeUser æ›¿ä»£ user.value
                    const res = await fetch(`${API}?action=create_post`, {
                        method:'POST', 
                        body:JSON.stringify({
                            user: safeUser, 
                            ...postForm.value
                        })
                    }); 
                    const data = await res.json().catch(() => null); 
                    if(res.ok && data && data.success) { showPostModal.value = false; postForm.value = {content:'', game:'ç‹è€…è£è€€', requirement:'', images:[]}; fetchPosts(); } 
                    else { const msg = data ? (data.error || 'æœªçŸ¥é”™è¯¯') : `æœåŠ¡å™¨å“åº”å¼‚å¸¸`; alert(`å‘å¸ƒå¤±è´¥: ${msg}`); } 
                } catch(e){ alert('ç½‘ç»œé”™è¯¯'); } 
                submitting.value = false; 
            };

            const deletePost = async (id) => { if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ')) { await fetch(`${API}?action=delete_post`, {method:'POST', body:JSON.stringify({id, user:user.value})}); fetchPosts(); } };
            const toggleComments = async (p) => { p.showComments = !p.showComments; if(p.showComments && !p.loaded) { p.loadingComments = true; try { p.commentList = await (await fetch(`${API}?action=get_comments&postId=${p.id}`)).json(); p.loaded=true; } catch(e){} p.loadingComments = false; } };
            const submitComment = async (p) => { if(!user.value) return showAuthModal.value = true; if(!p.newCommentInput) return; const txt = p.newCommentInput; p.newCommentInput=''; if(!p.commentList) p.commentList=[]; const tempCmt = {id:Date.now(), nickname:user.value.nickname, username:user.value.username, avatar:user.value.avatar, content:txt}; p.commentList.push(tempCmt); p.commentsCount = (p.commentsCount||0)+1; await fetch(`${API}?action=add_comment`, {method:'POST', body:JSON.stringify({postId:p.id, user:user.value, content:txt})}); };
            const deleteComment = async (p, cid) => { if(confirm('åˆ é™¤è¿™æ¡è¯„è®ºï¼Ÿ')) { await fetch(`${API}?action=delete_comment`, {method:'POST', body:JSON.stringify({postId:p.id, commentId:cid, user:user.value})}); p.commentList = p.commentList.filter(c=>c.id!==cid); p.commentsCount--; } };
            const copyText = (text, label) => { if(navigator.clipboard) navigator.clipboard.writeText(text).then(() => alert(`å·²å¤åˆ¶ ${label}: ${text}`)); else { const input = document.createElement('input'); input.value = text; document.body.appendChild(input); input.select(); document.execCommand('copy'); document.body.removeChild(input); alert(`å·²å¤åˆ¶ ${label}: ${text}`); } };
            const changeFilter = g => filterGame.value = g;
            const logout = () => { user.value=null; localStorage.removeItem('cp_user'); showProfileModal.value=false; };
            const checkAuthAndPost = () => user.value ? showPostModal.value = true : showAuthModal.value = true;
            const removeImage = i => postForm.value.images.splice(i,1);
            const previewImage = (l,i) => preview.value = {show:true, list:l, idx:i};
            const scrollToTop = () => window.scrollTo({top:0, behavior:'smooth'});

            return {
                user, loading, error, posts, columns, games, filterGame, notice, scrollY, showSlowTip,
                showAuthModal, authMode, authForm, isAuthing, showPostModal, postForm, submitting, preview,
                showProfileModal, profileForm, isUpdatingProfile, viewingUser, isMyProfile, genderMap, targetMap,
                showInboxModal, inboxList, showChatModal, chatMessages: mergedMessages, chatTarget, chatInput, totalUnread,
                chatContainer,
                
                refresh:fetchPosts, handleAuth, handleAvatarUpload, handlePostImageUpload, submitPost,
                deletePost, isLiked, handleLike, toggleComments, submitComment, deleteComment,
                changeFilter, logout, checkAuthAndPost, removeImage, previewImage, scrollToTop,
                startLongPress, endLongPress, triggerReply,
                handleProfileAvatarChange, handleProfileUpdate, copyText, handleAvatarClick,
                openInbox, openChat, sendChat, deleteChatSession
            };
        }
    }).mount('#app');
</script>
</body>
</html>
